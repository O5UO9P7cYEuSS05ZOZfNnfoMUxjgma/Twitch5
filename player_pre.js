"use strict";const ВЕРСИЯ_РАСШИРЕНИЯ="2018.7.9",ВЕРСИЯ_ДВИЖКА_БРАУЗЕРА=Number.parseInt(/Chrome\/(\d+)/.exec(navigator.userAgent)[1],10),МИН_РАЗМЕР_БУФЕРА=1.5,МАКС_РАЗМЕР_БУФЕРА=30,МИН_РАСТЯГИВАНИЕ_БУФЕРА=9,МАКС_РАСТЯГИВАНИЕ_БУФЕРА=30,ПЕРЕПОЛНЕНИЕ_БУФЕРА=60,МИН_ДЛИТЕЛЬНОСТЬ_ПОВТОРА=30,МАКС_ДЛИТЕЛЬНОСТЬ_ПОВТОРА=300,МИН_ИНТЕРВАЛ_ОБНОВЛЕНИЯ_СПИСКОВ=40,ЗАГРУЖАТЬ_МЕТАДАННЫЕ_НЕ_ДОЛЬШЕ=15e3,ЗАГРУЖАТЬ_СПИСОК_ВАРИАНТОВ_НЕ_ДОЛЬШЕ=15e3,ЗАГРУЖАТЬ_СПИСОК_СЕГМЕНТОВ_НЕ_ДОЛЬШЕ=6e3,МИНИМАЛЬНАЯ_ГРОМКОСТЬ=1,МАКСИМАЛЬНАЯ_ГРОМКОСТЬ=100,ШАГ_ПОВЫШЕНИЯ_ГРОМКОСТИ_КЛАВОЙ=4,ШАГ_ПОНИЖЕНИЯ_ГРОМКОСТИ_КЛАВОЙ=2,ШАГ_ИЗМЕНЕНИЯ_ГРОМКОСТИ_МЫШЬЮ=1,ШАГ_ПОВЫШЕНИЯ_ГРОМКОСТИ_КОЛЕСОМ=5,ШАГ_ПОНИЖЕНИЯ_ГРОМКОСТИ_КОЛЕСОМ=3,ОБРАБОТКА_ЖДЕТ_ЗАГРУЗКИ=1,ОБРАБОТКА_ЗАГРУЖАЕТСЯ=2,ОБРАБОТКА_ЗАГРУЖЕН=3,ОБРАБОТКА_ПРЕОБРАЗОВАН=4,СОСТОЯНИЕ_ЗАПУСК=1,СОСТОЯНИЕ_НАЧАЛО_ТРАНСЛЯЦИИ=2,СОСТОЯНИЕ_ЗАВЕРШЕНИЕ_ТРАНСЛЯЦИИ=3,СОСТОЯНИЕ_ЗАГРУЗКА=4,СОСТОЯНИЕ_НАЧАЛО_ВОСПРОИЗВЕДЕНИЯ=5,СОСТОЯНИЕ_ВОСПРОИЗВЕДЕНИЕ=6,СОСТОЯНИЕ_ОСТАНОВКА=7,СОСТОЯНИЕ_ПОВТОР=8,СОСТОЯНИЕ_СМЕНА_ВАРИАНТА=9,ПОДПИСКА_ОБНОВЛЯЕТСЯ=-1,ПОДПИСКА_НЕДОСТУПНА=0,ПОДПИСКА_НЕОФОРМЛЕНА=1,ПОДПИСКА_НЕУВЕДОМЛЯТЬ=2,ПОДПИСКА_УВЕДОМЛЯТЬ=3,КОД_ОТВЕТА="Сервер вернул код ",МИН_ЗНАЧЕНИЕ_НАСТРОЙКИ=Number.MIN_SAFE_INTEGER+1e3,МАКС_ЗНАЧЕНИЕ_НАСТРОЙКИ=Number.MAX_SAFE_INTEGER-1e3,АВТОНАСТРОЙКА=Number.MIN_SAFE_INTEGER,ЛЕВАЯ_КНОПКА=0,СРЕДНЯЯ_КНОПКА=1,ПРАВАЯ_КНОПКА=2,ЧАТ_ВЫГРУЖЕН=0,ЧАТ_СКРЫТ=1,ЧАТ_ПАНЕЛЬ=2,ВЕРХНЯЯ_СТОРОНА=1,ПРАВАЯ_СТОРОНА=2,НИЖНЯЯ_СТОРОНА=3,ЛЕВАЯ_СТОРОНА=4;let г_чИдВкладки=NaN;function Текст(e,t){return м_i18n.GetMessage(e,t)}function Округлить(e,t){if(Проверить("number"==typeof e&&Number.isInteger(t)&&t>=0&&t<=20),0===t)return Math.round(e);const n=Math.pow(10,t);return Math.round(e*n)/n}function Ограничить(e,t,n){return Проверить(Number.isFinite(e)&&Number.isFinite(t)&&Number.isFinite(n)&&t<=n),Math.min(Math.max(e,t),n)}function StripHtmlTags(e){Проверить("string"==typeof e);const t=document.createElement("template");return t.innerHTML=e,t.content.textContent}function ПреобразоватьРазметкуВТекст(e){return Проверить("string"==typeof e),(e=(e=StripHtmlTags(e=e.replace(/[\t\r\n]/g," ").replace(/<\s*br[\s\/]*>/gi,"\n"))).replace(/^\s+|[^\S\r\n]+$/gm,"")).replace(/[^\S\r\n]{2,}/g," ")}function ResolveRelativeUrl(e,t){return new URL(e,t).href}function РазобратьПараметры(e){return e.searchParams||new URLSearchParams(e.search.slice(1))}function ИзменитьЗаголовокДокумента(e){history.replaceState(null,""),document.title=e}function ЗаписатьТекстВЛокальныйФайл(e,t,n){Проверить("string"==typeof e&&ЭтоНепустаяСтрока(t)&&ЭтоНепустаяСтрока(n));const r=document.createElement("a");r.href=URL.createObjectURL(new Blob([e],{type:t})),r.download=n,r.dispatchEvent(new MouseEvent("click"))}function ЭтоСобытиеДляСсылки(e){let t=e.target;do{if("A"===t.nodeName)return!0}while(t=t.parentElement);return!1}function ЭлементВЭтойТочкеМожноПрокрутить(e,t){for(let n=document.elementFromPoint(e,t);n;n=n.parentElement)if(ЭтотЭлементМожноПрокрутить(n))return!0;return!1}function ЭтотЭлементМожноПрокрутить(e){const t=getComputedStyle(e);return("scroll"===t.overflowY||"auto"===t.overflowY)&&e.clientHeight<e.scrollHeight}function ЭлементПолностьюПрокручен(e){return e.scrollHeight-e.scrollTop-e.clientHeight<2}function ЭтотЭлементМожноВыделить(e){do{const t=getComputedStyle(e),n=t.getPropertyValue("user-select")||t.getPropertyValue("-webkit-user-select")||t.getPropertyValue("-moz-user-select");if(Проверить(n),"auto"!==n)return"none"!==n}while(e=e.parentElement);return!0}function ПоказатьЭлемент(e,t){const n=Узел(e);return t?n.removeAttribute("hidden"):n.setAttribute("hidden",""),n}function ЭлементПоказан(e){return!Узел(e).hasAttribute("hidden")}function ИзменитьКнопку(e,t){const n=Узел(e),r=Number(t),i=n.getElementsByTagName("use");Проверить(r>=0&&r<i.length);for(let e=0;e<i.length;++e)if(e===r){const t=i[e].getAttributeNS("http://www.w3.org/1999/xlink","title");t&&(n.title=Текст(t)),i[e].removeAttribute("display")}else i[e].setAttribute("display","none");return n}const м_Отладка=(()=>{let e="",t=[];function n(){try{м_ПолноэкранныйРежим.Отключить()}catch(e){}document.body.textContent="";for(let e of document.querySelectorAll('link[rel="stylesheet"], style'))e.remove();for(let e of[document.documentElement,document.body])e.removeAttribute("class"),e.removeAttribute("style"),e.removeAttribute("hidden");return new Promise((e,t)=>{const n=document.createElement("iframe");n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.zIndex="100500",n.style.border="0",n.src="report.html",n.addEventListener("load",function t(){n.removeEventListener("load",t),м_i18n.TranslateDocument(n.contentDocument),e(n.contentDocument)}),document.body.appendChild(n)})}function r(e,t,n){n&&e.documentElement.classList.add(t);for(let n,r=e.forms,i=0;n=r[i];++i)if(n.id===t){ПоказатьЭлемент(n,!0);const e=n.querySelector("*[autofocus]");e&&e.focus()}else ПоказатьЭлемент(n,!1)}function i(i,o){!function(e){try{chrome.system.cpu.getInfo(t=>{try{chrome.system.memory.getInfo(n=>{e([t,n])})}catch(t){e()}})}catch(t){e()}}(s=>{!function(e,t){n().then(n=>{let i;(i="ОТПРАВИТЬ ОТЗЫВ"===e.ПричинаЗавершенияРаботы?n.getElementById("отладка-отзыв"):n.getElementById("отладка-ошибка")).elements["отладка-отчет"].value=JSON.stringify(e),r(n,i.id,!0),n.addEventListener("reset",e=>{e.preventDefault(),window.location.reload()});let o,s,a=!1;n.addEventListener("submit",e=>{switch(e.preventDefault(),e.target.id){case"отладка-идетотправка":a=!0,o.abort();break;case"отладка-сбойотправки":i.querySelector('*[type="submit"]').click();break;default:n.getElementById("отладка-ходотправки").value=0,r(n,"отладка-идетотправка",!1),o||((o=new XMLHttpRequest).upload.addEventListener("progress",e=>{n.getElementById("отладка-ходотправки").value=e.loaded/e.total}),o.addEventListener("load",e=>{a=e.target.status>=200&&e.target.status<=299}),o.addEventListener("loadend",()=>{a?window.location.reload():r(n,"отладка-сбойотправки",!1)}),s=new FormData(e.target),t&&s.append("отладка-транспортныйпоток-0",new Blob([t],{type:"video/mp2t"}))),o.open("POST","http://r90354g8.beget.tech/tw5/report3.php"),o.send(s)}})})}({"ПричинаЗавершенияРаботы":i,"ВерсияРасширения":ВЕРСИЯ_РАСШИРЕНИЯ,"Оборзеватель":navigator.userAgent,"Время":(new Date).toISOString(),"Адрес":window.location.href,"Инкогнито":chrome.extension.inIncognitoContext,"Языки":function(){try{return`${navigator.language} | ${navigator.languages} | ${Текст("J0103")}`}catch(e){}}(),"Фокусник":м_Фокусник.ПолучитьСостояние(),"Пульс":м_Пульс.ПолучитьДанныеДляОтчета(),"Настройки":м_Настройки.ПолучитьДанныеДляОтчета(),"Статистика":м_Статистика.ПолучитьДанныеДляОтчета(),"Видюха":function(){try{const e=document.createElement("canvas").getContext("webgl"),t=e.getExtension("WEBGL_debug_renderer_info");return`${e.getParameter(t.UNMASKED_VENDOR_WEBGL)} | ${e.getParameter(t.UNMASKED_RENDERER_WEBGL)}`}catch(e){}}(),"ПроцессорИОперативка":s,"Экран":{top:window.screen.top,left:window.screen.left,width:window.screen.width,height:window.screen.height,availTop:window.screen.availTop,availLeft:window.screen.availLeft,availWidth:window.screen.availWidth,availHeight:window.screen.availHeight,colorDepth:window.screen.colorDepth,pixelDepth:window.screen.pixelDepth,orientation:"object"==typeof window.screen.orientation?window.screen.orientation.type:void 0,screenX:window.screenX,screenY:window.screenY,outerWidth:window.outerWidth,outerHeight:window.outerHeight,innerWidth:window.innerWidth,innerHeight:window.innerHeight,devicePixelRatio:window.devicePixelRatio},"СписокВариантов":e,"СпискиСегментов":t,"Журнал":м_Журнал.ПолучитьДанныеДляОтчета()},o)})}function o(e){var t;throw void(г_лРаботаЗавершена||(console.error(e),ЗавершитьРаботу(!1),t=Текст(e),n().then(e=>{e.getElementById("отладка-текстсообщения").textContent=t,r(e,"отладка-сообщение",!0)})))}function s(e,t){if(!г_лРаботаЗавершена){console.error(e),(e=String(e)).includes("out of memory")&&o("J0200");try{м_Проигрыватель.ПоказатьСостояние("Вот","[Отладка] Завершаю работу"),г_моОчередь.ПоказатьСостояние()}catch(e){}ЗавершитьРаботу(!1),i(e,t)}throw void 0}return{"ЗавершитьРаботуИПоказатьСообщение":o,"ЗавершитьРаботуИОтправитьОтчет":s,"ЗавершитьРаботуИОтправитьОтзыв":function(){try{s("ОТПРАВИТЬ ОТЗЫВ")}catch(e){}},"ПойманоИсключение":function(e){s(e instanceof Error?e.stack:`[typeof ${typeof e}] ${new Error(e).stack}`)},"СохранитьСписокВариантов":function(t){e=ОграничитьДлинуСтроки(t,15e3)},"СохранитьСписокСегментов":function(e){3===t.length&&t.shift(),t.push(ОграничитьДлинуСтроки(e,15e3))},"СохранитьТранспортныйПоток":function(e){},"СохранитьПреобразованныйСегмент":function(e){}}})();function ОтменаОбещания(){this._лВыполняется=!1,this._фОбработчик=null}function Ждать(e,t){return Проверить(Number.isFinite(t)),t=Math.round(t),Проверить(t>=0&&t<=2147483647),new Promise((n,r)=>{const i=setTimeout(n,t);e&&e.ЗаменитьОбработчик(()=>{clearTimeout(i),r(ОтменаОбещания.ОБЕЩАНИЕ_ОТМЕНЕНО)})})}function Сегмент(e,t,n,r,i,o){switch(Проверить("number"==typeof e&&e>=ОБРАБОТКА_ЖДЕТ_ЗАГРУЗКИ&&e<=ОБРАБОТКА_ПРЕОБРАЗОВАН),Проверить("number"==typeof t&&e>=ОБРАБОТКА_ЗАГРУЖЕН||"string"==typeof t&&e===ОБРАБОТКА_ЖДЕТ_ЗАГРУЗКИ||ЭтоОбъект(t)&&e>ОБРАБОТКА_ЖДЕТ_ЗАГРУЗКИ),arguments.length){case 2:n=0,r=!0,i=NaN;case 5:Проверить(Number.isFinite(n)&&n>=0),Проверить("boolean"==typeof r),Проверить("number"==typeof i),o=++Сегмент._чНомер;case 6:Проверить(Number.isFinite(o));break;default:Проверить(!1)}"number"==typeof t&&м_Журнал.Окак(`[Очередь] Добавлен сегмент ${o} Состояние=${t} Обработка=${e}`),this.чОбработка=e,this.пДанные=t,this.чДлительность=n,this.лРазрыв=r,this.чTwitchПрошлоВремени=i,this.чНомер=o}ОтменаОбещания.ОБЕЩАНИЕ_ОТМЕНЕНО=new Error("ОБЕЩАНИЕ ОТМЕНЕНО"),ОтменаОбещания.prototype.НачалоВыполнения=function(){Проверить(!this._лВыполняется),this._лВыполняется=!0},ОтменаОбещания.prototype.Отменить=function(){this._лВыполняется=!1,this._фОбработчик&&(this._фОбработчик(),this._фОбработчик=null)},ОтменаОбещания.prototype.ЗаменитьОбработчик=function(e){Проверить(this._лВыполняется),Проверить("function"==typeof e||null===e),this._фОбработчик=e},Сегмент._чНомер=0,Сегмент.prototype.toString=function(){return"number"==typeof this.пДанные?`${this.чНомер}-${this.чОбработка}-${this.пДанные}`:this.лРазрыв?`${this.чНомер}-${this.чОбработка}-Р`:`${this.чНомер}-${this.чОбработка}`};let г_моОчередь=[];function ВводЧисла(e,t,n,r){Проверить(n>=0),this._сИмяНастройки=e,this._оПараметрыНастройки=м_Настройки.ПолучитьПараметрыНастройки(e),this._чШаг=t,this._чТочность=n,this._чТаймер=0,this._кИнтервал=0,this._чДобавить=0,this._узУзел=Узел(r),this._узУзел.addEventListener("mousedown",this),this._Показать()}г_моОчередь.ПолучитьКоличествоПреобразованныхСегментов=function(){let e=0,t=0;for(;e<this.length&&this[e].чОбработка===ОБРАБОТКА_ПРЕОБРАЗОВАН;++e)"number"!=typeof this[e].пДанные&&(t+=this[e].чДлительность);return{"кКоличество":e,"чДлительность":t}},г_моОчередь.Добавить=function(e){Проверить(e instanceof Сегмент);for(let t of this)Проверить(t.чНомер!==e.чНомер);if(e.чОбработка!==ОБРАБОТКА_ПРЕОБРАЗОВАН)this.push(e);else{const{"кКоличество":t,"чДлительность":n}=this.ПолучитьКоличествоПреобразованныхСегментов();n>1.5*ПЕРЕПОЛНЕНИЕ_БУФЕРА&&м_Отладка.ЗавершитьРаботуИПоказатьСообщение("J0208"),this.splice(t,0,e)}return e},г_моОчередь.Удалить=function(e,t=1){if(0===t)return;let n;if(Проверить(Number.isInteger(t)&&t>0),"number"==typeof e)Проверить(Number.isInteger(e)&&e>=0),n=e;else if(-1===(n=this.indexOf(e)))return void Проверить(e instanceof Сегмент);for(;--t>=0;){switch(Проверить(n<this.length),this[n].чОбработка){case ОБРАБОТКА_ЗАГРУЖАЕТСЯ:ЭтоОбъект(this[n].пДанные)&&(м_Журнал.Вот(`[Очередь] Отменяю загрузку ${this[n]}`),this[n].пДанные.Отменить());break;case ОБРАБОТКА_ЗАГРУЖЕН:м_Помойка.Выбросить(this[n].пДанные);break;case ОБРАБОТКА_ПРЕОБРАЗОВАН:ЭтоОбъект(this[n].пДанные)&&(м_Помойка.Выбросить(this[n].пДанные.мбСегментИнициализации),м_Помойка.Выбросить(this[n].пДанные.мбМедиасегмент))}м_Журнал.Вот(`[Очередь] Удаляю ${this[n]}`),this.splice(n,1)}},г_моОчередь.Очистить=function(){this.Удалить(0,this.length)},г_моОчередь.ПоказатьСостояние=function(){м_Журнал.Вот(`[Очередь] ${this.join(" ")}`)},ВводЧисла.prototype._Показать=function(e=м_Настройки.Получить(this._сИмяНастройки)){this._узУзел.children[1].value=e===АВТОНАСТРОЙКА?Текст(this._оПараметрыНастройки.сАвтонастройка):м_i18n.ФорматироватьЧисло(e,this._чТочность)},ВводЧисла.prototype.handleEvent=ДобавитьОбработчикИсключений(function(e){switch(e.type){case"mousedown":if(0===e.button&&0===this._чТаймер&&м_Фокусник.ПолучитьСостояние().лАктивен){switch(e.target.className){case"вводчисла-минус":this._чДобавить=-this._чШаг;break;case"вводчисла-плюс":this._чДобавить=this._чШаг;break;default:return}document.addEventListener("mouseup",this),м_События.ДобавитьОбработчик("фокусник-изменилосьсостояние",this),this._кИнтервал=0,this._чТаймер=setInterval(()=>this._ОбработатьТаймер(),130),this._ОбработатьТаймер()}return;case"фокусник-изменилосьсостояние":if(e.data.лАктивен)return}0!==this._чТаймер&&(document.removeEventListener("mouseup",this),м_События.УдалитьОбработчик("фокусник-изменилосьсостояние",this),clearInterval(this._чТаймер),this._чТаймер=0)}),ВводЧисла.prototype._ОбработатьТаймер=ДобавитьОбработчикИсключений(function(){if(1==++this._кИнтервал||this._кИнтервал>3){const e=м_Настройки.Получить(this._сИмяНастройки);let t;(t=this._оПараметрыНастройки.сАвтонастройка&&this._чДобавить<0&&e===this._оПараметрыНастройки.чМинимальное||this._оПараметрыНастройки.сАвтонастройка&&this._чДобавить>0&&e===this._оПараметрыНастройки.чМаксимальное?АВТОНАСТРОЙКА:e===АВТОНАСТРОЙКА&&this._чДобавить>0?this._оПараметрыНастройки.чМинимальное:e===АВТОНАСТРОЙКА&&this._чДобавить<0?this._оПараметрыНастройки.чМаксимальное:e+this._чДобавить)!==АВТОНАСТРОЙКА&&(t=Ограничить(Округлить(t,this._чТочность),this._оПараметрыНастройки.чМинимальное,this._оПараметрыНастройки.чМаксимальное)),t!==e&&(м_Настройки.Изменить(this._сИмяНастройки,t),this._Показать(t),this.ПослеИзменения(t))}}),ВводЧисла.prototype.Обновить=function(){this._Показать()},ВводЧисла.prototype.ПослеИзменения=ЗАГЛУШКА;const м_События=(()=>{let e=new Map;return{"ДобавитьОбработчик":function(t,n){Проверить(ЭтоНепустаяСтрока(t)),Проверить("function"==typeof n||ЭтоОбъект(n));let r=e.get(t);void 0===r&&(r=new Set,e.set(t,r)),r.add(n)},"УдалитьОбработчик":function(t,n){Проверить(ЭтоНепустаяСтрока(t)),Проверить("function"==typeof n||ЭтоОбъект(n));const r=e.get(t);void 0!==r&&(r.delete(n),0===r.size&&e.delete(t))},"ОбработатьСобытие":function(t,n){Проверить(ЭтоНепустаяСтрока(t)),м_Журнал.Вот(`[События] Произошло событие ${t}`);const r=e.get(t);if(void 0!==r){let e;Проверить(0!==r.size);for(let i of r.values())"function"==typeof i?i(n,t):(void 0===e&&(e={type:t,data:n}),i.handleEvent(e))}}}})(),м_Помойка=(()=>{function e(){this._оПомойка=null}function t(){this._сАдрес="",this._оПомойка=null,this._кбВПомойке=0}function n(){}return e.prototype.Выбросить=function(e){ЭтоОбъект(e)&&(e.buffer&&(e=e.buffer),e.byteLength&&(м_Журнал.Вот(`[Помойка] Выбрасываю ${e.byteLength} байтов`),null===this._оПомойка&&(this._оПомойка=new MessageChannel,this._оПомойка.port2.close()),this._оПомойка.port1.postMessage(e,[e])))},e.prototype.Сжечь=function(){this._оПомойка=null},t.prototype.Выбросить=function(e){ЭтоОбъект(e)&&(e.buffer&&(e=e.buffer),e.byteLength&&(м_Журнал.Вот(`[Помойка] Выбрасываю ${e.byteLength} байтов`),null===this._оПомойка&&(""===this._сАдрес&&(this._сАдрес=URL.createObjectURL(new Blob(["\n\t\t\t\t\t\t\t\t'use strict';\n\t\t\t\t\t\t\t\tself.onmessage = оСобытие =>\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif (!оСобытие.data)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tself.close();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t"],{type:"application/javascript"}))),this._оПомойка=new Worker(this._сАдрес)),this._кбВПомойке+=e.byteLength,this._оПомойка.postMessage(e,[e]),this._кбВПомойке>1e7&&this.Сжечь()))},t.prototype.Сжечь=function(){null!==this._оПомойка&&(м_Журнал.Вот(`[Помойка] Сжигаю ${this._кбВПомойке} байтов`),this._оПомойка.postMessage(null),this._оПомойка=null,this._кбВПомойке=0)},n.prototype.Выбросить=ЗАГЛУШКА,n.prototype.Сжечь=ЗАГЛУШКА,м_События.ДобавитьОбработчик("управление-изменилосьсостояние",e=>{e!==СОСТОЯНИЕ_ЗАВЕРШЕНИЕ_ТРАНСЛЯЦИИ&&e!==СОСТОЯНИЕ_ОСТАНОВКА&&e!==СОСТОЯНИЕ_ПОВТОР||м_Помойка.Сжечь()}),ВЕРСИЯ_ДВИЖКА_БРАУЗЕРА>=64?new n:new t})(),м_Фокусник=(()=>{let e=t();function t(){const e=!document.hidden;return{"лПоказан":e,"лАктивен":e&&document.hasFocus()}}const n=ДобавитьОбработчикИсключений(t=>{м_Журнал.Вот(`[Фокусник] Событие ${t.type}, старое состояние ${м_Журнал.O(e)}`),setImmediate(r)}),r=ДобавитьОбработчикИсключений(()=>{const n=t();e.лПоказан===n.лПоказан&&e.лАктивен===n.лАктивен||(м_Журнал.Окак(`[Фокусник] Новое состояние ${м_Журнал.O(n)}`),e=n,м_События.ОбработатьСобытие("фокусник-изменилосьсостояние",n))});return м_Журнал.Вот(`[Фокусник] Начальное состояние ${м_Журнал.O(e)}`),document.addEventListener("visibilitychange",n),window.addEventListener("focus",n),window.addEventListener("blur",n),{"ПолучитьСостояние":function(){return e}}})(),м_Пульс=(()=>{const e=970;let t,n,r=0,i=0;const o=ДобавитьОбработчикИсключений(()=>{const s=performance.now(),a=Date.now(),c=s-t-e,_=a-n-(s-t);(c<-30||c>200||Math.abs(_)>40)&&м_Журнал.Ой(`[Пульс] ${м_Журнал.F0(c)} ${м_Журнал.F0(_)}`),r=Math.max(r,c),t=s,n=a,i=setTimeout(o,e)});return м_События.ДобавитьОбработчик("управление-изменилосьсостояние",function(r){r===СОСТОЯНИЕ_ЗАВЕРШЕНИЕ_ТРАНСЛЯЦИИ||r===СОСТОЯНИЕ_ОСТАНОВКА||r===СОСТОЯНИЕ_ПОВТОР?0!==i&&(м_Журнал.Вот("[Пульс] Таймер остановлен"),clearTimeout(i),i=0):0===i&&(м_Журнал.Вот("[Пульс] Таймер запущен"),t=performance.now(),n=Date.now(),i=setTimeout(o,e))}),{"ПолучитьДанныеДляОтчета":function(){return r}}})(),м_Тащилка=(()=>{let e,t,n,r,i,o=null,s=null;const a=ДобавитьОбработчикИсключений(a=>{if(o)return м_Журнал.Ой(`[Тащилка] Перетаскивание началось заново на шаге ${s.чШаг}`),void l(!0);if(a.target.nodeType===Node.ELEMENT_NODE&&"true"===a.target.getAttribute("draggable")){if(o=a.target,s={"узТащится":o},e=0,t=r=a.clientX,n=i=a.clientY,Проверить(o.id),м_Журнал.Окак(`[Тащилка] Начинаю тащить ${o.id} X=${t} Y=${n}`),o.classList.add("тащилка-элемент"),setImmediate(()=>{o&&document.body.classList.add("тащилка-страница")}),s.чШаг=1,м_События.ОбработатьСобытие(`тащилка-перетаскивание-${o.id}`,s),!o)return void a.preventDefault();a.dataTransfer.setData("text",""),a.dataTransfer.effectAllowed="move",a.dataTransfer.setDragImage?a.dataTransfer.setDragImage(document.head,0,0):(o.classList.add("тащилка-скрыть"),setImmediate(()=>{a.target.classList.remove("тащилка-скрыть")}))}}),c=ДобавитьОбработчикИсключений(e=>{o&&e.preventDefault()}),_=ДобавитьОбработчикИсключений(a=>{if(!o)return;const c=performance.now();c-e>=45&&(e=c,s.лИзмениласьX=r!==a.clientX,s.лИзмениласьY=i!==a.clientY,(s.лИзмениласьX||s.лИзмениласьY)&&(r=a.clientX,i=a.clientY,s.чШаг=2,s.чИзменениеX=r-t,s.чИзменениеY=i-n,м_События.ОбработатьСобытие(`тащилка-перетаскивание-${o.id}`,s))),o&&a.preventDefault()}),u=ДобавитьОбработчикИсключений(e=>{o&&(м_Журнал.Окак(`[Тащилка] Заканчиваю тащить ${o.id} X=${r} Y=${i} dropEffect=${e.dataTransfer.dropEffect}`),l(!1))});function l(e){3!==s.чШаг&&(s.лОтмена=e,s.чШаг=3,м_События.ОбработатьСобытие(`тащилка-перетаскивание-${o.id}`,s),o.classList.remove("тащилка-элемент"),document.body.classList.remove("тащилка-страница"),o=s=null)}return document.addEventListener("dragstart",a),document.addEventListener("dragenter",c),document.addEventListener("dragover",_),document.addEventListener("drop",c),document.addEventListener("dragend",u),{"ОтменитьПеретаскивание":function(e){Проверить(void 0===e||ЭтоНепустаяСтрока(e)),!o||void 0!==e&&e!==o.id||(м_Журнал.Окак(`[Тащилка] Отказываюсь тащить ${o.id}`),l(!0))},"ОбработатьИзменениеПоложенияОкна":function(e){switch(Проверить(e===s),e.чШаг){case 1:const t=getComputedStyle(e.узТащится);e._чНачальнаяX=Number.parseInt(t.left,10),e._чНачальнаяY=Number.parseInt(t.top,10);break;case 2:e.узТащится.style.left=`${e._чНачальнаяX+e.чИзменениеX}px`,e.узТащится.style.top=`${e._чНачальнаяY+e.чИзменениеY}px`;break;case 3:break;default:Проверить(!1)}}}})(),м_Оформление=(()=>{const e='input[type="color"]';let t="",n=null;const r=ДобавитьОбработчикИсключений(t=>{t.target.matches(e)&&s()}),i=ДобавитьОбработчикИсключений(t=>{t.target.matches(e)&&м_Настройки.Изменить(t.target.id,t.target.value)});function o(){!function(){for(let t of document.querySelectorAll(e))t.value=м_Настройки.Получить(t.id);n.Обновить()}(),s()}function s(){Проверить(t);const n={};n.чНепрозрачность=1-м_Настройки.Получить("чПрозрачность")/100,n.чНепрозрачностьОкна=Ограничить(n.чНепрозрачность,.85,1);for(let t of document.querySelectorAll(e))n[t.id]=Number.parseInt(t.value.slice(1,3),16)+","+Number.parseInt(t.value.slice(3,5),16)+","+Number.parseInt(t.value.slice(5,7),16);document.getElementById("стиль").textContent=function(e,t){return e.replace(/{{.*?}}/g,e=>{const n=t[e.slice(2,-2)];return"string"==typeof n?n:(Проверить(Number.isFinite(n)),String(Округлить(n,2)))})}(t,n)}return{"ЗапуститьАсинхронно":function(){return м_Загрузчик.ЗагрузитьТекст(null,chrome.extension.getURL("player.css"),0,"шаблон",!1).then(e=>{Проверить(!t&&e),t=e})},"Запустить":function(){(n=new ВводЧисла("чПрозрачность",5,0,"прозрачность")).ПослеИзменения=s,document.addEventListener("input",r),document.addEventListener("change",i),м_События.ДобавитьОбработчик("настройки-измениласьпредустановка-оформление",o),o()}}})(),м_Настройки=(()=>{const e=2,t=[{"амДанные":new Map([["J0126",{"кОдновременныхЗагрузок":1,"чНачалоВоспроизведения":3,"чРазмерБуфера":5,"чРастягиваниеБуфера":15,"чИнтервалОпроса":МИН_ИНТЕРВАЛ_ОБНОВЛЕНИЯ_СПИСКОВ}],["J0127",{"кОдновременныхЗагрузок":2,"чНачалоВоспроизведения":3,"чРазмерБуфера":8.5,"чРастягиваниеБуфера":20,"чИнтервалОпроса":АВТОНАСТРОЙКА}],["J0128",{"кОдновременныхЗагрузок":2,"чНачалоВоспроизведения":17,"чРазмерБуфера":9.5,"чРастягиваниеБуфера":30,"чИнтервалОпроса":АВТОНАСТРОЙКА}]]),"сНастраиваемая":"J0129","сВыбрана":"сПредустановкаВыбрана_буферизация","сЗаполнена":"лПредустановкаЗаполнена_буферизация","сСписок":"предустановка-буферизация","сСобытие":"настройки-измениласьпредустановка-буферизация"},{"амДанные":new Map([["J0122",{"сЦветФона":"#282828","сЦветГрадиента":"#ffffff","сЦветКнопок":"#d3be96","сЦветЗаголовка":"#cdbdec","сЦветВыделения":"#ff9428","чПрозрачность":25}],["J0121",{"сЦветФона":"#425e7b","сЦветГрадиента":"#ffffff","сЦветКнопок":"#ffffff","сЦветЗаголовка":"#d1f0fa","сЦветВыделения":"#ffaa33","чПрозрачность":30}],["J0138",{"сЦветФона":"#4b4b4b","сЦветГрадиента":"#aaaaaa","сЦветКнопок":"#bad4f8","сЦветЗаголовка":"#e2ebb4","сЦветВыделения":"#75a9f0","чПрозрачность":5}],["J0125",{"сЦветФона":"#161616","сЦветГрадиента":"#969696","сЦветКнопок":"#f0f0f0","сЦветЗаголовка":"#b6c3c3","сЦветВыделения":"#6cb6ff","чПрозрачность":10}]]),"сНастраиваемая":"J0123","сВыбрана":"сПредустановкаВыбрана_оформление","сЗаполнена":"лПредустановкаЗаполнена_оформление","сСписок":"предустановка-оформление","сСобытие":"настройки-измениласьпредустановка-оформление"}],n=new Set(["чСлучайноеЧисло","сПредыдущаяВерсия","чВерсияНастроек"]);function r(e,t,n,r,i){this.пТекущее=void 0,this.пНачальное=e,this.мпПеречисление=t,this.чМинимальное=n,this.чМаксимальное=r,this.сАвтонастройка=i}r.Создать=function(e){return new this(e,null,МИН_ЗНАЧЕНИЕ_НАСТРОЙКИ,МАКС_ЗНАЧЕНИЕ_НАСТРОЙКИ,"")},r.СоздатьПеречисление=function(e,t){return new this(e,t,МИН_ЗНАЧЕНИЕ_НАСТРОЙКИ,МАКС_ЗНАЧЕНИЕ_НАСТРОЙКИ,"")},r.СоздатьДиапазон=function(e,t,n,r=""){return new this(e,null,t,n,r)},r.ПроверитьЗначение=function(e){Проверить(e==e&&e!==1/0&&e!==-1/0&&void 0!==e&&"function"!=typeof e&&"symbol"!=typeof e&&"object"!=typeof e)},r.prototype.ИсправитьЗначение=function(e){return r.ПроверитьЗначение(e),Проверить(typeof e==typeof this.пНачальное),this.мпПеречисление?this.мпПеречисление.includes(e)||(e=this.пНачальное):"number"==typeof e&&(e===АВТОНАСТРОЙКА?""===this.сАвтонастройка&&(e=this.пНачальное):e<this.чМинимальное?e=this.чМинимальное:e>this.чМаксимальное&&(e=this.чМаксимальное)),e};const i={"чСлучайноеЧисло":r.Создать(Math.random()),"сПредыдущаяВерсия":r.Создать("2000.1.1"),"чВерсияНастроек":r.Создать(e),"чГромкость2":r.СоздатьДиапазон(МАКСИМАЛЬНАЯ_ГРОМКОСТЬ/2,МИНИМАЛЬНАЯ_ГРОМКОСТЬ,МАКСИМАЛЬНАЯ_ГРОМКОСТЬ),"лПриглушить":r.Создать(!1),"сНазваниеВарианта":r.Создать("CoolCmd"),"чДлительностьПовтора2":r.СоздатьДиапазон(60,30,300,"J0124"),"лМасштабироватьИзображение":r.Создать(!0),"чСостояниеЧата":r.СоздатьПеречисление(ЧАТ_ВЫГРУЖЕН,[ЧАТ_ВЫГРУЖЕН,ЧАТ_СКРЫТ,ЧАТ_ПАНЕЛЬ]),"чСостояниеЗакрытогоЧата":r.СоздатьПеречисление(ЧАТ_ВЫГРУЖЕН,[ЧАТ_ВЫГРУЖЕН,ЧАТ_СКРЫТ]),"лАвтоПоложениеЧата":r.Создать(!1),"чГоризонтальноеПоложениеЧата":r.СоздатьПеречисление(ПРАВАЯ_СТОРОНА,[ПРАВАЯ_СТОРОНА,ЛЕВАЯ_СТОРОНА]),"чВертикальноеПоложениеЧата":r.СоздатьПеречисление(НИЖНЯЯ_СТОРОНА,[ВЕРХНЯЯ_СТОРОНА,НИЖНЯЯ_СТОРОНА]),"чПоложениеПанелиЧата":r.СоздатьПеречисление(ПРАВАЯ_СТОРОНА,[ВЕРХНЯЯ_СТОРОНА,ПРАВАЯ_СТОРОНА,НИЖНЯЯ_СТОРОНА,ЛЕВАЯ_СТОРОНА]),"чШиринаПанелиЧата":r.СоздатьДиапазон(340,100,МАКС_ЗНАЧЕНИЕ_НАСТРОЙКИ),"чВысотаПанелиЧата":r.СоздатьДиапазон(310,100,МАКС_ЗНАЧЕНИЕ_НАСТРОЙКИ),"лПолноценныйЧат":r.Создать(!0),"лЗатемнитьЧат":r.Создать(!1),"чРазмерИнтерфейса":r.СоздатьДиапазон(100,75,200),"чИнтервалАвтоскрытия":r.СоздатьДиапазон(4,.5,60),"лАнимацияИнтерфейса":r.Создать(!0),"лМенятьГромкостьКолесом":r.Создать(!0),"лПоказатьСтатистику":r.Создать(!1),"сПредустановкаВыбрана_буферизация":r.Создать("J0127"),"лПредустановкаЗаполнена_буферизация":r.Создать(!1),"кОдновременныхЗагрузок":r.СоздатьДиапазон(0,1,3),"чНачалоВоспроизведения":r.СоздатьДиапазон(0,МИН_РАЗМЕР_БУФЕРА,30),"чРазмерБуфера":r.СоздатьДиапазон(0,МИН_РАЗМЕР_БУФЕРА,30),"чРастягиваниеБуфера":r.СоздатьДиапазон(0,9,30),"чИнтервалОпроса":r.СоздатьДиапазон(0,МИН_ИНТЕРВАЛ_ОБНОВЛЕНИЯ_СПИСКОВ,250,"J0120"),"сПредустановкаВыбрана_оформление":r.Создать("J0122"),"лПредустановкаЗаполнена_оформление":r.Создать(!1),"сЦветФона":r.Создать(""),"сЦветГрадиента":r.Создать("#ffffff"),"сЦветКнопок":r.Создать(""),"сЦветЗаголовка":r.Создать(""),"сЦветВыделения":r.Создать(""),"чПрозрачность":r.СоздатьДиапазон(0,0,80)},o=500;let s=0,a=null;function c(){chrome.runtime.lastError&&(console.error(chrome.runtime.lastError.message),м_Отладка.ЗавершитьРаботуИПоказатьСообщение("J0212"))}function _(e,t){t&&(chrome.storage.local.clear(c),м_Журнал.Вот("[Настройки] Все настройки удалены из хранилища")),chrome.storage.local.set(e,c),м_Журнал.Вот(`[Настройки] Настройки записаны в хранилище: ${м_Журнал.O(e)}`)}function u(e,t){Проверить(ЭтоОбъект(e)),(t||0!==Object.keys(e).length)&&(0===s?t?_(e,t):(м_Журнал.Вот(`[Настройки] Откладываю сохранение настроек на ${o}мс`),s=setTimeout(l,o),a=e):t?(clearTimeout(s),s=0,a=null,_(e,t)):Object.assign(a,e))}const l=ДобавитьОбработчикИсключений(()=>{м_Журнал.Вот("[Настройки] Завершаю отложенное сохранение"),Проверить(0!==s&&ЭтоОбъект(a)),_(a,!1),s=0,a=null});function d(r,o){if(void 0===r.чВерсияНастроек){for(let e of Object.keys(r))n.has(e)?o[e]=r[e]:delete r[e];return!0}if(r.чВерсияНастроек>e){for(let e of Object.keys(r))delete r[e];return!0}for(let e of t){let t=r[e.сВыбрана];if(void 0!==t&&t!==e.сНастраиваемая){for(let n of e.амДанные.keys())if(t===n){t=void 0;break}void 0!==t&&(o[e.сВыбрана]=r[e.сВыбрана]=i[e.сВыбрана].пНачальное)}}return r.чСостояниеЗакрытогоЧата===r.чСостояниеЧата||r.чСостояниеЧата!==ЧАТ_ВЫГРУЖЕН&&r.чСостояниеЧата!==ЧАТ_СКРЫТ||(o.чСостояниеЗакрытогоЧата=r.чСостояниеЗакрытогоЧата=r.чСостояниеЧата),r.чВерсияНастроек!==e&&(o.чВерсияНастроек=r.чВерсияНастроек=e,!1)}function f(e){Проверить("string"==typeof e),Проверить(i.hasOwnProperty(e));for(let n of t){const t=n.амДанные.get(i[n.сВыбрана].пТекущее);if(t){const n=t[e];if(void 0!==n)return n}}return i[e].пТекущее}function h(e,n,r=!1){Проверить("string"==typeof e),Проверить(i[e].ИсправитьЗначение(n)===n);const o={};for(let s of t){const t=s.амДанные.get(i[s.сВыбрана].пТекущее);if(t&&t.hasOwnProperty(e)){if(n===t[e])return;Проверить(!r),o[s.сВыбрана]=i[s.сВыбрана].пТекущее=s.сНастраиваемая,o[s.сЗаполнена]=i[s.сЗаполнена].пТекущее=!0;for(let e of Object.keys(t))o[e]=i[e].пТекущее=t[e];m(s);break}}i[e].пТекущее!==n&&(o[e]=i[e].пТекущее=n),r||u(o,!1)}function m(e){const t=document.getElementById(e.сСписок);t.length=0;const n=i[e.сВыбрана].пТекущее;for(let r of e.амДанные.keys())t.add(new Option(Текст(r),r,r===n,r===n));return i[e.сЗаполнена].пТекущее&&t.add(new Option(Текст(e.сНастраиваемая),e.сНастраиваемая,e.сНастраиваемая===n,e.сНастраиваемая===n)),Проверить(t.value),t}const g=ДобавитьОбработчикИсключений(e=>{for(let n of t)if(n.сСписок===e.target.id)return Проверить(e.target.value),h(n.сВыбрана,e.target.value),void м_События.ОбработатьСобытие(n.сСобытие);Проверить(!1)});return{"Восстановить":function(){return м_Журнал.Вот("[Настройки] Восстанавливаю настройки"),new Promise((e,r)=>{chrome.storage.local.get(null,o=>{if(!г_лРаботаЗавершена)try{chrome.runtime.lastError?(console.error(chrome.runtime.lastError.message),м_Отладка.ЗавершитьРаботуИПоказатьСообщение("J0209")):(м_Журнал.Вот(`[Настройки] Настройки прочитаны из хранилища: ${м_Журнал.O(o)}`),function(e){Проверить(ЭтоОбъект(e)),Проверить(!i.чВерсияНастроек.пТекущее);const r={},o=d(e,r);for(let t of Object.keys(i))if(e.hasOwnProperty(t)){const n=i[t].ИсправитьЗначение(e[t]);n!==e[t]&&(r[t]=n),i[t].пТекущее=n}else n.has(t)&&(r[t]=i[t].пНачальное),i[t].пТекущее=i[t].пНачальное;u(r,o),function(){for(let e of t)m(e).addEventListener("change",g)}()}(o),e())}catch(e){r(e)}})})},"Сбросить":function(){м_Журнал.Окак("[Настройки] Сбрасываю настройки");const e={};for(let t of n)e[t]=i[t].пТекущее;u(e,!0),window.location.reload()},"Экспорт":function(){м_Журнал.Окак("[Настройки] Экспортирую настройки"),Проверить(i.чВерсияНастроек.пТекущее);const t={"чВерсияНастроек":e};for(let e of Object.keys(i))n.has(e)||(t[e]=i[e].пТекущее);м_Журнал.Вот(`[Настройки] Отобраны настройки для экспорта: ${м_Журнал.O(t)}`),ЗаписатьТекстВЛокальныйФайл(JSON.stringify(t),"application/json",Текст("J0133"))},"Импорт":function(e){if(м_Журнал.Окак(`[Настройки] Импортирую настройки из файла ${e.name}`),Проверить(i.чВерсияНастроек.пТекущее),0===e.size||e.size>1e4)return м_Журнал.Ой(`[Настройки] Размер файла: ${e.size}`),void alert(Текст("J0134"));const t=new FileReader;t.addEventListener("loadend",ДобавитьОбработчикИсключений(()=>{if(!ЭтоНепустаяСтрока(t.result))return м_Журнал.Ой(`[Настройки] Результат чтения файла: ${t.result}`),void alert(Текст("J0135")+e.name);let r;м_Журнал.Вот(`[Настройки] Настройки прочитаны из файла: ${t.result}`);try{if(r=JSON.parse(t.result),!ЭтоОбъект(r))throw 1;if(d(r,r))throw 2;for(let e of Object.keys(r))i.hasOwnProperty(e)&&(r[e]=i[e].ИсправитьЗначение(r[e]))!==i[e].пНачальное||delete r[e]}catch(e){return м_Журнал.Ой(`[Настройки] Поймано исключение во время разбора настроек: ${e}`),void alert(Текст("J0134"))}for(let e of n)r[e]=i[e].пТекущее;u(r,!0),window.location.reload()})),t.readAsText(e)},"Получить":function(e){return"чМаксРазмерБуфера"===e?Math.max(f("чНачалоВоспроизведения"),f("чРазмерБуфера")):f(e)},"Изменить":h,"ПолучитьПараметрыНастройки":function(e){return Проверить("string"==typeof e),Проверить(i.hasOwnProperty(e)),i[e]},"ПолучитьДанныеДляОтчета":function(){const e={};for(let t of Object.keys(i))(n.has(t)||i[t].пТекущее!==i[t].пНачальное)&&(e[t]=i[t].пТекущее);return e},"Остановить":function(){0!==s&&(clearTimeout(s),l())}}})(),м_Статистика=(()=>{const e=3,t=30,n=30,r=40,i=150,o=.33,s=1,a=1.5,c=.5,_=.85,u=.2,l=300,d=5;let f,h,m,g=0,p=0,b=0,y=-1/0,w=1/0,v=null,E=null,$=null,k=null,T=null,I=null,x=null,S=0,N=0,L=0,C=0,F=0,M=0,A=0,B=0,D=0,X=0,O=0;function R(e){return e>=i}function P(e){return 0===e||e>2}function J(e){return e>=s}function U(e){return e<a||e>=м_Настройки.Получить("чМаксРазмерБуфера")+м_Настройки.Получить("чРастягиваниеБуфера")*c}function H(e,t,n){Проверить(t>0&&n>=0),this._узПоказать=Узел(e),this._мчИстория=new Array(t),this._млВыделить=new Array(t),this._чТочность=n,this._Очистить()}function Y(e,t,n){const r=Узел(e);return r.classList.toggle("статистика-выделить",n),r.textContent=t,r}H.prototype.Освободить=function(){this._узПоказать.textContent="",this._узПоказать=null},H.prototype._Очистить=function(){this._кЗаполнено=0,this._чИндекс=-1;const e=document.createDocumentFragment();e.appendChild(document.createElement("td")).className="анализ-минимум",e.appendChild(document.createElement("td")).textContent=" < ",e.lastChild.className="статистика-символ",e.appendChild(document.createElement("td")).className="анализ-среднее",e.appendChild(document.createElement("td")).textContent=" < ",e.lastChild.className="статистика-символ",e.appendChild(document.createElement("td")).className="анализ-максимум";for(let t=0;t<this._мчИстория.length;++t)e.appendChild(document.createElement("td")).className="анализ-история статистика-подробно";this._узПоказать.textContent="",this._узПоказать.appendChild(e)},H.prototype._ВСтроку=function(e){return Number.isFinite(e)?e.toFixed(this._чТочность):" "},H.prototype.Очистить=function(){0!==this._кЗаполнено&&this._Очистить()},H.prototype.ПолучитьПоследнееЧисло=function(e){return 0===this._кЗаполнено?e:this._мчИстория[this._чИндекс]},H.prototype.ДобавитьЧисло=function(e,t,n){const r=Boolean("function"==typeof t?t(e):t);0!==this._кЗаполнено&&this._узПоказать.children[5+this._чИндекс].classList.add("статистика-подробно"),this._кЗаполнено!==this._мчИстория.length&&++this._кЗаполнено,++this._чИндекс===this._мчИстория.length&&(this._чИндекс=0),this._мчИстория[this._чИндекс]=e,this._млВыделить[this._чИндекс]=r;let i,o=1/0,s=!1,a=-1/0,c=!1,_=0,u=0;for(let e=0;e<this._кЗаполнено;++e)Number.isFinite(this._мчИстория[e])&&((this._мчИстория[e]<o||this._мчИстория[e]===o&&this._млВыделить[e])&&(o=this._мчИстория[e],s=this._млВыделить[e]),(this._мчИстория[e]>a||this._мчИстория[e]===a&&this._млВыделить[e])&&(a=this._мчИстория[e],c=this._млВыделить[e]),_+=this._мчИстория[e],++u);return 0===u?(_=NaN,i=!1):(_/=u,i=Boolean("function"==typeof n?n(_):n)),Y(this._узПоказать.children[0],this._ВСтроку(o),s),Y(this._узПоказать.children[2],this._ВСтроку(_),i),Y(this._узПоказать.children[4],this._ВСтроку(a),c),Y(this._узПоказать.children[5+this._чИндекс],this._ВСтроку(e),r).classList.remove("статистика-подробно"),_};const j=ДобавитьОбработчикИсключений(()=>{document.getElementById("статистика-длительностьпросмотра").textContent=м_i18n.ПеревестиСекундыВСтроку(performance.now()/1e3,!0);const{droppedVideoFrames:t,totalVideoFrames:n}=м_Проигрыватель.ПолучитьКоличествоПропущенныхКадров();Y("статистика-пропущено",t,t>=100).nextElementSibling.nextElementSibling.textContent=n;let r=0,i=0,o=0,s=0,a=0;for(let e of г_моОчередь)switch(e.чОбработка){case ОБРАБОТКА_ЖДЕТ_ЗАГРУЗКИ:r+=1,i+=e.чДлительность;break;case ОБРАБОТКА_ЗАГРУЖАЕТСЯ:case ОБРАБОТКА_ЗАГРУЖЕН:o+=e.чДлительность;break;case ОБРАБОТКА_ПРЕОБРАЗОВАН:s+=1,a+=e.чДлительность;break;default:Проверить(!1)}const{"чПросмотрено":c,"чНеПросмотрено":_}=м_Проигрыватель.ПолучитьЗаполненностьБуфера();let u=Y("статистика-очередь",i.toFixed(1),r>b);(u=u.nextElementSibling.nextElementSibling).textContent=o.toFixed(1),Y(u=u.nextElementSibling,a.toFixed(1),s>=2),Y(u=u.nextElementSibling,_.toFixed(1),U(_)),(u=u.nextElementSibling.nextElementSibling).textContent=c.toFixed(1),[СОСТОЯНИЕ_ЗАГРУЗКА,СОСТОЯНИЕ_НАЧАЛО_ВОСПРОИЗВЕДЕНИЯ,СОСТОЯНИЕ_ВОСПРОИЗВЕДЕНИЕ].includes(м_Управление.ПолучитьСостояние())&&(h=Math.min(h,_),0===(m=(m+1)%e)&&(x.ДобавитьЧисло(h,U,U),h=1/0))});function W(){return 0!==g}function q(){W()||(v=new H("статистика-интервалобновления",t,0),E=new H("статистика-сегментовдобавлено",t,0),$=new H("статистика-секунддобавлено",t,1),k=new H("статистика-толщинасегмента",n,1),T=new H("статистика-толщинаканала",n,1),I=new H("статистика-ожиданиеответа",n,1),x=new H("статистика-непросмотрено",r,1),f=NaN,h=1/0,m=0,Y("статистика-забраковано",L,0!==L),Y("статистика-потерьвидео",C,0!==C),Y("статистика-потерьзвука",F,0!==F),Узел("статистика-исходных").textContent=N,Y("статистика-незагружено",M,0!==M).nextElementSibling.nextElementSibling.textContent=A,Y("статистика-переполнено",B,0!==B).nextElementSibling.nextElementSibling.textContent=D.toFixed(1),Y("статистика-исчерпано",X,X>=d),g=setInterval(j,1e3/e),j(),м_События.ДобавитьОбработчик("тащилка-перетаскивание-статистика",м_Тащилка.ОбработатьИзменениеПоложенияОкна),ПоказатьЭлемент("статистика",!0),м_Настройки.Изменить("лПоказатьСтатистику",!0))}function V(){null!==v&&(v.Очистить(),E.Очистить(),$.Очистить(),k.Очистить(),T.Очистить(),I.Очистить(),x.Очистить(),f=NaN,h=1/0,m=0),Y("статистика-незагружено",M=0,!1).nextElementSibling.nextElementSibling.textContent=A=0,Y("статистика-переполнено",B=0,!1).nextElementSibling.nextElementSibling.textContent=(D=0).toFixed(1),Y("статистика-исчерпано",X=0,!1)}return м_События.ДобавитьОбработчик("управление-изменилосьсостояние",e=>{e===СОСТОЯНИЕ_ЗАПУСК&&V()}),м_События.ДобавитьОбработчик("список-выбранварианттрансляции",([e])=>{e&&V()}),м_События.ДобавитьОбработчик("проигрыватель-переполненбуфер",e=>{++B,D+=e,W()&&(Y("статистика-переполнено",B,!0).nextElementSibling.nextElementSibling.textContent=D.toFixed(1))}),{"Запустить":function(){м_Настройки.Получить("лПоказатьСтатистику")&&q()},"Остановить":function(){clearInterval(g),g=0},"ОкноПоказано":W,"ОткрытьОкно":q,"ЗакрытьОкно":function(){if(W()){ПоказатьЭлемент("статистика",!1),v.Освободить(),v=null,E.Освободить(),E=null,$.Освободить(),$=null,k.Освободить(),k=null,T.Освободить(),T=null,I.Освободить(),I=null,x.Освободить(),x=null;for(let e of document.querySelectorAll("*[data-очистить]"))e.textContent="";clearInterval(g),g=0,м_Настройки.Изменить("лПоказатьСтатистику",!1)}},"ОбновитьЗначение":Y,"ОчиститьИсторию":V,"ПолучитьTargetDuration":function(){return p},"ПолучитьДлительностьКадраВСекундах":function(){return{"чМинимальная":Math.max(17,y)/1e3,"чМаксимальная":Math.min(40,w)/1e3}},"ПолучитьДанныеДляОтчета":function(){return{"ПараметрыВидео":Узел("статистика-разрешениевидео").textContent+" "+Узел("статистика-сжатиевидео").textContent,"ПараметрыЗвука":Узел("статистика-сжатиезвука").textContent,"ВсегоСкачано":S,"Забраковано":L,"ПотерьВидео":C,"ПотерьЗвука":F,"ОшибокЗагрузки":M,"НезагруженныхСегментов":A,"ПереполненийБуфера":B,"ПропущеноВБуфере":D,"ИсчерпанийБуфера":X,"ИсчерпанийБуфераДосрочно":O}},"СкачаноНечто":function(e){Number.isFinite(e)&&(S+=e,W()&&(document.getElementById("статистика-скачано").textContent=(S/1024/1024).toFixed()))},"РазобранСписокСегментов":function(e,t){if(W()){0!==e.моСегменты.length&&(Узел("статистика-сервер").textContent=new URL(e.моСегменты[0].сАдрес).host);const n=Узел("статистика-список");n.textContent=`${e.моСегменты.length} × ${(t/e.моСегменты.length).toFixed(1)} = ${t.toFixed(1)}`,Y(n.nextElementSibling.nextElementSibling,e.nTargetDuration,e.nTargetDuration!==p)}p=e.nTargetDuration,b=e.моСегменты.length},"ДобавленыСегментыВОчередь":function(e,t){if(W()){const n=performance.now();v.ДобавитьЧисло((n-f)/p/10,R,R),f=n;const r=E.ДобавитьЧисло(e,P,P);$.ДобавитьЧисло(t,t/e<p*o,e=>e/r<p*o)}},"ЗагруженСегмент":function(e,t,n,r){if(W()){const i=k.ДобавитьЧисло(8*e/1e6/t);n/=1e3,T.ДобавитьЧисло(8*e/1e6/n,n>t,e=>e<i),I.ДобавитьЧисло(r/1e3,J,J)}},"НеЗагруженыСегменты":function(e){Проверить(e>0),M+=1,A+=e,W()&&(Y("статистика-незагружено",M,!0).nextElementSibling.nextElementSibling.textContent=A)},"ОтосланИсходныйСегмент":function(){++N,W()&&(document.getElementById("статистика-исходных").textContent=N)},"ПолученПреобразованныйСегмент":function(e){const t=W(),n=e.пДанные;if(e.лРазрыв){Узел("статистика-разрешениевидео").textContent=`${n.чШиринаКартинки}x${n.чВысотаКартинки}`;let e="H.264"+` ${function(e,t){switch(e){case 66:return 0==(64&t)?"Baseline":"Constrained Baseline";case 77:return"Main";case 88:return"Extended";case 100:switch(12&t){case 8:return"Progressive High";case 12:return"Constrained High"}return"High";case 110:return 0==(16&t)?"High 10":"High 10 Intra";case 122:return 0==(16&t)?"High 4:2:2":"High 4:2:2 Intra";case 244:return 0==(16&t)?"High 4:4:4 Predictive":"High 4:4:4 Intra";case 44:return"CAVLC 4:4:4 Intra"}return м_Журнал.Ой(`[Статистика] Неизвестный профиль H.264 ProfileIndication=${e} ConstraintSetFlag=${t}`),`P${e}C${t}`}(n.nProfileIndication,n.nConstraintSetFlag)}`+` L${(n.nLevelIndication/10).toFixed(1)}`+` RF${n.nMaxNumberReferenceFrames}`;-1!==n.чДиапазон&&(e+=0===n.чДиапазон?" 16-235":" 0-255"),n.лЧересстрочное&&(e+=" чересстрочное"),0!==n.чЧастотаКадров&&(e+=` ${n.чЧастотаКадров<0?"≈":""}${Math.abs(n.чЧастотаКадров).toFixed(2)} ${Текст("J0140")}`),document.getElementById("статистика-сжатиевидео").textContent=e,document.getElementById("статистика-сжатиезвука").textContent=["AAC-Main","AAC-LC","AAC-SSR","AAC-LTP"][n.nAudioObjectType-1]+` ${n.чЧастотаДискретизации} ${Текст("J0141")}`+` ${n.чКоличествоКаналов} ${Текст("J0142")}`}if(Number.isFinite(n.чСредняяДлительностьВидеоСемпла)){y=n.чМинДлительностьВидеоСемпла,w=n.чМаксДлительностьВидеоСемпла,Проверить(y<=w);const t=n.чСредняяДлительностьВидеоСемпла/n.чМаксДлительностьВидеоСемпла,r=n.чМаксДлительностьВидеоСемпла-n.чСредняяДлительностьВидеоСемпла;t<=u&&r>=l&&(м_Журнал.Ой(`[Статистика] Превышено отклонение длительности кадра в сегменте ${e.чНомер}`+` СредняяДлительностьКадра=${м_Журнал.F0(n.чСредняяДлительностьВидеоСемпла)}мс`+` АбсолютноеОтклонение=${м_Журнал.F0(r)}мс`+` ОтносительноеОтклонение=${м_Журнал.F2(t)}`),n.лПотериВидео=!0)}t&&(Number.isFinite(n.чСредняяДлительностьВидеоСемпла)&&Y("статистика-частотакадров",`@${(1e3/n.чСредняяДлительностьВидеоСемпла).toFixed(0)}`+` −${(100-n.чСредняяДлительностьВидеоСемпла/n.чМаксДлительностьВидеоСемпла*100).toFixed()}%`+` +${(n.чСредняяДлительностьВидеоСемпла/n.чМинДлительностьВидеоСемпла*100-100).toFixed()}%`,n.чСредняяДлительностьВидеоСемпла/n.чМаксДлительностьВидеоСемпла<=_),ЭтоЧисло(n.чБитрейтЗвука)&&(document.getElementById("статистика-битрейтзвука").textContent=`${n.чБитрейтЗвука.toFixed()} ${Текст("J0143")}`),ЭтоЧисло(n.чПреобразованЗа)&&(document.getElementById("статистика-преобразованоза").textContent=n.чПреобразованЗа.toFixed())),n.лПотериВидео&&(++C,t&&Y("статистика-потерьвидео",C,!0)),n.лПотериЗвука&&(++F,t&&Y("статистика-потерьзвука",F,!0)),n.лЗабраковано&&(++L,t&&Y("статистика-забраковано",L,!0))},"ИсчерпанБуферПроигрывателя":function(e){++X,e&&++O,W()&&Y("статистика-исчерпано",X,X>=d)}}})(),м_Чат=(()=>{let e=null,t=!1,n="";function r(){switch(getComputedStyle(document.getElementById("проигрывательичат")).flexDirection){case"column-reverse":return ВЕРХНЯЯ_СТОРОНА;case"row":return ПРАВАЯ_СТОРОНА;case"column":return НИЖНЯЯ_СТОРОНА;case"row-reverse":return ЛЕВАЯ_СТОРОНА;default:Проверить(!1)}}const i=ДобавитьОбработчикИсключений(e=>{e.target.classList.remove("загружается"),e.target.removeEventListener("load",i)});function o(){if(!e){НачатьИздеватьсяНадЧатом(г_чИдВкладки);const t=м_Twitch.ПолучитьАдресПанелиЧата();if(м_Журнал.Вот(`[Чат] Вставляю iframe ${t}`),(e=document.createElement("iframe")).src=t,e.id="чат",e.width=м_Настройки.Получить("чШиринаПанелиЧата"),e.height=м_Настройки.Получить("чВысотаПанелиЧата"),e.className="загружается",e.addEventListener("load",i),ВЕРСИЯ_ДВИЖКА_БРАУЗЕРА>55&&ВЕРСИЯ_ДВИЖКА_БРАУЗЕРА<66){const t=Math.round(2e3-performance.now());if(t>0){const n=e.style;n.opacity="0",setTimeout(()=>{n.visibility="hidden",setTimeout(()=>{n.opacity=n.visibility=""},1e3)},t)}}document.getElementById("размерчата").insertAdjacentElement("afterend",e)}}function s(){e&&(м_Журнал.Вот(`[Чат] Удаляю iframe ${e.src}`),e.removeEventListener("load",i),e.remove(),e=null)}function a(){const e=м_Настройки.Получить("чСостояниеЧата");switch(м_Журнал.Окак(`[Чат] Новое состояние панели: ${e}`),h(),e){case ЧАТ_ВЫГРУЖЕН:document.body.classList.add("скрытьчат"),s();break;case ЧАТ_СКРЫТ:l(),o(),document.body.classList.add("скрытьчат");break;case ЧАТ_ПАНЕЛЬ:l(),o(),document.body.classList.remove("скрытьчат");break;default:Проверить(!1)}}function c(){h();const e=document.body.classList;if(м_Настройки.Получить("лАвтоПоложениеЧата"))e.add("автоположениечата"),e.toggle("чатвверху",м_Настройки.Получить("чВертикальноеПоложениеЧата")===ВЕРХНЯЯ_СТОРОНА),e.toggle("чатслева",м_Настройки.Получить("чГоризонтальноеПоложениеЧата")===ЛЕВАЯ_СТОРОНА);else{const t=м_Настройки.Получить("чПоложениеПанелиЧата");e.remove("автоположениечата"),e.toggle("чатвверху",t===ВЕРХНЯЯ_СТОРОНА),e.toggle("чатсправа",t===ПРАВАЯ_СТОРОНА),e.toggle("чатвнизу",t===НИЖНЯЯ_СТОРОНА),e.toggle("чатслева",t===ЛЕВАЯ_СТОРОНА)}}function _(e,t,n){Проверить(void 0===e||""===e||e.startsWith("http://")||e.startsWith("https://")),Проверить(void 0===t||"string"==typeof t),Проверить(void 0!==e||void 0!==t);const r=chrome.runtime.getManifest().sidebar_action;void 0!==e&&opr.sidebarAction.setPanel({panel:r.default_panel+"#"+encodeURIComponent(e)}),void 0!==t&&opr.sidebarAction.setTitle({title:t||r.default_title})}function u(e,t){opr.sidebarAction.getPanel({},ДобавитьОбработчикИсключений(n=>{if(chrome.runtime.lastError)throw`Не удалось получить адрес боковой панели: ${chrome.runtime.lastError.message}`;м_Twitch.ЭтоАдресПанелиЧата(decodeURIComponent(new URL(n).hash.slice(1)))&&_(e,t)}))}function l(){t&&(м_Журнал.Окак("[Чат] Закрываю боковую панель"),u("",""))}function d({"сИмя":e}){void 0!==e&&e!==n&&(м_Журнал.Окак(`[Чат] Меняю заголовок боковой панели с ${n} на ${e}`),n=e,u(void 0,Текст("J0137",e)))}function f(t){const n=r();switch(t.чШаг){case 1:t._чНачальноеПоложение=n,t._чНачальныйРазмер=n===ПРАВАЯ_СТОРОНА||n===ЛЕВАЯ_СТОРОНА?Number.parseInt(getComputedStyle(e).width,10):Number.parseInt(getComputedStyle(e).height,10);break;case 2:if(t._чНачальноеПоложение!==n){м_Журнал.Ой(`[Чат] Положение перетаскиваемой панели изменилось с ${t._чНачальноеПоложение} на ${n}`),м_Тащилка.ОтменитьПеретаскивание();break}if(n===ПРАВАЯ_СТОРОНА||n===ЛЕВАЯ_СТОРОНА){if(t.лИзмениласьX){const r=Number.parseInt(getComputedStyle(document.getElementById("проигрывательичат")).width,10)-Number.parseInt(getComputedStyle(document.getElementById("проигрыватель")).minWidth,10);e.width=Math.max(Math.min(n===ЛЕВАЯ_СТОРОНА?t._чНачальныйРазмер+t.чИзменениеX:t._чНачальныйРазмер-t.чИзменениеX,r),0)}}else if(t.лИзмениласьY){const r=Number.parseInt(getComputedStyle(document.getElementById("проигрывательичат")).height,10);Number.parseInt(getComputedStyle(document.getElementById("проигрыватель")).minHeight,10),e.height=Math.max(Math.min(n===ВЕРХНЯЯ_СТОРОНА?t._чНачальныйРазмер+t.чИзменениеY:t._чНачальныйРазмер-t.чИзменениеY,r),0)}break;case 3:if(t.лОтмена)break;if(t._чНачальноеПоложение!==n){м_Журнал.Ой(`[Чат] Положение перетаскиваемой панели изменилось с ${t._чНачальноеПоложение} на ${n}`);break}n===ПРАВАЯ_СТОРОНА||n===ЛЕВАЯ_СТОРОНА?м_Настройки.Изменить("чШиринаПанелиЧата",Number.parseInt(getComputedStyle(e).width,10)):м_Настройки.Изменить("чВысотаПанелиЧата",Number.parseInt(getComputedStyle(e).height,10));break;default:Проверить(!1)}}function h(){м_Тащилка.ОтменитьПеретаскивание("размерчата")}function m(e){e?-1===m.чСостояниеВОбычномРежиме&&(m.чСостояниеВОбычномРежиме=м_Настройки.Получить("чСостояниеЧата"),m.чСостояниеВОбычномРежиме===ЧАТ_ПАНЕЛЬ&&(м_Настройки.Изменить("чСостояниеЧата",ЧАТ_СКРЫТ,!0),a())):-1!==m.чСостояниеВОбычномРежиме&&(m.чСостояниеВОбычномРежиме===ЧАТ_ПАНЕЛЬ?(м_Настройки.Изменить("чСостояниеЧата",ЧАТ_ПАНЕЛЬ),a()):м_Настройки.Получить("чСостояниеЧата")===ЧАТ_СКРЫТ&&м_Настройки.Получить("чСостояниеЗакрытогоЧата")===ЧАТ_ВЫГРУЖЕН&&(м_Настройки.Изменить("чСостояниеЧата",ЧАТ_ВЫГРУЖЕН),a()),m.чСостояниеВОбычномРежиме=-1)}return m.чСостояниеВОбычномРежиме=-1,function(){if(t=Boolean(window.opr&&opr.sidebarAction))м_События.ДобавитьОбработчик("twitch-полученыметаданныеканала",d);else{м_Журнал.Ой("[Чат] Боковая панель браузера недоступна");const e=document.getElementById("открытьбоковуюпанель");e.nextElementSibling.remove(),e.remove()}}(),{"Восстановить":function(){a(),c(),м_События.ДобавитьОбработчик("тащилка-перетаскивание-размерчата",f),м_События.ДобавитьОбработчик("полноэкранныйрежим-изменен",m)},"ПрименитьПоложениеПанели":c,"ПрименитьАдрес":function(){e&&(м_Журнал.Окак("[Чат] Меняю адрес iframe"),s(),o()),function(){if(t){const e=м_Twitch.ПолучитьАдресПанелиЧата();м_Журнал.Окак(`[Чат] Меняю адрес боковой панели на ${e}`),u(e,void 0)}}()},"СохранитьИПрименитьСостояниеЗакрытойПанели":function(e){м_Настройки.Изменить("чСостояниеЗакрытогоЧата",e);const t=м_Настройки.Получить("чСостояниеЧата");t!==ЧАТ_ВЫГРУЖЕН&&t!==ЧАТ_СКРЫТ||t===e||(м_Настройки.Изменить("чСостояниеЧата",e),a())},"ПереключитьСостояниеПанели":function(){const e=м_ПолноэкранныйРежим.Включен();switch(м_Настройки.Получить("чСостояниеЧата")){case ЧАТ_ВЫГРУЖЕН:case ЧАТ_СКРЫТ:м_Настройки.Изменить("чСостояниеЧата",ЧАТ_ПАНЕЛЬ,e);break;case ЧАТ_ПАНЕЛЬ:м_Настройки.Изменить("чСостояниеЧата",e?ЧАТ_СКРЫТ:м_Настройки.Получить("чСостояниеЗакрытогоЧата"),e);break;default:Проверить(!1)}a()},"ПереключитьПоложениеПанели":function(){let e;switch(м_Настройки.Получить("лАвтоПоложениеЧата")?(м_Настройки.Изменить("лАвтоПоложениеЧата",!1),e=r()):e=м_Настройки.Получить("чПоложениеПанелиЧата"),e){case ВЕРХНЯЯ_СТОРОНА:м_Настройки.Изменить("чПоложениеПанелиЧата",ПРАВАЯ_СТОРОНА);break;case ПРАВАЯ_СТОРОНА:м_Настройки.Изменить("чПоложениеПанелиЧата",НИЖНЯЯ_СТОРОНА);break;case НИЖНЯЯ_СТОРОНА:м_Настройки.Изменить("чПоложениеПанелиЧата",ЛЕВАЯ_СТОРОНА);break;case ЛЕВАЯ_СТОРОНА:м_Настройки.Изменить("чПоложениеПанелиЧата",ВЕРХНЯЯ_СТОРОНА);break;default:Проверить(!1)}c()},"ОткрытьБоковуюПанель":function(){if(t){м_Настройки.Изменить("чСостояниеЧата",ЧАТ_ВЫГРУЖЕН,!0),a();const e=м_Twitch.ПолучитьАдресПанелиЧата();м_Журнал.Окак(`[Чат] Открываю боковую панель ${e}`),_(e,""===n?"":Текст("J0137",n))}}}})(),м_Шкала=(()=>{let e,t=0,n=0;function r(e){return Ограничить(e,t,n)}const i=ДобавитьОбработчикИсключений(e=>{if(м_Управление.ПолучитьСостояние()!==СОСТОЯНИЕ_ПОВТОР)return;const i=e.currentTarget.getBoundingClientRect(),o=getComputedStyle(e.currentTarget),s=Math.round(i.left+Number.parseFloat(o.paddingLeft)),a=Math.round(i.right-Number.parseFloat(o.paddingRight)),c=r((e.clientX+1-s)/(a-s)*(n-t)+t);м_Журнал.Окак(`[Шкала] Перематываю до ${c}`),м_Проигрыватель.ПеремотатьПовторДо(c)});return{"ЗадатьНачалоИКонец":function(e,r){Проверить(e<=r),t=e,n=r,document.getElementById("шкала").addEventListener("click",i)},"ЗадатьПросмотрено":function(i){e=r(i),Проверить(Number.isFinite(t)&&Number.isFinite(n)&&Number.isFinite(e)),document.getElementById("шкала-просмотрено").style.transform=`scaleX(${((e-t)/(n-t)).toFixed(4)})`},"ПолучитьНачало":function(){return t},"ПолучитьКонец":function(){return n}}})(),м_Окна=(()=>{function e(){return document.body.getAttribute("data-окно-открыто")||""}function t(e){const t=Узел(e);Проверить(t.classList.contains("окно")),t.classList.remove("окнооткрыто"),document.body.removeAttribute("data-окно-открыто"),м_События.ОбработатьСобытие("окна-закрыто",e)}function n(n){Проверить(ЭтоНепустаяСтрока(n));const r=e();return n!==r&&(r&&t(r),function(e){const t=Узел(e);Проверить(t.classList.contains("окно")),t.classList.add("окнооткрыто"),document.body.setAttribute("data-окно-открыто",e),м_События.ОбработатьСобытие(`окна-открыто-${e}`)}(n),!0)}function r(e){n(e)||t(e)}return м_События.ДобавитьОбработчик("управление-левыйщелчок",function({target:n}){if(Узел("проигрыватель").contains(n)){const i=n.getAttribute("data-окно-переключить");if(i)r(i);else{const r=e();r&&!Узел(r).contains(n)&&t(r)}}}),{"ПолучитьОткрытое":e,"Открыть":n,"Закрыть":function(n){return Проверить("string"==typeof n),!(!n||n!==e()||(t(n),0))},"Переключить":r}})(),м_Меню=(()=>{function e(){return document.getElementsByClassName("менюоткрыто")[0]}function t(e){Проверить(e.id),Проверить(e.classList.contains("меню")),document.body.classList.remove("меню-безанимации"),document.body.classList.add("меню-открыто"),e.classList.add("менюоткрыто"),м_События.ОбработатьСобытие(`меню-открыто-${e.id}`)}function n(e,t){Проверить(e.classList.contains("меню")),document.body.classList.toggle("меню-безанимации",t),document.body.classList.remove("меню-открыто"),e.classList.remove("менюоткрыто")}function r(t){const r=e();r&&n(r,t)}const i=ДобавитьОбработчикИсключений(r=>{const i=e();if(i&&i.contains(r.target))return void(ЭтоСобытиеДляСсылки(r)||r.preventDefault());let o=null;ЭтотЭлементМожноВыделить(r.target)||(r.preventDefault(),o=Узел("главноеменю")),i&&i!==o&&n(i,!1),o&&(!function(e,t,n){const r=getComputedStyle(e),i=Number.parseFloat(r.width,10),o=Number.parseFloat(r.height,10),s=window.innerWidth,a=window.innerHeight;let c,_;c=t+i<=s?t+1.999:i<=t?t-i-.5:Math.max(s-i,0),_=n+o<=a?n+1.999:Math.max(a-o,0),e.style.left=`${c}px`,e.style.top=`${_}px`}(o,r.clientX,r.clientY),o!==i&&t(o))});return document.documentElement.addEventListener("contextmenu",i),м_События.ДобавитьОбработчик("управление-левыйщелчок",function({target:r}){if(r.classList.contains("меню-пункт"))return void n(r.parentNode,!0);const i=e();i&&!i.contains(r)&&n(i,!1);const o=r.getAttribute("data-меню-переключить");if(o){const e=Узел(o);e!==i&&(function(e,t){const{left:n,top:r,right:i,bottom:o}=t.getBoundingClientRect(),s=getComputedStyle(e),a=Number.parseFloat(s.width,10),c=Number.parseFloat(s.height,10),_=window.innerWidth,u=window.innerHeight;let l,d;l=n+a<=_?n:a<=i?i-a:Math.max(_-a,0),d=o+c<=u?o:c<=r?r-c:Math.max(u-c,0),e.style.left=`${l}px`,e.style.top=`${d}px`,e.style.minWidth=`${i-n}px`}(e,r),t(e))}}),м_События.ДобавитьОбработчик("полноэкранныйрежим-изменен",function(e){r(!0)}),{"Закрыть":r}})(),м_ПолноэкранныйРежим=(()=>{let e="requestFullscreen",t="exitFullscreen",n="fullscreenElement",r="fullscreenchange";document.requestFullscreen||(e="webkitRequestFullscreen",t="webkitExitFullscreen",n="webkitFullscreenElement",r="webkitfullscreenchange");const i=ДобавитьОбработчикИсключений(()=>{const e=a();м_События.ОбработатьСобытие("полноэкранныйрежим-изменен",e)}),o=ДобавитьОбработчикИсключений(e=>{0===e.button&&"проигрыватель"===e.target.id&&(e.preventDefault(),_())});function s(){return!!document[n]}function a(){const e=s();return м_Журнал.Окак(`[ПолноэкранныйРежим] Текущее состояние: ${e}`),ИзменитьКнопку("переключитьполноэкранный",e),e}function c(){return!!s()&&(м_Журнал.Вот("[ПолноэкранныйРежим] Выход из полноэкранного режима"),м_Автоскрытие.Скрыть(!0),document[t](),!0)}function _(){!s()&&(м_Журнал.Вот("[ПолноэкранныйРежим] Вход в полноэкранный режим"),м_Автоскрытие.Скрыть(!0),document.getElementById("проигрывательичат")[e](),1)||c()}return document.addEventListener(r,i),document.addEventListener("dblclick",o),a(),{"Включен":s,"Отключить":c,"Переключить":_}})(),м_Уведомление=(()=>{const e=2e3;let t=0;function n(n,i){Проверить(document.getElementById(n)&&"boolean"==typeof i);const o=document.getElementById("уведомление");o.classList.toggle("жопа",i),o.firstElementChild.setAttributeNS("http://www.w3.org/1999/xlink","href",`#${n}`),ПоказатьЭлемент(o,!0),0!==t&&clearTimeout(t),t=setTimeout(r,e)}const r=ДобавитьОбработчикИсключений(()=>{ПоказатьЭлемент("уведомление",!1),t=0});return{"Показать":n,"ПоказатьСчастье":function(){n("svg-success",!1)},"ПоказатьЖопу":function(){n("svg-fail",!0)}}})(),м_Автоскрытие=(()=>{const e=90,t=300,n=document.getElementById("проигрыватель");let r,i,o,s,a,c=0,_=0,u=0;const l=ДобавитьОбработчикИсключений(()=>{Проверить(0!==c);const e=r-performance.now();e>100?(c=setTimeout(l,e),r=0):f(!1)});function d(){0===c?(document.body.classList.remove("автоскрытие","панель-безанимации"),c=setTimeout(l,1e3*м_Настройки.Получить("чИнтервалАвтоскрытия")),r=0):r=performance.now()+1e3*м_Настройки.Получить("чИнтервалАвтоскрытия")}function f(e){0!==c&&(clearTimeout(c),c=0,document.body.classList.add("автоскрытие"),document.body.classList.toggle("панель-безанимации",e),e&&(_=u=0))}const h=ДобавитьОбработчикИсключений(r=>{n.removeEventListener("mousemove",h),setTimeout(m,95),function(n){if(!(i===n.screenX&&o===n.screenY||s===n.clientX&&a===n.clientY)){i=n.screenX,o=n.screenY,s=n.clientX,a=n.clientY;const r=n.timeStamp;r-u>=t?_=r:r-_>=e&&d(),u=r}}(r)}),m=ДобавитьОбработчикИсключений(()=>{n.addEventListener("mousemove",h)}),g=ДобавитьОбработчикИсключений(e=>{d()}),p=ДобавитьОбработчикИсключений(()=>{f(!1)});return{"Запустить":function(){m(),n.addEventListener("click",g),n.addEventListener("mouseleave",p)},"Скрыть":f,"Показать":d}})(),м_Управление=(()=>{const e="• • •",t={da:"Dansk",de:"Deutsch",en:"English","en-gb":"English (UK)",es:"Español","es-mx":"Español (Latinoamérica)",fr:"Français",it:"Italiano",hu:"Magyar",nl:"Nederlands",no:"Norsk",pl:"Polski",pt:"Português","pt-br":"Português (Brasil)",sk:"Slovenčina",fi:"Suomi",sv:"Svenska",vi:"Tiếng Việt",tr:"Türkçe",cs:"Čeština",el:"Ελληνικά",bg:"Български",ru:"Русский",ar:"العربية",th:"ภาษาไทย",zh:"中文","zh-cn":"简体中文","zh-tw":"繁體中文","zh-hk":"中文（香港）",ja:"日本語",ko:"한국어",hi:"हिंदी",ro:"Română",ase:"American Sign Language",asl:"American Sign Language"};let n,r,i,o,s,a,c,_;function u(){м_Настройки.Получить("лМенятьГромкостьКолесом")?(document.addEventListener("wheel",l),document.addEventListener("mousedown",d)):(document.removeEventListener("wheel",l),document.removeEventListener("mousedown",d))}const l=ДобавитьОбработчикИсключений(e=>{e.shiftKey||e.ctrlKey||e.altKey||e.metaKey||ЭлементВЭтойТочкеМожноПрокрутить(e.clientX,e.clientY)||(м_Журнал.Вот(`[Управление] Движение колеса deltaY=${e.deltaY} deltaMode=${e.deltaMode}`),e.preventDefault(),e.deltaY<0&&E(void 0,Math.min(м_Настройки.Получить("чГромкость2")+5,МАКСИМАЛЬНАЯ_ГРОМКОСТЬ)),e.deltaY>0&&E(void 0,Math.max(м_Настройки.Получить("чГромкость2")-3,МИНИМАЛЬНАЯ_ГРОМКОСТЬ)))}),d=ДобавитьОбработчикИсключений(e=>{1!==e.button||e.shiftKey||e.ctrlKey||e.altKey||e.metaKey||ЭтоСобытиеДляСсылки(e)||(e.preventDefault(),E(!м_Настройки.Получить("лПриглушить")))});function f(){Узел("глаз").classList.toggle("масштабировать",м_Настройки.Получить("лМасштабироватьИзображение"))}function h(){document.documentElement.style.fontSize=`${16*м_Настройки.Получить("чРазмерИнтерфейса")/100}px`}function m(){document.body.classList.toggle("санимацией",м_Настройки.Получить("лАнимацияИнтерфейса"))}function g(){return n!==СОСТОЯНИЕ_ОСТАНОВКА&&n!==СОСТОЯНИЕ_ПОВТОР&&(м_Журнал.Окак("[Управление] Останавливаю просмотр трансляции"),м_Список.Остановить(),м_Преобразователь.Остановить(),г_моОчередь.Очистить(),г_моОчередь.Добавить(new Сегмент(ОБРАБОТКА_ПРЕОБРАЗОВАН,СОСТОЯНИЕ_ПОВТОР)),м_Проигрыватель.ДобавитьСледующийСегмент(),!0)}function p(){g()||(м_Журнал.Окак("[Управление] Начинаю просмотр трансляции"),г_моОчередь.Очистить(),м_Проигрыватель.Перезагрузить(СОСТОЯНИЕ_ЗАПУСК),м_Список.Запустить())}function b(){м_Статистика.ОкноПоказано()?м_Статистика.ЗакрытьОкно():м_Статистика.ОткрытьОкно()}function y(){м_Twitch.СоздатьКлип()||м_Уведомление.ПоказатьЖопу()}function w(e){Проверить("string"==typeof e),""!==e?navigator.clipboard.writeText(e).then(()=>{м_Журнал.Вот("[Управление] Копирование в буфер обмена завершено"),м_Уведомление.ПоказатьСчастье()},e=>{м_Журнал.Ой(`[Управление] Ошибка при копировании в буфер обмена: ${e}`),м_Уведомление.ПоказатьЖопу()}).catch(м_Отладка.ПойманоИсключение):м_Уведомление.ПоказатьЖопу()}const v=ДобавитьОбработчикИсключений(e=>{E(!1,Number.parseFloat(e.target.value))});function E(e,t){Проверить(void 0!==e||void 0!==t),void 0!==e&&м_Настройки.Изменить("лПриглушить",e),void 0!==t&&м_Настройки.Изменить("чГромкость2",Math.round(t)),$(),м_Проигрыватель.ПрименитьНастройкиЗвука(),м_Автоскрытие.Показать()}function $(){document.getElementById("громкость").value=м_Настройки.Получить("чГромкость2"),ИзменитьКнопку("переключитьприглушить",м_Настройки.Получить("лПриглушить"))}function k(e){document.getElementById("зритель-подписка").classList.contains("обновляется")||м_Twitch.ИзменитьПодпискуЗрителяНаКанал(e)}const T=ДобавитьОбработчикИсключений(e=>{if(0!==e.button)return;const t=e.target;let r=t,i=r.id||r.name;switch(!i&&t.parentNode&&(i=(r=t.parentNode).id||r.name),e.узПозывной=r,e.сПозывной=i,м_События.ОбработатьСобытие("управление-левыйщелчок",e),i){case"переключитьтрансляцию":p();break;case"переключитьпаузу":n===СОСТОЯНИЕ_ПОВТОР&&м_Проигрыватель.ПереключитьПаузу();break;case"переключитьприглушить":E(!м_Настройки.Получить("лПриглушить"));break;case"переключитьчат":м_Чат.ПереключитьСостояниеПанели();break;case"создатьклип":y();break;case"переключитьполноэкранный":м_ПолноэкранныйРежим.Переключить();break;case"одновременныхзагрузок":Проверить(t.checked),м_Настройки.Изменить("кОдновременныхЗагрузок",Number.parseInt(t.value,10)),м_Статистика.ОчиститьИсторию();break;case"менятьгромкостьколесом":м_Настройки.Изменить("лМенятьГромкостьКолесом",t.checked),u();break;case"анимацияинтерфейса":м_Настройки.Изменить("лАнимацияИнтерфейса",t.checked),m();break;case"масштабироватьизображение":м_Настройки.Изменить("лМасштабироватьИзображение",t.checked),f();break;case"автоположениечата":м_Настройки.Изменить("лАвтоПоложениеЧата",t.checked),x(),м_Чат.ПрименитьПоложениеПанели();break;case"горизонтальноеположениечата":Проверить(t.checked),м_Настройки.Изменить("чГоризонтальноеПоложениеЧата",Number.parseInt(t.value,10)),м_Чат.ПрименитьПоложениеПанели();break;case"вертикальноеположениечата":Проверить(t.checked),м_Настройки.Изменить("чВертикальноеПоложениеЧата",Number.parseInt(t.value,10)),м_Чат.ПрименитьПоложениеПанели();break;case"положениечата":Проверить(t.checked),м_Настройки.Изменить("чПоложениеПанелиЧата",Number.parseInt(t.value,10)),м_Чат.ПрименитьПоложениеПанели();break;case"состояниезакрытогочата":Проверить(t.checked),м_Чат.СохранитьИПрименитьСостояниеЗакрытойПанели(Number.parseInt(t.value,10));break;case"переключитьстатистику":case"позиция-текст":b();break;case"открытьновости":case"открытьновости2":м_Новости.ОткрытьНовости();break;case"открытьсправку":м_Новости.ОткрытьСправку();break;case"отправитьотзыв":м_Отладка.ЗавершитьРаботуИОтправитьОтзыв();break;case"экспортнастроек":м_Настройки.Экспорт();break;case"импортнастроек":const o=document.getElementById("выборфайладляимпортанастроек");o.value="",o.click();break;case"сброситьнастройки":м_Настройки.Сбросить();break;case"проверкацвета":!function(e){document.body.classList.toggle("проверкацвета")?(document.body.classList.toggle("проверкацветафон",!e.shiftKey),м_Новости.ОткрытьСправку()):document.body.classList.remove("проверкацветафон")}(e);break;case"типтрансляции":Проверить("BUTTON"===t.nodeName),t.disabled||window.location.assign(t.getAttribute("data-адрес"));break;case"зритель-подписаться":k(ПОДПИСКА_УВЕДОМЛЯТЬ);break;case"зритель-отписаться":k(ПОДПИСКА_НЕОФОРМЛЕНА);break;case"зритель-уведомлять":k(t.checked?ПОДПИСКА_УВЕДОМЛЯТЬ:ПОДПИСКА_НЕУВЕДОМЛЯТЬ);break;case"открытьбоковуюпанель":м_Чат.ОткрытьБоковуюПанель();break;case"закрытьстатистику":м_Статистика.ЗакрытьОкно();break;case"копироватьадресзаписи":м_Журнал.Вот("[Управление] Копирую адрес записи в буфер обмена"),w(м_Twitch.ПолучитьАдресЗаписиДляТекущейПозиции());break;case"копироватьадресканала":м_Журнал.Вот("[Управление] Копирую адрес канала в буфер обмена"),w(м_Twitch.ПолучитьАдресКанала(!1));break;case"копироватьадрестрансляции":!function e(){e.лИдетВыполнение||(e.лИдетВыполнение=!0,м_Журнал.Окак("[Управление] Получаю адрес трансляции для копирования"),м_Twitch.ПолучитьАбсолютныйАдресСпискаВариантов(null,!0).then(t=>(м_Журнал.Вот("[Управление] Копирую адрес трансляции в буфер обмена"),navigator.clipboard.writeText(t).then(()=>{e.лИдетВыполнение=!1,м_Журнал.Вот("[Управление] Копирование в буфер обмена завершено"),м_Уведомление.ПоказатьСчастье(),м_Управление.ОстановитьПросмотрТрансляции()},e=>{throw`Ошибка при копировании в буфер обмена: ${e}`}))).catch(ДобавитьОбработчикИсключений(t=>{if(e.лИдетВыполнение=!1,"string"!=typeof t)throw t;м_Журнал.Ой(`[Управление] Ошибка при копировании адреса трансляции в буфер обмена: ${t}`),м_Уведомление.ПоказатьЖопу()})))}()}}),I=ДобавитьОбработчикИсключений(e=>{const t="keydown"===e.type,r=t&&!e.repeat;switch(e.keyCode+65536*e.shiftKey+e.ctrlKey*(1<<17)+e.altKey*(1<<18)+e.metaKey*(1<<19)){case 13:case 262157:r&&м_ПолноэкранныйРежим.Переключить();break;case 27:e.preventDefault(),r&&(м_Меню.Закрыть(!0),м_Окна.Закрыть(м_Окна.ПолучитьОткрытое()),м_Автоскрытие.Скрыть(!0));break;case 86:r&&м_Окна.Переключить("настройки");break;case 73:r&&м_Окна.Переключить("канал");break;case 83:r&&b();break;case 112:r&&м_Новости.ОткрытьСправку();break;case 67:case 45:r&&м_Чат.ПереключитьСостояниеПанели();break;case 65603:r&&м_Чат.ОткрытьБоковуюПанель();break;case 85:r&&(м_Чат.ПереключитьПоложениеПанели(),x());break;case 32:r&&(p(),м_Автоскрытие.Показать());break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:r&&n===СОСТОЯНИЕ_ПОВТОР&&(F((48===e.keyCode?58:e.keyCode)-53),м_Автоскрытие.Показать());break;case 187:case 107:r&&n===СОСТОЯНИЕ_ПОВТОР&&(F(1/0),м_Автоскрытие.Показать());break;case 189:case 109:r&&n===СОСТОЯНИЕ_ПОВТОР&&(F(-1/0),м_Автоскрытие.Показать());break;case 90:case 12:r&&n===СОСТОЯНИЕ_ПОВТОР&&(м_Проигрыватель.ПереключитьПаузу(),м_Автоскрытие.Показать());break;case 37:t&&n===СОСТОЯНИЕ_ПОВТОР&&(м_Журнал.Окак("[Управление] Перематываю на -5с"),м_Проигрыватель.ПеремотатьПовторНа(!1,-5),м_Автоскрытие.Показать());break;case 39:t&&n===СОСТОЯНИЕ_ПОВТОР&&(м_Журнал.Окак("[Управление] Перематываю на +5с"),м_Проигрыватель.ПеремотатьПовторНа(!1,5),м_Автоскрытие.Показать());break;case 65573:t&&n===СОСТОЯНИЕ_ПОВТОР&&(м_Журнал.Окак("[Управление] Перематываю на -5 кадров"),м_Проигрыватель.ПеремотатьПовторНа(!0,-5),м_Автоскрытие.Показать());break;case 65575:t&&n===СОСТОЯНИЕ_ПОВТОР&&(м_Журнал.Окак("[Управление] Перематываю на +1 кадр"),м_Проигрыватель.ПеремотатьПовторНа(!0,1),м_Автоскрытие.Показать());break;case 38:t&&E(!1,Math.min(м_Настройки.Получить("чГромкость2")+4,МАКСИМАЛЬНАЯ_ГРОМКОСТЬ));break;case 40:t&&E(!1,Math.max(м_Настройки.Получить("чГромкость2")-2,МИНИМАЛЬНАЯ_ГРОМКОСТЬ));break;case 33:r&&E(!1);break;case 34:r&&E(!0);break;case 77:r&&E(!м_Настройки.Получить("лПриглушить"));break;case 82:if(r){const e=м_Настройки.Получить("лМасштабироватьИзображение");м_Настройки.Изменить("лМасштабироватьИзображение",!e),x(),f(),м_Уведомление.Показать(`svg-fullscreen-${e}`,!1)}break;case 262232:r&&y();break;default:return}e.preventDefault()});function x(){document.querySelector(`input[name="одновременныхзагрузок"][value="${м_Настройки.Получить("кОдновременныхЗагрузок")}"]`).checked=!0,document.querySelector(`input[name="состояниезакрытогочата"][value="${м_Настройки.Получить("чСостояниеЗакрытогоЧата")}"]`).checked=!0,document.getElementById("адресчата").selectedIndex=м_Настройки.Получить("лПолноценныйЧат")?0:м_Настройки.Получить("лЗатемнитьЧат")?2:1,document.getElementById("масштабироватьизображение").checked=м_Настройки.Получить("лМасштабироватьИзображение"),document.getElementById("менятьгромкостьколесом").checked=м_Настройки.Получить("лМенятьГромкостьКолесом"),document.getElementById("анимацияинтерфейса").checked=м_Настройки.Получить("лАнимацияИнтерфейса");const e=м_Настройки.Получить("лАвтоПоложениеЧата");document.getElementById("автоположениечата").checked=e;const t=document.querySelectorAll(".положениечата input");if(e){const e=м_Настройки.Получить("чГоризонтальноеПоложениеЧата"),n=м_Настройки.Получить("чВертикальноеПоложениеЧата");let r,i;for(let o of t){const t=Number.parseInt(o.value,10);e===t&&(r=o),n===t&&(i=o),o.name=t===ПРАВАЯ_СТОРОНА||t===ЛЕВАЯ_СТОРОНА?"горизонтальноеположениечата":"вертикальноеположениечата"}r.checked=i.checked=!0}else{const e=м_Настройки.Получить("чПоложениеПанелиЧата");let n;for(let r of t)e===Number.parseInt(r.value,10)&&(n=r),r.name="положениечата";n.checked=!0}r?(r.Обновить(),i.Обновить(),o.Обновить(),s.Обновить(),a.Обновить(),c.Обновить(),_.Обновить()):(r=new ВводЧисла("чНачалоВоспроизведения",.5,1,"началовоспроизведения"),i=new ВводЧисла("чРазмерБуфера",.5,1,"размербуфера"),o=new ВводЧисла("чРастягиваниеБуфера",.5,1,"растягиваниебуфера"),s=new ВводЧисла("чИнтервалОпроса",10,0,"интервалопроса"),a=new ВводЧисла("чДлительностьПовтора2",30,0,"длительностьповтора"),r.ПослеИзменения=i.ПослеИзменения=o.ПослеИзменения=s.ПослеИзменения=м_Статистика.ОчиститьИсторию,(c=new ВводЧисла("чРазмерИнтерфейса",1,0,"размеринтерфейса")).ПослеИзменения=h,_=new ВводЧисла("чИнтервалАвтоскрытия",.5,1,"интервалавтоскрытия"))}function S(){Узел("копироватьадресзаписи").tabIndex=м_Twitch.ПолучитьАдресЗаписиДляТекущейПозиции()?0:-1}function N(e){ИзменитьКнопку("переключитьпаузу",e)}function L(){x(),м_Статистика.ОчиститьИсторию()}function C(){const e=Узел("скорость");м_Журнал.Окак(`[Управление] Выбрана скорость ${e.value}`);const t=Number.parseFloat(e.value);return Проверить(Number.isFinite(t)&&t>=0),t}function F(e){Проверить(ЭтоЧисло(e));const t=Узел("скорость");let n;Проверить(t.selectedIndex>=0),(n=e===-1/0||e===1/0?t.selectedIndex-Math.sign(e):t.querySelector('option[value="1.00"]').index-e)>=0&&n<t.length&&n!==t.selectedIndex&&(t.selectedIndex=n,м_Проигрыватель.ЗадатьСкоростьПовтора(C()))}const M=ДобавитьОбработчикИсключений(e=>{n===СОСТОЯНИЕ_ПОВТОР&&м_Проигрыватель.ЗадатьСкоростьПовтора(C())}),A=ДобавитьОбработчикИсключений(e=>{м_Журнал.Окак(`[Управление] Выбран вариант ${e.target.value}`),Проверить(e.target.value),м_Настройки.Изменить("сНазваниеВарианта",e.target.value),м_Список.ИзменитьВариантТрансляции()}),B=ДобавитьОбработчикИсключений(e=>{switch(м_Журнал.Окак(`[Управление] Выбран адрес чата ${e.target.selectedIndex}`),e.target.selectedIndex){case 0:м_Настройки.Изменить("лПолноценныйЧат",!0);break;case 1:м_Настройки.Изменить("лПолноценныйЧат",!1),м_Настройки.Изменить("лЗатемнитьЧат",!1);break;case 2:м_Настройки.Изменить("лПолноценныйЧат",!1),м_Настройки.Изменить("лЗатемнитьЧат",!0);break;default:Проверить(!1)}м_Чат.ПрименитьАдрес()}),D=ДобавитьОбработчикИсключений(e=>{1===e.target.files.length&&м_Настройки.Импорт(e.target.files[0])});function X([e,t]){const n=document.getElementById("варианттрансляции");if(n.length=0,e)for(let r=0;r<e.length;++r){let i=e[r].сНазвание;i.endsWith("(source)")&&(i=i.slice(0,-8)+Текст("J0139")),n.add(new Option(i,e[r].сИдентификатор,r===t,r===t))}n.disabled=n.length<2}function O(){м_Уведомление.Показать("svg-cut",!0)}function R(t){if(Проверить(Number.isInteger(t)),t!==n){switch(м_Журнал.Вот(`[Управление] Состояние трансляции изменилось с ${n} на ${t}`),м_События.ОбработатьСобытие("управление-изменилосьсостояние",t),document.body.setAttribute("data-состояние",t),ИзменитьКнопку("переключитьтрансляцию",t===СОСТОЯНИЕ_ОСТАНОВКА||t===СОСТОЯНИЕ_ПОВТОР),document.getElementById("создатьклип").disabled=t===СОСТОЯНИЕ_ЗАПУСК||t===СОСТОЯНИЕ_НАЧАЛО_ТРАНСЛЯЦИИ||t===СОСТОЯНИЕ_ЗАВЕРШЕНИЕ_ТРАНСЛЯЦИИ,t){case СОСТОЯНИЕ_ЗАПУСК:H({"лЗапись":null,"сАдресЗаписи":"","сНазваниеТрансляции":e,"сНазваниеИгры":null,"сАдресИгры":null,"кЗрителей":null,"чДлительностьТрансляции":null}),м_Twitch.ЗавершитьСборМетаданныхТрансляции(!0);break;case СОСТОЯНИЕ_НАЧАЛО_ТРАНСЛЯЦИИ:H({"лЗапись":null,"сАдресЗаписи":"","сНазваниеТрансляции":e,"сНазваниеИгры":null,"сАдресИгры":null,"кЗрителей":null,"чДлительностьТрансляции":null}),м_Twitch.НачатьСборМетаданныхТрансляции();break;case СОСТОЯНИЕ_ЗАВЕРШЕНИЕ_ТРАНСЛЯЦИИ:H({"лЗапись":null,"сАдресЗаписи":"","сНазваниеТрансляции":Текст("J0100"),"сАдресИгры":null,"кЗрителей":null,"чДлительностьТрансляции":null}),м_Twitch.ЗавершитьСборМетаданныхТрансляции(!0);break;case СОСТОЯНИЕ_ЗАГРУЗКА:case СОСТОЯНИЕ_НАЧАЛО_ВОСПРОИЗВЕДЕНИЯ:case СОСТОЯНИЕ_ВОСПРОИЗВЕДЕНИЕ:break;case СОСТОЯНИЕ_ОСТАНОВКА:case СОСТОЯНИЕ_ПОВТОР:H({"кЗрителей":null}),м_Twitch.ЗавершитьСборМетаданныхТрансляции(!1);break;default:Проверить(!1)}n=t}}function P(e){if(void 0!==e.сИмя&&(ИзменитьЗаголовокДокумента(`${e.сИмя} - Alternate Player for Twitch.tv`),document.getElementById("канал-имя").textContent=e.сИмя),void 0!==e.сАватар&&(Проверить(e.сАватар),document.getElementById("канал-аватар").src=e.сАватар),void 0!==e.сОписание&&(document.getElementById("канал-описание").textContent=e.сОписание||""),void 0!==e.сКодЯзыка){const n=document.getElementById("канал-язык");if(e.сКодЯзыка){const r=t[e.сКодЯзыка.toLowerCase()];if(!r)throw new Error(`Неизвестный язык: ${e.сКодЯзыка}`);n.textContent=r,ПоказатьЭлемент(n.parentNode,!0)}else ПоказатьЭлемент(n.parentNode,!1)}void 0!==e.кПодписчиков&&(document.getElementById("канал-подписчиков").textContent=м_i18n.ФорматироватьЧисло(e.кПодписчиков)),void 0!==e.кПросмотров&&(document.getElementById("канал-просмотров").textContent=м_i18n.ФорматироватьЧисло(e.кПросмотров)),void 0!==e.дКаналСоздан&&(document.getElementById("канал-создан").textContent=e.дКаналСоздан.toLocaleDateString()),J(e.моСообщества,"канал-сообщества"),J(e.моКоманды,"канал-команды")}function J(e,t){if(void 0===e)return;const n=Узел(t);if(0===e.length)ПоказатьЭлемент(n.parentNode,!1);else{const t=document.createDocumentFragment();for(let n,r=0;n=e[r];++r){0!==r&&t.appendChild(document.createTextNode(", ")),Проверить(n.сАдрес&&n.сИмя);const e=document.createElement("a");e.href=n.сАдрес,e.rel="noopener noreferrer",e.target="_blank",n.сОписание&&(e.className="канал-ссылка",e.title=n.сОписание),e.appendChild(document.createTextNode(n.сИмя)),t.appendChild(e)}n.textContent="",n.appendChild(t),ПоказатьЭлемент(n.parentNode,!0)}}function U(e){if(void 0!==e.сИмя&&(""!==e.сИмя?document.getElementById("зритель-имя").textContent=e.сИмя:м_i18n.InsertAdjacentHtmlMessage(document.getElementById("зритель-имя"),"content","F0590")),void 0!==e.чПодписка){const t=document.getElementById("зритель-подписка");e.чПодписка===ПОДПИСКА_ОБНОВЛЯЕТСЯ?t.classList.add("обновляется"):(t.classList.remove("обновляется"),t.setAttribute("data-подписка",e.чПодписка),document.getElementById("зритель-уведомлять").checked=e.чПодписка===ПОДПИСКА_УВЕДОМЛЯТЬ)}}function H(e){if(void 0!==e.лЗапись){const t=Узел("типтрансляции");null===e.лЗапись?ПоказатьЭлемент(t,!1):(ИзменитьКнопку(t,e.лЗапись),e.сАдресЗаписи?(t.setAttribute("data-адрес",e.сАдресЗаписи),t.disabled=!1):t.disabled=!0,ПоказатьЭлемент(t,!0))}if(void 0!==e.сНазваниеТрансляции){const t=document.getElementById("названиетрансляции");null===e.сНазваниеТрансляции?ПоказатьЭлемент(t,!1):(t.lastElementChild.title=e.сНазваниеТрансляции+Текст("J0101"),t.lastElementChild.textContent=e.сНазваниеТрансляции,ПоказатьЭлемент(t,!0))}if(void 0!==e.сНазваниеИгры){const t=document.getElementById("названиеигры");null===e.сНазваниеИгры?ПоказатьЭлемент(t,!1):(t.lastElementChild.href=e.сАдресИгры,t.lastElementChild.title=e.сНазваниеИгры+Текст("J0102"),t.lastElementChild.textContent=e.сНазваниеИгры,ПоказатьЭлемент(t,!0))}if(void 0!==e.кЗрителей){const t=document.getElementById("количествозрителей");null===e.кЗрителей?ПоказатьЭлемент(t,!1):(t.lastElementChild.textContent=м_i18n.ФорматироватьЧисло(e.кЗрителей,0),ПоказатьЭлемент(t,!0))}void 0!==e.чДлительностьТрансляции&&(document.getElementById("позиция-текст").textContent=null===e.чДлительностьТрансляции?"":м_i18n.ПеревестиСекундыВСтроку(e.чДлительностьТрансляции/1e3,!1))}return{"Запустить":function(){Проверить(void 0===n),Узел("названиетрансляции").lastElementChild.href=м_Twitch.ПолучитьАдресКанала(!0);let e=document.getElementById("громкость");for(e of(e.min=МИНИМАЛЬНАЯ_ГРОМКОСТЬ,e.max=МАКСИМАЛЬНАЯ_ГРОМКОСТЬ,e.step=ШАГ_ИЗМЕНЕНИЯ_ГРОМКОСТИ_МЫШЬЮ,e.addEventListener("input",v),document.getElementById("скорость").children))e.text="1.00"===e.value?"1x":м_i18n.ФорматироватьЧисло(e.value,2);$(),x(),м_Автоскрытие.Запустить(),м_Автоскрытие.Показать(),м_Новости.Запустить(),м_Чат.Восстановить(),м_События.ДобавитьОбработчик("меню-открыто-главноеменю",S),м_События.ДобавитьОбработчик("список-выбранварианттрансляции",X),м_События.ДобавитьОбработчик("проигрыватель-переполненбуфер",O),м_События.ДобавитьОбработчик("проигрыватель-пауза",N),м_События.ДобавитьОбработчик("настройки-измениласьпредустановка-буферизация",L),м_События.ДобавитьОбработчик("twitch-полученыметаданныеканала",P),м_События.ДобавитьОбработчик("twitch-полученыметаданныезрителя",U),м_События.ДобавитьОбработчик("twitch-полученыметаданныетрансляции",H),document.documentElement.addEventListener("click",T),document.addEventListener("keydown",I),document.addEventListener("keyup",I),document.getElementById("скорость").addEventListener("change",M),document.getElementById("варианттрансляции").addEventListener("change",A),document.getElementById("адресчата").addEventListener("change",B),document.getElementById("выборфайладляимпортанастроек").addEventListener("change",D),u(),R(СОСТОЯНИЕ_ЗАПУСК),f(),h(),m(),м_Оформление.Запустить()},"ПолучитьСостояние":function(){return Проверить(void 0!==n),n},"ИзменитьСостояние":R,"ПолучитьСкоростьВоспроизведения":C,"ОбновитьНастройкиЗвука":$,"ОстановитьПросмотрТрансляции":g}})();{const e=document.getElementById("глаз");function ЭтоНастоящееАудиоустройство(e){return"default"!==e&&"communications"!==e}function ПолучитьИдТекущегоАудиоустройства(){Проверить(e.parentNode);const t=e.sinkId;return м_Журнал.Вот(`[Аудиоустройства] Текущее аудиоустройство: ${t}`),""!==t?t:"default"}function ОбновитьСписокАудиоустройств(){const e=document.getElementById("аудиоустройства-список");e.length=0,м_Журнал.Окак("[Аудиоустройства] Получаю список медиаустройств"),navigator.mediaDevices.enumerateDevices().then(n=>{м_Журнал.Вот(`[Аудиоустройства] Найдено медиаустройств: ${n.length}`);let r=0,i=0;for(let t of n)м_Журнал.Вот(`[Аудиоустройства] Найдено медиаустройство kind=${t.kind} deviceId=${t.deviceId} groupId=${t.groupId} label=${t.label}`),"audiooutput"===t.kind&&(++r,ЭтоНастоящееАудиоустройство(t.deviceId)&&++i,""!==t.label&&e.add(new Option(t.label,t.deviceId,!1,!1)));if(e.value=ПолучитьИдТекущегоАудиоустройства(),0===e.length&&0!==r){if(chrome.extension.inIncognitoContext)return void ПоказатьЭлемент("аудиоустройства",!1);ПоказатьЭлемент("аудиоустройства-доступ",!0),ПоказатьЭлемент(e,!1),м_События.ДобавитьОбработчик("управление-левыйщелчок",ОбработатьПолучениеДоступа)}else ПоказатьЭлемент("аудиоустройства-доступ",!1),ПоказатьЭлемент(e,!0),e.addEventListener("change",t);i>1&&ПоказатьЭлемент("аудиоустройства",!0)},e=>{м_Журнал.Ой(`[Аудиоустройства] Не удалось получить список медиаустройств: ${e}`)}).catch(м_Отладка.ПойманоИсключение)}function ОбработатьПолучениеДоступа({"сПозывной":e}){"аудиоустройства-доступ"===e&&(м_Журнал.Окак("[Аудиоустройства] Запрашиваю разрешение contentSettings"),chrome.permissions.request({permissions:["contentSettings"]},ДобавитьОбработчикИсключений(e=>{e?(м_Журнал.Окак("[Аудиоустройства] Даю расширению доступ к аудиоустройствам"),chrome.contentSettings.microphone.set({primaryPattern:`*://${chrome.runtime.id}/*`,setting:"allow",scope:chrome.extension.inIncognitoContext?"incognito_session_only":"regular"},ДобавитьОбработчикИсключений(()=>{chrome.runtime.lastError&&м_Журнал.Ой(`[Аудиоустройства] Не удалось дать доступ: ${chrome.runtime.lastError.message}`),ОбновитьСписокАудиоустройств()}))):м_Журнал.Ой(`[Аудиоустройства] Разрешение не получено: ${chrome.runtime.lastError?chrome.runtime.lastError.message:""}`)})))}const t=ДобавитьОбработчикИсключений(t=>{-1!==t.target.selectedIndex&&(м_Журнал.Окак(`[Аудиоустройства] Меняю аудиоустройство с ${e.sinkId} на ${t.target.value} (${t.target.selectedOptions[0].text})`),e.setSinkId(t.target.value).then(()=>{м_Журнал.Окак(`[Аудиоустройства] Аудиоустройство изменено на ${e.sinkId}`)},e=>{м_Журнал.Ой(`[Аудиоустройства] Не удалось изменить аудиоустройство: ${e}`),ОбновитьСписокАудиоустройств()}).catch(м_Отладка.ПойманоИсключение))});void 0===e.setSinkId?м_Журнал.Ой("[Аудиоустройства] Браузер не поддерживает MediaElement.setSinkId"):(void 0===navigator.mediaDevices.addEventListener?м_Журнал.Ой("[Аудиоустройства] Браузер не поддерживает mediaDevices.ondevicechange"):navigator.mediaDevices.addEventListener("devicechange",ДобавитьОбработчикИсключений(ОбновитьСписокАудиоустройств)),ОбновитьСписокАудиоустройств())}const м_Проигрыватель=(()=>{const e=10,t=.28,n=1,r=-1,i=-2,o=-3,s=-4,a=0,c=1,_=2;let u,l,d=null,f=0,h=!1,m="чНачалоВоспроизведения",g=!0,p=0,b=!1;const y={"ОбработатьSourceOpen"(){Проверить(u.paused),f=Math.max(f,1),B()},"ОбработатьProgress"(){h||F(C(r))},"ОбработатьWaiting"(){},"ОбработатьPlaying"(){м_Управление.ПолучитьСостояние()!==СОСТОЯНИЕ_НАЧАЛО_ВОСПРОИЗВЕДЕНИЯ||u.paused||м_Управление.ИзменитьСостояние(СОСТОЯНИЕ_ВОСПРОИЗВЕДЕНИЕ)},"ОбработатьSeeking":ЗАГЛУШКА,"ОбработатьSeeked":F,"ОбработатьEnded"(){x(СОСТОЯНИЕ_ЗАГРУЗКА)},"ОбработатьTimeUpdate"(){u.seeking||u.paused||u.ended||C(o)}},w={"лПауза":!0,"ОбработатьSourceOpen"(){Проверить(u.paused),f=Math.max(f,1)},"ОбработатьProgress":ЗАГЛУШКА,"ОбработатьWaiting":ЗАГЛУШКА,"ОбработатьPlaying":ЗАГЛУШКА,"ОбработатьSeeked":ЗАГЛУШКА,"ОбработатьSeeking"(){м_Шкала.ЗадатьПросмотрено(u.currentTime)},"ОбработатьEnded"(){this.лПауза||u.play()},"ОбработатьTimeUpdate"(){this.лПауза||u.seeking||this.ПроверитьПозициюВоспроизведения(o),м_Шкала.ЗадатьПросмотрено(u.currentTime)},"ПроверитьПозициюВоспроизведения"(e){Проверить(Number.isFinite(e)),Проверить(e===i||e===o||e>=0);const n=u.buffered,r=n.length-1,s=u.currentTime+1e-4;let a=e>=0?e:s,c="";for(let i=!1;;){let s=e===o?t:МИН_РАЗМЕР_БУФЕРА;for(let e=0;e<=r&&(a<n.start(e)&&(s=МИН_РАЗМЕР_БУФЕРА,c+="Перепрыгиваю яму. ",a=n.start(e)),!(n.end(e)-a>=s));++e);if(this.лПауза||a<м_Шкала.ПолучитьКонец())break;if(i)return void E("Ой",`Бесконечная перемотка Время=${e}`);a=м_Шкала.ПолучитьНачало(),c+="Начинаю сначала. ",i=!0}a!==s&&(E("Окак",`${c}Перематываю до ${a}`),u.currentTime=a)}};let v=y;function E(e,t){const n=0!==l.sourceBuffers.length?l.sourceBuffers[0]:null,r=$(n?n.buffered:null),i=$(u.buffered),o=r===i;"Вот"===e&&(n&&n.buffered.length>1||u.buffered.length>1)&&(e="Окак"),!u.error&&o||(e="Ой"),м_Журнал[e](`${"["===t.charAt(0)?"":"[Проигрыватель] "}${t} •••`+(n&&n.updating?" [U]":"")+(u.paused?" [P]":"")+(u.seeking?" [S]":"")+(u.ended?" [E]":"")+(u.error?` error=${u.error.code}`:"")+(u.src.startsWith("blob:")||u.src.startsWith("mediasource:")?"":` src=${u.src}`)+("open"===l.readyState?"":` MSE.readyState=${l.readyState}`)+(1===l.sourceBuffers.length?"":` MSE.buffers=${l.sourceBuffers.length}`)+(u.networkState===HTMLMediaElement.NETWORK_LOADING?"":` networkState=${u.networkState}`)+` readyState=${u.readyState}`+` currentTime=${u.currentTime}`+(o?` buffered=${i}`:` MSE.buffered=${r} buffered=${i}`)+(u.duration===1/0?"":` duration=${u.duration}`)+` seekable=${$(u.seekable)}`+` played=${$(u.played)}`)}function $(e){let t="";if(e&&0!==e.length){let n=Math.max(e.length-20,0);for(0!==n&&(t=`[${n}]`);n<e.length;++n)0!==n&&(t+=`(${(e.start(n)-e.end(n-1)).toFixed(3)})`),t+=`${e.start(n)}-${e.end(n)}`}return t}function k(e=u.buffered){let t=0,n=0;if(0!==e.length){const r=e.start(0),i=e.end(e.length-1),o=Ограничить(u.currentTime,r,i);t=o-r,n=i-o}return{"чПросмотрено":t,"чНеПросмотрено":n}}function T(){u.volume=м_Настройки.Получить("чГромкость2")/МАКСИМАЛЬНАЯ_ГРОМКОСТЬ,u.muted=м_Настройки.Получить("лПриглушить")}function I(e){g=!0,x(e)}function x(e){E("Окак","Перезагрузка проигрывателя"),м_Управление.ИзменитьСостояние(e),v=y,d=null,b=!1,u.load()}function S(){u.error&&м_Отладка.ЗавершитьРаботуИПоказатьСообщение("J0206")}const N=ДобавитьОбработчикИсключений(e=>{S();const t=`[MediaSource] ${e.type}`;switch(e.type){case"sourceopen":E("Вот",t),v.ОбработатьSourceOpen();break;case"sourceended":case"sourceclose":E("Вот",t);break;default:м_Журнал.Вот(t)}}),L=ДобавитьОбработчикИсключений(e=>{S();const t=`[MediaElement] ${e.type}`;switch(e.type){case"loadstart":E("Вот",`${t} src=${u.src} currentSrc=${u.currentSrc}`);break;case"progress":E("Вот",t),v.ОбработатьProgress();break;case"abort":E("Вот",t);break;case"waiting":E("Окак",t),v.ОбработатьWaiting();break;case"playing":E("Вот",t),v.ОбработатьPlaying();break;case"seeking":E("Вот",t),v.ОбработатьSeeking();break;case"seeked":E("Вот",t),v.ОбработатьSeeked();break;case"ended":E("Вот",t),v.ОбработатьEnded();break;case"timeupdate":м_Журнал.Вот(`${t} readyState=${u.readyState} currentTime=${u.currentTime} НеПросмотрено=${м_Журнал.F2(k().чНеПросмотрено)}`),v.ОбработатьTimeUpdate();break;case"canplay":fitVideo();break;case"volumechange":м_Журнал.Вот(`${t} volume=${u.volume} muted=${u.muted}`);break;default:м_Журнал.Вот(t)}});function C(e,n=0){const d=u.buffered,h=d.length-1;if(-1===h)return!1;const g=u.currentTime+1e-4;let p=Math.max(g,d.start(0)),y="";const w=d.end(h)-p;if(e===r){const e=м_Настройки.Получить("чМаксРазмерБуфера"),t=e+м_Настройки.Получить("чРастягиваниеБуфера");if(w<=t)return;2===f&&м_События.ОбработатьСобытие("проигрыватель-переполненбуфер",w-e),y+=`Переполнен буфер проигрывателя ${w.toFixed(2)}с > ${t}с. `,p=d.end(h)-e-.1}if(e===i&&2!==f){f=2;const e=м_Настройки.Получить("чМаксРазмерБуфера")+м_Статистика.ПолучитьTargetDuration()/2;w>e&&(y+=`Превышена задержка трансляции ${w.toFixed(2)}с > ${e}с. `,p=d.end(h)-e)}Проверить(t<МИН_РАЗМЕР_БУФЕРА);let v,$=e===o?t:e===s?1/0:МИН_РАЗМЕР_БУФЕРА,k="ended"===l.readyState;for(let e=0;e<=h;++e)if(p<d.start(e)&&($=МИН_РАЗМЕР_БУФЕРА,y+="Перепрыгиваю яму. ",p=d.start(e)),(v=d.end(e)-p)>=$){k=!0;break}return k||u.paused||function(e,t,n){Проверить("ended"!==l.readyState),Проверить(e<МИН_РАЗМЕР_БУФЕРА);const r=t>1;м_Статистика.ИсчерпанБуферПроигрывателя(r),m="чМаксРазмерБуфера";const i=м_Настройки.Получить(m);e+n>=МИН_РАЗМЕР_БУФЕРА&&t+n>=i?E(r?"Ой":"Окак",`Буфер исчерпан, остановка не нужна БудетДобавлено=${м_Журнал.F3(n)}с ДоКонцаПоследнейОбласти=${м_Журнал.F3(e)}с НеПросмотрено=${м_Журнал.F3(t)}с РазмерБуфера=${i}с`):(E(r?"Ой":"Окак",`Приостанавливаю воспроизведение для заполнения буфера ДоКонцаПоследнейОбласти=${м_Журнал.F3(e)}с НеПросмотрено=${м_Журнал.F3(t)}с РазмерБуфера=${i}с`),b=!0,M(СОСТОЯНИЕ_ЗАГРУЗКА))}(v,w,n),!k&&e!==r||p===g&&!b?k?c:a:(p===g&&(p=u.currentTime),E(y?"Ой":"Окак",`${y}Перематываю до ${p}`),b=!1,u.currentTime=p,_)}function F(e){if(!u.seeking&&e!==_&&u.paused&&!u.ended){if(g&&"ended"!==l.readyState){const{"чНеПросмотрено":e}=k(),t=м_Настройки.Получить(m);if(e<t)return void м_Журнал.Вот(`[Проигрыватель] В буфере не просмотрено ${м_Журнал.F3(e)}с < ${t}с`);м_Журнал.Окак(`[Проигрыватель] В буфере не просмотрено ${м_Журнал.F3(e)}с >= ${t}с`)}else м_Журнал.Окак("[Проигрыватель] Не нужно ждать заполнения буфера");switch(C(i)){case a:E("Ой",`Не найдена область >= ${МИН_РАЗМЕР_БУФЕРА}с для начала воспроизведения`),g=!0;break;case c:E("Окак","Начало воспроизведения"),g=!0,u.play(),67!==ВЕРСИЯ_ДВИЖКА_БРАУЗЕРА||F.лБлокировкаСнята||!u.paused||u.muted||(E("Ой","[Проигрыватель] Приглушаю звук чтобы снять блокировку воспроизведения браузером"),u.muted=!0,u.play(),u.paused?(E("Ой","[Проигрыватель] Воспроизведение не началось. Восстанавливаю настройки звука."),u.muted=!1):(E("Вот","[Проигрыватель] Блокировка воспроизведения снята"),м_Настройки.Изменить("лПриглушить",!0,!0),м_Управление.ОбновитьНастройкиЗвука())),F.лБлокировкаСнята=!0,м_Управление.ИзменитьСостояние(СОСТОЯНИЕ_НАЧАЛО_ВОСПРОИЗВЕДЕНИЯ)}}}function M(e){void 0!==e&&м_Управление.ИзменитьСостояние(e),u.pause()}function A(e,t){return new Promise((n,r)=>{E("Вот",`Добавляю ${t?"сегмент инициализации":"медиасегмент"} ${e.чНомер}`),d.addEventListener("updateend",function t(){try{null===d?r(ОтменаОбещания.ОБЕЩАНИЕ_ОТМЕНЕНО):(i+=performance.now(),d.removeEventListener("updateend",t),E(i>100?"Ой":"Вот",`Добавлен сегмент ${e.чНомер} за ${м_Журнал.F0(i)}мс`),n())}catch(e){r(e)}});let i=-performance.now();d.appendBuffer(t?e.пДанные.мбСегментИнициализации:e.пДанные.мбМедиасегмент)})}function B(){Проверить(u),function(){for(let e=г_моОчередь.length;--e>=0;)if(г_моОчередь[e].пДанные===СОСТОЯНИЕ_СМЕНА_ВАРИАНТА&&г_моОчередь[e].чОбработка===ОБРАБОТКА_ПРЕОБРАЗОВАН){г_моОчередь.ПоказатьСостояние();do{г_моОчередь[e].пДанные!==СОСТОЯНИЕ_СМЕНА_ВАРИАНТА&&"number"==typeof г_моОчередь[e].пДанные||г_моОчередь.Удалить(e)}while(--e>=0);г_моОчередь.ПоказатьСостояние(),I(СОСТОЯНИЕ_ЗАГРУЗКА);break}}();const i=г_моОчередь[0];if(!i||i.чОбработка!==ОБРАБОТКА_ПРЕОБРАЗОВАН)return;if(Проверить(v===y),i.пДанные===СОСТОЯНИЕ_НАЧАЛО_ТРАНСЛЯЦИИ)return Проверить(0===l.sourceBuffers.length),м_Управление.ИзменитьСостояние(i.пДанные),г_моОчередь.Удалить(0),void B();if(h)return;if(i.пДанные===СОСТОЯНИЕ_ПОВТОР)return Проверить(м_Управление.ПолучитьСостояние()!==СОСТОЯНИЕ_ОСТАНОВКА&&м_Управление.ПолучитьСостояние()!==СОСТОЯНИЕ_ПОВТОР),function(){w.лПауза=!0,v=w,M(),0!==l.sourceBuffers.length&&"open"===l.readyState&&l.endOfStream();const{"чПросмотрено":e}=k();if(0===u.played.length||e<n)return E("Окак","Повторять нечего"),void м_Управление.ИзменитьСостояние(СОСТОЯНИЕ_ОСТАНОВКА);E("Окак","Запуск повтора"),u.playbackRate=м_Управление.ПолучитьСкоростьВоспроизведения(),м_События.ОбработатьСобытие("проигрыватель-пауза",w.лПауза),м_Шкала.ЗадатьНачалоИКонец(u.buffered.start(0),u.buffered.start(0)+e),м_Шкала.ЗадатьПросмотрено(u.currentTime),м_Управление.ИзменитьСостояние(СОСТОЯНИЕ_ПОВТОР)}(),г_моОчередь.Удалить(0),void B();const s=l.readyState;if("open"!==s)return м_Журнал.Вот(`[Проигрыватель] Добавление сегмента ${i.чНомер} отложено MediaSource.readyState=${s} MediaElement.src=${u.src}`),void("closed"===s&&0===f&&function(){const e=г_моОчередь.ПолучитьКоличествоПреобразованныхСегментов().чДлительность;e>=ПЕРЕПОЛНЕНИЕ_БУФЕРА&&(м_Журнал.Ой(`[Проигрыватель] MediaSource закрыт слишком долго ${e}с >= ${ПЕРЕПОЛНЕНИЕ_БУФЕРА}с`),Проверить(м_Управление.ПолучитьСостояние()===СОСТОЯНИЕ_ЗАПУСК||м_Управление.ПолучитьСостояние()===СОСТОЯНИЕ_НАЧАЛО_ТРАНСЛЯЦИИ),м_Управление.ОстановитьПросмотрТрансляции())}());if(i.лРазрыв&&0!==l.sourceBuffers.length)return void function(e){E("Окак",`Сегмент ${e.чНомер} вызвал окончание потока`),0===u.buffered.length||u.paused&&k().чНеПросмотрено<t+.1?I(СОСТОЯНИЕ_ЗАГРУЗКА):(g="number"==typeof e.пДанные||!u.seeking&&u.paused,l.endOfStream(),F())}(i);if(i.пДанные===СОСТОЯНИЕ_ЗАВЕРШЕНИЕ_ТРАНСЛЯЦИИ)return Проверить(i.лРазрыв&&0===l.sourceBuffers.length),м_Управление.ИзменитьСостояние(i.пДанные),г_моОчередь.Удалить(0),void B();0===l.sourceBuffers.length&&function(e){м_Журнал.Окак(`[Проигрыватель] Добавляю буфер ${e.пДанные.сКодеки}`),Проверить(e.лРазрыв&&e.пДанные.сКодеки);try{d=l.addSourceBuffer(e.пДанные.сКодеки)}catch(e){ЭтоОбъект(e)&&"NotSupportedError"===e.name?м_Отладка.ЗавершитьРаботуИПоказатьСообщение("J0201"):м_Отладка.ПойманоИсключение(e)}d.addEventListener("updatestart",N),d.addEventListener("update",N),d.addEventListener("updateend",N),d.addEventListener("abort",N),d.addEventListener("error",N)}(i),h=!0;let a=function(){const t=м_Настройки.Получить("чДлительностьПовтора2");if(t===АВТОНАСТРОЙКА)return Promise.resolve();const{"чПросмотрено":n,"чНеПросмотрено":r}=k(d.buffered);let i;return n<t+e?Promise.resolve():(i=u.currentTime-t,new Promise((e,t)=>{E("Вот",`Удаляю просмотренное видео Просмотрено=${м_Журнал.F3(n)}с УдалитьДо=${м_Журнал.F3(i)}с`),d.addEventListener("updateend",function n(){try{if(null===d)t(ОтменаОбещания.ОБЕЩАНИЕ_ОТМЕНЕНО);else{r+=performance.now(),d.removeEventListener("updateend",n);const{"чПросмотрено":t}=k(d.buffered);E(r>100||t<МИН_РАЗМЕР_БУФЕРА?"Ой":"Вот",`Просмотренное видео удалено за ${м_Журнал.F0(r)}мс Просмотрено=${м_Журнал.F0(t)}с`),e()}}catch(e){t(e)}});let r=-performance.now();d.remove(0,i)}))}().then(()=>{u.seeking||u.paused||u.ended||C(o,i.чДлительность)});i.пДанные.мбСегментИнициализации&&(a=a.then(()=>A(i,!0))),a.then(()=>A(i,!1)).then(()=>{if(h=!1,г_моОчередь.Удалить(i),!г_моОчередь[0]||г_моОчередь[0].пДанные!==СОСТОЯНИЕ_ПОВТОР){!function(e){if(!ЭтоЧисло(e.пДанные.чПозицияКодирования))return;const t=ЭтоЧисло(e.чTwitchПрошлоВремени)?e.чTwitchПрошлоВремени-e.пДанные.чПозицияКодирования:0,n=0===t||Math.abs(t-p)>1;м_Журнал[n?"Ой":"Вот"](`[Проигрыватель] Смещение начала трансляции ${м_Журнал.F1(t)}с`),p=t}(i);const e=C(r);г_моОчередь[0]&&г_моОчередь[0].чОбработка===ОБРАБОТКА_ПРЕОБРАЗОВАН||(F(e),function(){if(м_Статистика.ОкноПоказано()){const e=d.buffered;0!==e.length&&(Узел("статистика-продолжительностьтрансляции").textContent=м_i18n.ПеревестиСекундыВСтроку(e.end(e.length-1)+p,!0))}}(),function(e){if(м_Статистика.ОкноПоказано()){let t="";if(ЭтоЧисло(e.пДанные.чВремяКодирования)){const n=u.currentTime;if(0!==n){const r=(Date.now()-e.пДанные.чВремяКодирования)/1e3,i=e.пДанные.чПозицияКодирования-n;t=`${r.toFixed(1)} + ${i.toFixed(1)} = ${(r+i).toFixed(1)}`}}м_Журнал.Вот(`[Проигрыватель] Задержка трансляции ${t}с`),Узел("статистика-задержкатрансляции").textContent=t}}(i))}B()}).catch(ДобавитьОбработчикИсключений(e=>{if(h=!1,"ДОБАВЛЕНИЕ СЕГМЕНТА ОТЛОЖЕНО"!==e){if(e!==ОтменаОбещания.ОБЕЩАНИЕ_ОТМЕНЕНО)throw e;м_Журнал.Вот(`[Проигрыватель] Отменено добавление сегмента ${i.чНомер}`),г_моОчередь.Удалить(i)}}))}function D(e){Проверить(м_Управление.ПолучитьСостояние()===СОСТОЯНИЕ_ПОВТОР),w.ПроверитьПозициюВоспроизведения(e)}return{"Запустить":function(){Проверить(!u);try{l=new MediaSource}catch(e){м_Отладка.ЗавершитьРаботуИПоказатьСообщение("J0202")}l.addEventListener("sourceopen",N),l.addEventListener("sourceended",N),l.addEventListener("sourceclose",N),l.sourceBuffers.addEventListener("addsourcebuffer",N),l.sourceBuffers.addEventListener("removesourcebuffer",N),u=document.getElementById("глаз"),T();for(let e of["progress","error","playing","seeking","seeked","ended","timeupdate","waiting","loadstart","suspend","abort","emptied","stalled","loadedmetadata","loadeddata","canplay","canplaythrough","durationchange","play","pause","ratechange","resize"])u.addEventListener(e,L);return u.src=URL.createObjectURL(l),!0},"Остановить":function(){u&&(URL.revokeObjectURL(u.src),u.removeAttribute("src"),u.load())},"ПолучитьЗаполненностьБуфера":k,"ПолучитьКоличествоПропущенныхКадров":function(){return u.getVideoPlaybackQuality?u.getVideoPlaybackQuality():{totalVideoFrames:u.webkitDecodedFrameCount,droppedVideoFrames:u.webkitDroppedFrameCount}},"ПолучитьПозициюВоспроизведенияТрансляции":function(e){let t=u.currentTime;if(e&&м_Управление.ПолучитьСостояние()===СОСТОЯНИЕ_ПОВТОР&&(t=м_Шкала.ПолучитьКонец()),!e&&0===t&&null!==d){const e=d.buffered;0!==e.length&&(t=e.start(0))}return 0===t?-1:Math.max(t+p,0)},"ПоказатьСостояние":E,"Перезагрузить":I,"ПрименитьНастройкиЗвука":T,"ДобавитьСледующийСегмент":B,"ПеремотатьПовторДо":D,"ПеремотатьПовторНа":function(e,t){Проверить(м_Управление.ПолучитьСостояние()===СОСТОЯНИЕ_ПОВТОР),Проверить(Number.isFinite(t)),e&&(t*=м_Статистика.ПолучитьДлительностьКадраВСекундах().чМинимальная),0!==t&&D(Ограничить(u.currentTime+t,м_Шкала.ПолучитьНачало(),м_Шкала.ПолучитьКонец()))},"ПереключитьПаузу":function(){Проверить(м_Управление.ПолучитьСостояние()===СОСТОЯНИЕ_ПОВТОР),(w.лПауза=!w.лПауза)?(м_Журнал.Окак("[Проигрыватель] Ставлю повтор на паузу"),u.pause()):(м_Журнал.Окак("[Проигрыватель] Снимаю повтор с паузы"),w.ПроверитьПозициюВоспроизведения(i),u.play()),м_События.ОбработатьСобытие("проигрыватель-пауза",w.лПауза)},"ЗадатьСкоростьПовтора":function(e){Проверить(м_Управление.ПолучитьСостояние()===СОСТОЯНИЕ_ПОВТОР),u.playbackRate=e}}})(),м_Список=(()=>{const e=3e3,t=3e4,n=1e3,r=150;let i,o,s=СОСТОЯНИЕ_ОСТАНОВКА,a=new Array(10),c=new ОтменаОбещания,_=null,u=null;function l(e,t,n){if(!n.startsWith("#EXTM3U"))throw`Вместо списка загружена какая-то фигня длиною ${n.length}\n${n}`;let r,i,o,s,a,c,_,u,l,b,y,w=1;e?(r=new Map,i=[],o=null):(s=0,a=0,c=NaN,l=!1,b=[],y=null);const v=/^#([A-Z0-9\-]+)(?::(.+))?$|^[^#\r\n].*$/gm;v.lastIndex=7;for(let d;d=v.exec(n);){let[n,v,E]=d;if("#"===n.charAt(0))switch(v){case"EXTM3U":Проверить(!1);break;case"EXT-X-VERSION":Проверить(1===w),w=h(E),Проверить(w>=2&&w<=7);break;case"EXT-X-START":Проверить(!1);break;case"EXT-X-MEDIA":{Проверить(e);const t=f(E),n=t.get("TYPE");if(Проверить(n),Проверить("VIDEO"!==n&&"AUDIO"!==n||!t.has("URI")),"VIDEO"!==n)м_Журнал.Ой(`[Список] Найден #EXT-X-MEDIA TYPE=${n}`);else{const e=g(t.get("GROUP-ID"));Проверить(!r.has(e)),r.set(e,g(t.get("NAME")))}break}case"EXT-X-STREAM-INF":{Проверить(e),Проверить(!o),o=Object.create(null);const t=f(E);o.nPeakBitrate=h(t.get("BANDWIDTH")),o.сКодеки=t.has("CODECS")?g(t.get("CODECS")):"",Проверить(!t.has("AUDIO")&&!t.has("SUBTITLES")&&!t.has("CLOSED-CAPTIONS")),t.has("VIDEO")&&(o.сИдентификатор=g(t.get("VIDEO")));break}case"EXT-X-I-FRAME-STREAM-INF":case"EXT-X-SESSION-DATA":case"EXT-X-SESSION-KEY":Проверить(e);break;case"EXT-X-TARGETDURATION":Проверить(!e),Проверить(void 0===_),_=h(E),Проверить(_>0&&_<86400);break;case"EXT-X-MEDIA-SEQUENCE":Проверить(!e),Проверить(0===a),a=h(E);break;case"EXT-X-ENDLIST":Проверить(!e),Проверить(void 0===u),Проверить(void 0===E),u=!0,м_Журнал.Окак(`[Список] #EXT-X-ENDLIST после сегмента ${a+b.length-1}`);break;case"EXT-X-DISCONTINUITY-SEQUENCE":case"EXT-X-DATERANGE":Проверить(!e);break;case"EXT-X-PLAYLIST-TYPE":case"EXT-X-I-FRAMES-ONLY":Проверить(!1);break;case"EXTINF":Проверить(!e),y=y||Object.create(null),Проверить(void 0===y.чДлительность),y.чДлительность=p(E),y.чДлительность-_>1&&м_Журнал.Ой(`[Список] Длительность сегмента превышена на ${y.чДлительность-_}с`);break;case"EXT-X-DISCONTINUITY":Проверить(!e),Проверить(!l),Проверить(void 0===E),l=!0,м_Журнал.Ой(`[Список] #EXT-X-DISCONTINUITY у сегмента ${a+b.length}`);break;case"EXT-X-PROGRAM-DATE-TIME":Проверить(!e);break;case"EXT-X-BYTERANGE":case"EXT-X-KEY":case"EXT-X-MAP":Проверить(!1);break;case"EXT-X-TWITCH-ELAPSED-SECS":Проверить(!e),Проверить(0===b.length),Проверить(Number.isNaN(c)),c=m(E)}else n=ResolveRelativeUrl(n,t),e?(Проверить(o),o.сАбсолютныйАдресСпискаСегментов=n,i.push(o),o=null):(Проверить(y),Проверить(void 0!==y.чДлительность),Проверить(!u),y.чTwitchПрошлоВремени=c,y.лРазрыв=l,y.сАдрес=n,b.push(y),s+=y.чДлительность,c+=y.чДлительность,l=!1,y=null)}if(e){Проверить(!o);for(let e of i)"сИдентификатор"in e?(e.сНазвание=r.get(e.сИдентификатор),Проверить(e.сНазвание)):(e.сИдентификатор=`CoolCmd${e.nPeakBitrate}`,e.сНазвание=`${м_i18n.ФорматироватьЧисло(e.nPeakBitrate/1e6,1)} ${Текст("J0114")}`),м_Журнал.Окак(`[Список] Добавлен вариант PeakBitrate=${e.nPeakBitrate} Идентификатор=${e.сИдентификатор} Название=${e.сНазвание} Кодеки=${e.сКодеки}`);return i.sort(d),i}Проверить(!y),Проверить(void 0!==_);const E={nTargetDuration:_,nMediaSequenceNumber:a,"лКонецСписка":!!u,"моСегменты":b};return м_Журнал.Вот(`[Список] Разобран список сегментов TargetDuration=${_} MediaSequenceNumber=${a} КоличествоСегментов=${b.length} ДлительностьСписка=${м_Журнал.F1(s)}с`),м_Статистика.РазобранСписокСегментов(E,s),E}function d(e,t){return("chunked"===t.сИдентификатор?1e9:t.nPeakBitrate)-("chunked"===e.сИдентификатор?1e9:e.nPeakBitrate)}function f(e){Проверить(e);const t=new Map,n=/([A-Z0-9\-]+)=("[^"]+"|[^",][^,]*)(?:,|$)/g;for(;n.lastIndex!==e.length;){const r=n.lastIndex,i=n.exec(e);Проверить(i.index===r),Проверить(!t.has(i[1])),t.set(i[1],i[2])}return t}function h(e){return Проверить(/^[0-9]{1,15}$/.test(e)),Number.parseInt(e,10)}function m(e){return Проверить(/^[0-9]{1,14}(?:\.[0-9]{1,15})?$/.test(e)),Number.parseFloat(e)}function g(e){return Проверить(e.length>2&&'"'===e.charAt(0)&&'"'===e.charAt(e.length-1)),e.slice(1,-1)}function p(e){if("-"===e.charAt(0))throw"Отрицательный #EXTINF";const t=e.indexOf(",");return m(-1===t?e:e.slice(0,t))}function b(e){const t=e.nMediaSequenceNumber,n=t+e.моСегменты.length;let r,i,o;if(null===u){if(e.лКонецСписка)throw"Найден #EXT-X-ENDLIST";Проверить(0!==e.моСегменты.length),b.лРазрыв=!0,r=i=-1,o=e.моСегменты.length;for(let t=м_Настройки.Получить("чРазмерБуфера");--o>0&&(t-=e.моСегменты[o].чДлительность)>0;);}else{Проверить(0!==e.моСегменты.length),i=(r=u.nMediaSequenceNumber)+u.моСегменты.length,o=0,(t<r||n<i)&&м_Журнал.Ой("[Список] Уменьшился media sequence number"+` [${r}..${i}) ==> [${t}..${n})`);const s=t-i;s>0&&(м_Журнал.Ой(`[Список] Пропущено сегментов: ${s}`),м_Статистика.НеЗагруженыСегменты(s),b.лРазрыв=!0),e.nTargetDuration!==u.nTargetDuration&&(м_Журнал.Ой(`[Список] Изменился target duration ${u.nTargetDuration} ==> ${e.nTargetDuration}`),v())}let a,c=0,_=0;for(;a=e.моСегменты[o];++o){const e=t+o;if(e>=r&&e<i){const t=u.моСегменты[e-r];t.сАдрес===a.сАдрес&&t.чДлительность===a.чДлительность||(м_Журнал.Ой(`[Список] У сегмента ${e} изменились адрес ${t.сАдрес} ==> ${a.сАдрес}`+` или длительность ${t.чДлительность} ==> ${a.чДлительность}`),b.лРазрыв=!0)}if(e>=i)if(s!==СОСТОЯНИЕ_НАЧАЛО_ТРАНСЛЯЦИИ&&(s=СОСТОЯНИЕ_НАЧАЛО_ТРАНСЛЯЦИИ,г_моОчередь.Добавить(new Сегмент(ОБРАБОТКА_ЗАГРУЖЕН,СОСТОЯНИЕ_НАЧАЛО_ТРАНСЛЯЦИИ)),v()),0===a.чДлительность)м_Журнал.Ой(`[Список] Пропускаю сегмент MediaSequenceNumber=${e} Длительность=0`),м_Статистика.НеЗагруженыСегменты(1),b.лРазрыв=!0;else{const t=г_моОчередь.Добавить(new Сегмент(ОБРАБОТКА_ЖДЕТ_ЗАГРУЗКИ,a.сАдрес,a.чДлительность,a.лРазрыв||b.лРазрыв,a.чTwitchПрошлоВремени));м_Журнал.Вот(`[Список] Добавлен сегмент ${t.чНомер} MediaSequenceNumber=${e}`+` Длительность=${t.чДлительность} Разрыв=${t.лРазрыв} TwitchПрошлоВремени=${t.чTwitchПрошлоВремени}`),c+=1,_+=t.чДлительность,b.лРазрыв=!1}}if(м_Статистика.ДобавленыСегментыВОчередь(c,_),n>=i&&(u=e),e.лКонецСписка)throw"Найден #EXT-X-ENDLIST";return c}function y(d){Проверить(Number.isFinite(d)&&d>=0),м_Журнал.Вот(`[Список] Загрузка списка начнется через ${м_Журнал.F0(d)}мс`);let f,h=Ждать(c,d);if(!_){let e;h=h.then(()=>м_Twitch.ПолучитьАбсолютныйАдресСпискаВариантов(c)).then(t=>(e=t,м_Загрузчик.ЗагрузитьТекст(c,e,ЗАГРУЖАТЬ_СПИСОК_ВАРИАНТОВ_НЕ_ДОЛЬШЕ,"список вариантов",!1))).then(t=>{м_Отладка.СохранитьСписокВариантов(t),_=l(!0,e,t),E()})}h.then(()=>(f=performance.now(),м_Загрузчик.ЗагрузитьТекст(c,_[o].сАбсолютныйАдресСпискаСегментов,ЗАГРУЖАТЬ_СПИСОК_СЕГМЕНТОВ_НЕ_ДОЛЬШЕ,"список сегментов",!1))).then(e=>{м_Отладка.СохранитьСписокСегментов(e);const t=function(e){Проверить(s===СОСТОЯНИЕ_НАЧАЛО_ТРАНСЛЯЦИИ);const t=МИН_ИНТЕРВАЛ_ОБНОВЛЕНИЯ_СПИСКОВ*u.nTargetDuration*10;if(0===e)return t;const n=м_Настройки.Получить("чИнтервалОпроса");if(n!==АВТОНАСТРОЙКА)return n*u.nTargetDuration*10;Проверить(e>0&&e<=u.моСегменты.length),-1===i&&(i=0,e=u.моСегменты.length);e=Math.min(e,a.length);do{a[i]=u.моСегменты[u.моСегменты.length-e].чДлительность,++i===a.length&&(i=0)}while(0!=--e);return Math.max(1e3*Math.max(...a)+r,t)}(b(l(!1,_[o].сАбсолютныйАдресСпискаСегментов,e)));y(Math.max(t-performance.now()+f,0)),м_Загрузчик.ЗагрузитьСледующийСегмент()}).catch(ДобавитьОбработчикИсключений(r=>{if("string"==typeof r)м_Журнал.Ой(`[Список] Завершаю трансляцию. ${r}`),function(){s!==СОСТОЯНИЕ_ЗАВЕРШЕНИЕ_ТРАНСЛЯЦИИ&&(s=СОСТОЯНИЕ_ЗАВЕРШЕНИЕ_ТРАНСЛЯЦИИ,г_моОчередь.Добавить(new Сегмент(ОБРАБОТКА_ЗАГРУЖЕН,СОСТОЯНИЕ_ЗАВЕРШЕНИЕ_ТРАНСЛЯЦИИ)),v());$(),u=null}(),y(function(){Проверить(s===СОСТОЯНИЕ_ЗАВЕРШЕНИЕ_ТРАНСЛЯЦИИ),i=-1===i?e:Math.min(i+n,t);return i}()),м_Загрузчик.ЗагрузитьСледующийСегмент();else{if(r!==ОтменаОбещания.ОБЕЩАНИЕ_ОТМЕНЕНО)throw r;м_Журнал.Вот("[Список] Отменено обновление списков")}}))}function w(){м_Журнал.Вот("[Список] Отменяю обновление списков"),c.Отменить()}function v(){a.fill(0),i=-1}function E(){if(0===_.length)throw"Список вариантов пуст";const e=м_Настройки.Получить("сНазваниеВарианта");for(o=_.length-1;0!==o&&_[o].сИдентификатор!==e;)--o;м_Журнал.Вот(`[Список] Выбран вариант трансляции ${_[o].сИдентификатор} ЖелаемыйВариант=${e}`),м_События.ОбработатьСобытие("список-выбранварианттрансляции",[_,o])}function $(){_&&(м_Журнал.Вот("[Список] Очищаю список вариантов трансляции"),_=null,м_События.ОбработатьСобытие("список-выбранварианттрансляции",[_,o]))}return v(),{"Запустить":function(){Проверить(s===СОСТОЯНИЕ_ОСТАНОВКА),c.НачалоВыполнения(),y(0)},"Остановить":function(){s=СОСТОЯНИЕ_ОСТАНОВКА,w(),$(),u=null},"ИзменитьВариантТрансляции":function(){Проверить(_),w(),v(),E(),u=null,c.НачалоВыполнения(),y(0),г_моОчередь.Добавить(new Сегмент(ОБРАБОТКА_ЗАГРУЖЕН,СОСТОЯНИЕ_СМЕНА_ВАРИАНТА)),м_Загрузчик.ЗагрузитьСледующийСегмент()}}})(),м_Преобразователь=(()=>{let e=null,t=-1;const n=ДобавитьОбработчикИсключений(e=>{const t=e.data;switch(Проверить(Array.isArray(t)),t[0]){case 1:Проверить(2===t.length&&ЭтоОбъект(t[1]));const e=new Сегмент(ОБРАБОТКА_ПРЕОБРАЗОВАН,t[1].пДанные,t[1].чДлительность,t[1].лРазрыв,t[1].чTwitchПрошлоВремени,t[1].чНомер);if(м_Журнал.Вот(`[Преобразование] Получен сегмент ${e.чНомер} ПреобразованЗа=${м_Журнал.F0(e.пДанные.чПреобразованЗа)}мс`),"number"!=typeof e.пДанные){if(м_Статистика.ПолученПреобразованныйСегмент(e),void 0===e.пДанные.мбМедиасегмент)return;м_Отладка.СохранитьПреобразованныйСегмент(e)}return г_моОчередь.Добавить(e),void м_Проигрыватель.ДобавитьСледующийСегмент();case 2:const n=t[1],r=t[2];Проверить(3===t.length&&Array.isArray(n)&&Array.isArray(r)&&n.length===r.length);for(let e=0;e<n.length;++e)Проверить(("Вот"===n[e]||"Окак"===n[e]||"Ой"===n[e])&&"string"==typeof r[e]),м_Журнал[n[e]](r[e]);return;case 3:return Проверить(3===t.length&&"string"==typeof t[1]&&"object"==typeof t[2]),void м_Отладка.ЗавершитьРаботуИОтправитьОтчет(t[1],t[2]);case 4:return Проверить(2===t.length&&"string"==typeof t[1]),void м_Отладка.ЗавершитьРаботуИПоказатьСообщение(t[1]);case 5:return Проверить(2===t.length&&t[1].byteLength),void м_Помойка.Выбросить(t[1]);default:Проверить(!1)}});function r(e){м_Отладка.ЗавершитьРаботуИОтправитьОтчет(`Произошло событие ${e.type} в рабочем потоке в строке ${e.lineno}. ${e.message}`)}return{"Остановить":function(){t=-1,e&&(м_Журнал.Вот("[Преобразование] Убиваю рабочий поток"),e.terminate(),e=null)},"ПреобразоватьСледующийСегмент":function(){let i,o=0;for(let s,a=0;s=г_моОчередь[a];++a)if(!(s.чОбработка>ОБРАБОТКА_ЗАГРУЖЕН)){if(s.чОбработка<ОБРАБОТКА_ЗАГРУЖЕН)break;-1!==t&&t+1!==s.чНомер&&(м_Журнал.Ой(`[Преобразование] Не загружены сегменты между ${t} и ${s.чНомер}`),s.лРазрыв=!0),t=s.чНомер,"number"!=typeof s.пДанные||null!==e?("number"!=typeof s.пДанные&&(м_Отладка.СохранитьТранспортныйПоток(s),м_Статистика.ОтосланИсходныйСегмент()),м_Журнал.Вот(`[Преобразование] Отсылаю сегмент ${s.чНомер}`),s.сВерсия=ВЕРСИЯ_РАСШИРЕНИЯ,e.postMessage(s,"number"==typeof s.пДанные?void 0:[s.пДанные]),1==++o&&(i=a)):(м_Журнал.Вот(`[Преобразование] Пропускаю сегмент ${s.чНомер} Состояние=${s.пДанные}`),s.чОбработка=ОБРАБОТКА_ПРЕОБРАЗОВАН,s.пДанные===СОСТОЯНИЕ_НАЧАЛО_ТРАНСЛЯЦИИ&&(e||(м_Журнал.Вот("[Преобразование] Создаю рабочий поток"),(e=new Worker(chrome.extension.getURL("worker_pre.js"))).addEventListener("message",n),e.addEventListener("error",r),e.addEventListener("messageerror",r))))}0!==o&&г_моОчередь.Удалить(i,o),м_Проигрыватель.ДобавитьСледующийСегмент()}}})(),м_Загрузчик=(()=>{function e(e,o,s,a,c,_,u,l){Проверить("GET"===o||"PUT"===o||"DELETE"===o),Проверить("string"==typeof s&&(s.startsWith("http://")||s.startsWith("https://")||0===a&&s.startsWith(chrome.extension.getURL("")))),Проверить(Number.isFinite(a)&&(0===a||a>1e3)),Проверить("object"==typeof c&&"string"==typeof _&&"boolean"==typeof u),Проверить("text"===l||"json"===l||Number.isFinite(l)),м_Журнал.Вот(`[Загрузчик] ${o} ${_} не дольше ${м_Журнал.F0(a)}мс`);const d=new XMLHttpRequest;return d._сМетод=o,d._сАдрес=s,d._чНеДольше=a,d._оЗаголовки=c,d._сНазвание=_,d._лЖурнал=u,d._пТипДанных=l,d._кОсталосьПопыток="number"==typeof l?1:2,d._чВремяОтправкиЗапроса=performance.now(),d._чОжиданиеОтвета=NaN,d.addEventListener("timeout",r),d.addEventListener("error",r),d.addEventListener("abort",r),d.addEventListener("load",i),u&&"number"==typeof l&&d.addEventListener("readystatechange",n),new Promise((n,i)=>{d._фВыполнить=n,d._фОтказаться=i,e&&e.ЗаменитьОбработчик(function(e){return()=>{м_Журнал.Вот(`[Загрузчик] Отменяю загрузку ${e._сНазвание} readyState=${e.readyState}`),e.removeEventListener("abort",r),e.abort(),e._фОтказаться(ОтменаОбещания.ОБЕЩАНИЕ_ОТМЕНЕНО)}}(d)),t(d,!1)})}function t(e,t){if(0===e._кОсталосьПопыток)return!1;if(t&&м_Журнал.Ой(`[Загрузчик] Повторно загружаю ${e._сНазвание}`),e._кОсталосьПопыток-=1,e.open(e._сМетод,e._сАдрес),e.responseType="number"==typeof e._пТипДанных?"arraybuffer":"text",e.timeout=e._чНеДольше,e._оЗаголовки)for(let t of Object.keys(e._оЗаголовки))e.setRequestHeader(t,e._оЗаголовки[t]);return e.send(),!0}const n=ДобавитьОбработчикИсключений(({target:e})=>{e.readyState>=XMLHttpRequest.HEADERS_RECEIVED&&(e.removeEventListener("readystatechange",n),Проверить(Number.isNaN(e._чОжиданиеОтвета)),e._чОжиданиеОтвета=Math.round(performance.now()-e._чВремяОтправкиЗапроса))}),r=ДобавитьОбработчикИсключений(({target:e,type:n})=>{м_Журнал.Ой(`[Загрузчик] Не удалось загрузить ${e._сНазвание}. Произошло событие ${n}`+` readyState=${e.readyState}`+(e._лЖурнал&&"number"==typeof e._пТипДанных?` ОжиданиеОтвета=${e._чОжиданиеОтвета}мс`:"")),"abort"!==n&&t(e,!0)||("arraybuffer"===e.responseType&&м_Статистика.ЗагруженСегмент(NaN,NaN,NaN,e._чОжиданиеОтвета),e._фОтказаться(`Произошло событие ${n}`))}),i=ДобавитьОбработчикИсключений(({target:e})=>{Проверить(e.readyState===XMLHttpRequest.DONE);const n=e.status;if(n>=200&&n<=299&&null!==e.response){const t=Math.round(performance.now()-e._чВремяОтправкиЗапроса);if(м_Журнал[200===n?"Вот":"Ой"](`[Загрузчик] Загрузил ${e._сНазвание} за ${t}мс`+(e._лЖурнал&&"number"==typeof e._пТипДанных?` ОжиданиеОтвета=${e._чОжиданиеОтвета}мс`:"")+("number"==typeof e._пТипДанных?` Соотношение=${м_Журнал.F1(t/e._пТипДанных/1e3)}`:"")+(200===n?"":` Код=${n} ${e.statusText}`)+(e._лЖурнал&&ЭтоНепустаяСтрока(e.response)?`\n${e.response}`:` Размер=${"arraybuffer"===e.responseType?e.response.byteLength:e.response.length}`)),0!==e._чНеДольше&&м_Статистика.СкачаноНечто(function(e){let t,n=17+e.statusText.length+e.getAllResponseHeaders().length;(function(e){return 0===e.statusText.length})(e)&&(n=Math.round(.5*n));let r=e.getResponseHeader("Content-Length");r?t=Number.parseInt(r,10):"arraybuffer"===e.responseType?t=e.response.byteLength:(t=e.response.length,(r=e.getResponseHeader("Content-Encoding"))&&"identity"!==r&&(t=Math.round(.35*t)));return n+t}(e)),"arraybuffer"===e.responseType)м_Статистика.ЗагруженСегмент(e.response.byteLength,e._пТипДанных,t,e._чОжиданиеОтвета),e._фВыполнить(e.response);else if("json"===e._пТипДанных)try{e._фВыполнить(JSON.parse(e.response))}catch(t){м_Журнал.Ой(`[Загрузчик] Не удалось разобрать ${e._сНазвание}. ${t}`),e._фОтказаться("Не удалось разобрать JSON")}else e._фВыполнить(e.response)}else м_Журнал.Ой(`[Загрузчик] Не удалось загрузить ${e._сНазвание}. ${КОД_ОТВЕТА+n} ${e.statusText}`+(e._лЖурнал&&"number"==typeof e._пТипДанных?` ОжиданиеОтвета=${e._чОжиданиеОтвета}мс`:"")+(ЭтоНепустаяСтрока(e.response)?`\n${e.response}`:` Размер=${"arraybuffer"===e.responseType?e.response.byteLength:e.response.length}`)),(n>=400&&n<=499||null===e.response||!t(e,!0))&&("arraybuffer"===e.responseType&&м_Статистика.ЗагруженСегмент(NaN,NaN,NaN,e._чОжиданиеОтвета),e._фОтказаться(КОД_ОТВЕТА+n))});function o(){let e=г_моОчередь.length-1;if(e>=0&&г_моОчередь[e].пДанные===СОСТОЯНИЕ_СМЕНА_ВАРИАНТА&&г_моОчередь[e].чОбработка===ОБРАБОТКА_ЗАГРУЖЕН){for(г_моОчередь.ПоказатьСостояние();--e>=0&&г_моОчередь[e].чОбработка<=ОБРАБОТКА_ЗАГРУЖЕН;)"number"!=typeof г_моОчередь[e].пДанные&&г_моОчередь.Удалить(e);г_моОчередь.ПоказатьСостояние()}else{let e=м_Настройки.Получить("кОдновременныхЗагрузок"),t=0;for(let n of г_моОчередь)n.чОбработка<=ОБРАБОТКА_ЗАГРУЖЕН&&(t+=n.чДлительность,n.чОбработка<=ОБРАБОТКА_ЗАГРУЖАЕТСЯ&&(--e,n.чОбработка===ОБРАБОТКА_ЖДЕТ_ЗАГРУЗКИ&&e>=0&&s(n)));if(t>=ПЕРЕПОЛНЕНИЕ_БУФЕРА)return м_Журнал.Ой(`[Загрузчик] Длительность всех загрузок в очереди ${м_Журнал.F1(t)}с >= ${ПЕРЕПОЛНЕНИЕ_БУФЕРА}с`),a(null),void o()}м_Преобразователь.ПреобразоватьСледующийСегмент()}function s(t){const n=5e3+t.чДлительность*м_Настройки.Получить("кОдновременныхЗагрузок")*2*1e3;Проверить(n<1e3*ПЕРЕПОЛНЕНИЕ_БУФЕРА);const r=t.пДанные;t.пДанные=new ОтменаОбещания,t.пДанные.НачалоВыполнения(),t.чОбработка=ОБРАБОТКА_ЗАГРУЖАЕТСЯ,e(t.пДанные,"GET",r,n,null,`сегмент ${t.чНомер}`,м_Статистика.ОкноПоказано(),t.чДлительность).then(e=>{Проверить(г_моОчередь.includes(t)),t.пДанные=e,t.чОбработка=ОБРАБОТКА_ЗАГРУЖЕН,o()}).catch(ДобавитьОбработчикИсключений(e=>{if("string"==typeof e&&t.чОбработка===ОБРАБОТКА_ЗАГРУЖАЕТСЯ)Проверить(г_моОчередь.includes(t)),a(e.сПричина===КОД_ОТВЕТА+404||e.сПричина===КОД_ОТВЕТА+410?null:t),Проверить(!г_моОчередь.includes(t)),o();else{if(e!==ОтменаОбещания.ОБЕЩАНИЕ_ОТМЕНЕНО)throw e;м_Журнал.Вот(`[Загрузчик] Отменена загрузка сегмента ${t.чНомер}`),Проверить(!г_моОчередь.includes(t))}}))}function a(e){г_моОчередь.ПоказатьСостояние();const t=г_моОчередь.length;if(e)г_моОчередь.Удалить(e);else{let e=м_Настройки.Получить("чРазмерБуфера");for(let n,r=t;n=г_моОчередь[--r];)n.чОбработка===ОБРАБОТКА_ЖДЕТ_ЗАГРУЗКИ?e>0?e-=n.чДлительность:г_моОчередь.Удалить(r):n.чОбработка===ОБРАБОТКА_ЗАГРУЖАЕТСЯ&&г_моОчередь.Удалить(r)}г_моОчередь.ПоказатьСостояние(),м_Статистика.НеЗагруженыСегменты(t-г_моОчередь.length)}return{"ЗагрузитьТекст":function(t,n,r,i,o,s=null,a="GET"){return e(t,a,n,r,s,i,o,"text")},"ЗагрузитьJson":function(t,n,r,i,o,s=null,a="GET"){return e(t,a,n,r,s,i,o,"json")},"ЗагрузитьСледующийСегмент":o}})();let м_Twitch=null;function Twitch(e){const t=6e4,n=24e4,r="jzkbprff40iqj646a697cyrvl0zt2m6",i={"Client-ID":r,Accept:"application/vnd.twitchtv.v5+json"};let o="",s="",a="",c="",_="",u=new ОтменаОбещания;function l(){s=a=""}function d(e){if(Проверить(c&&o&&_),c===o)return Проверить(void 0===e),void м_События.ОбработатьСобытие("twitch-полученыметаданныезрителя",{"чПодписка":ПОДПИСКА_НЕДОСТУПНА});let t,n;switch(e){case void 0:t="GET",n="";break;case ПОДПИСКА_НЕОФОРМЛЕНА:t="DELETE",n="";break;case ПОДПИСКА_НЕУВЕДОМЛЯТЬ:t="PUT",n="?notifications=false";break;case ПОДПИСКА_УВЕДОМЛЯТЬ:t="PUT",n="?notifications=true";break;default:Проверить(!1)}м_Загрузчик.ЗагрузитьТекст(null,`https://api.twitch.tv/kraken/users/${c}/follows/channels/${o}${n}`,ЗАГРУЖАТЬ_МЕТАДАННЫЕ_НЕ_ДОЛЬШЕ,`подписка ${e}`,!0,void 0===e?i:{"Client-ID":r,Accept:"application/vnd.twitchtv.v5+json",Authorization:`OAuth ${_}`},t).then(t=>{if(e===ПОДПИСКА_НЕОФОРМЛЕНА)return Проверить(""===t),void м_События.ОбработатьСобытие("twitch-полученыметаданныезрителя",{"чПодписка":ПОДПИСКА_НЕОФОРМЛЕНА});let n;try{n=JSON.parse(t)}catch(e){throw String(e)}Проверить(ЭтоНепустаяСтрока(n.created_at)),Проверить("boolean"==typeof n.notifications),м_События.ОбработатьСобытие("twitch-полученыметаданныезрителя",{"чПодписка":void 0!==e?e:n.notifications?ПОДПИСКА_УВЕДОМЛЯТЬ:ПОДПИСКА_НЕУВЕДОМЛЯТЬ})}).catch(ДобавитьОбработчикИсключений(t=>{if(t===КОД_ОТВЕТА+404)Проверить(void 0===e),м_События.ОбработатьСобытие("twitch-полученыметаданныезрителя",{"чПодписка":ПОДПИСКА_НЕОФОРМЛЕНА});else{if("string"!=typeof t)throw t;м_Журнал.Ой(`[Twitch] Не удалось обновить подписку. ${t}`),м_События.ОбработатьСобытие("twitch-полученыметаданныезрителя",{"чПодписка":ПОДПИСКА_НЕДОСТУПНА})}}))}const f=ДобавитьОбработчикИсключений(()=>{Проверить(o),м_Загрузчик.ЗагрузитьJson(null,`https://api.twitch.tv/kraken/channels/${o}`,ЗАГРУЖАТЬ_МЕТАДАННЫЕ_НЕ_ДОЛЬШЕ,"метаданные канала",!0,i).then(e=>{const t=new Date(e.created_at);Проверить(e._id===o&&Number.isFinite(e.followers)&&Number.isFinite(e.views)&&!Number.isNaN(t.getTime())),м_События.ОбработатьСобытие("twitch-полученыметаданныеканала",{"сИмя":e.display_name||e.name,"сАватар":e.logo||"glitch.svg#avatar","сОписание":e.description,"сКодЯзыка":"other"===e.broadcaster_language?null:e.broadcaster_language,"кПодписчиков":e.followers,"кПросмотров":e.views,"дКаналСоздан":t})}).catch(e=>{"string"==typeof e?м_Журнал.Ой(`[Twitch] Не удалось получить метаданные канала. ${e}`):м_Отладка.ПойманоИсключение(e)}),м_Загрузчик.ЗагрузитьJson(null,`https://api.twitch.tv/kraken/channels/${o}/communities`,ЗАГРУЖАТЬ_МЕТАДАННЫЕ_НЕ_ДОЛЬШЕ,"сообщества канала",!0,i).then(e=>{Проверить(Array.isArray(e.communities));for(let t of e.communities)Проверить(ЭтоНепустаяСтрока(t.name)),t.сИмя=t.display_name||t.name,t.сОписание=t.description,t.сАдрес=`https://www.twitch.tv/communities/${encodeURIComponent(t.name)}`;м_События.ОбработатьСобытие("twitch-полученыметаданныеканала",{"моСообщества":e.communities})}).catch(e=>{"string"==typeof e?м_Журнал.Ой(`[Twitch] Не удалось получить сообщества канала. ${e}`):м_Отладка.ПойманоИсключение(e)}),м_Загрузчик.ЗагрузитьJson(null,`https://api.twitch.tv/kraken/channels/${o}/teams`,ЗАГРУЖАТЬ_МЕТАДАННЫЕ_НЕ_ДОЛЬШЕ,"команды канала",!0,i).then(e=>{Проверить(Array.isArray(e.teams));for(let t of e.teams)Проверить(ЭтоНепустаяСтрока(t.name)),t.сИмя=t.display_name||t.name,t.info&&(t.сОписание=ПреобразоватьРазметкуВТекст(t.info)),t.сАдрес=`https://www.twitch.tv/team/${encodeURIComponent(t.name)}`;м_События.ОбработатьСобытие("twitch-полученыметаданныеканала",{"моКоманды":e.teams})}).catch(e=>{"string"==typeof e?м_Журнал.Ой(`[Twitch] Не удалось получить команды канала. ${e}`):м_Отладка.ПойманоИсключение(e)}),function(){let e;м_Загрузчик.ЗагрузитьJson(null,"https://api.twitch.tv/kraken/user",ЗАГРУЖАТЬ_МЕТАДАННЫЕ_НЕ_ДОЛЬШЕ,"метаданные зрителя",!0,i).then(t=>(Проверить(ЭтоНепустаяСтрока(t._id)),Проверить(ЭтоНепустаяСтрока(t.name)),c=t._id,e=t.display_name||t.name,м_Загрузчик.ЗагрузитьJson(null,"https://api.twitch.tv/api/viewer/token.json",ЗАГРУЖАТЬ_МЕТАДАННЫЕ_НЕ_ДОЛЬШЕ,"токен зрителя",!1,{"Client-ID":r}))).then(t=>{Проверить(ЭтоНепустаяСтрока(t.token)),_=t.token,м_События.ОбработатьСобытие("twitch-полученыметаданныезрителя",{"сИмя":e}),d()}).catch(ДобавитьОбработчикИсключений(e=>{if("string"!=typeof e)throw e;м_Журнал.Ой(`[Twitch] Не удалось получить метаданные зрителя. ${e}`),c=_="",м_События.ОбработатьСобытие("twitch-полученыметаданныезрителя",{"сИмя":""})}))}()});function h(r){Проверить(o),м_Журнал.Вот(`[Twitch] Загрузка метаданных трансляции начнется через ${м_Журнал.F0(r)}мс`),Ждать(u,r).then(()=>м_Загрузчик.ЗагрузитьJson(u,`https://api.twitch.tv/kraken/streams/${o}`,ЗАГРУЖАТЬ_МЕТАДАННЫЕ_НЕ_ДОЛЬШЕ,"метаданные трансляции",!0,i)).then(r=>{if(!ЭтоОбъект(r)||!ЭтоОбъект(r.stream))throw"В загруженном JSON нет метаданных";const c=Date.now()-Date.parse(r.stream.created_at);Проверить(String(r.stream.channel._id)===o&&r.stream.hasOwnProperty("_id")&&ЭтоНепустаяСтрока(r.stream.stream_type)&&Number.isFinite(r.stream.viewers)&&Number.isFinite(c)),e!==r.stream.channel.name&&(м_Журнал.Ой(`[Twitch] Изменился код канала с ${e} на ${r.stream.channel.name}`),e=r.stream.channel.name);const _="live"!==r.stream.stream_type,u={"сНазваниеТрансляции":r.stream.channel.status||Текст("J0103"),"сНазваниеИгры":_?null:r.stream.game||Текст("J0104"),"сАдресИгры":function(e){return"https://www.twitch.tv/directory"+(e?"/game/"+encodeURIComponent(e):"")}(r.stream.game),"кЗрителей":r.stream.viewers,"чДлительностьТрансляции":c};""===s&&(м_Журнал.Окак(`[Twitch] Идентификатор трансляции: ${r.stream._id}`),s=String(r.stream._id),u.лЗапись=_,u.сАдресЗаписи="",_||function(e){Проверить(o&&s);const t=s,r=Math.max(n-Math.max(e,0),0);м_Журнал.Вот(`[Twitch] Получение записи трансляции начнется через ${м_Журнал.F0(r)}мс`),Ждать(null,r).then(()=>{if(t!==s)throw"Трансляция завершена";return м_Загрузчик.ЗагрузитьJson(null,`https://api.twitch.tv/kraken/channels/${o}/videos?broadcast_type=archive&limit=3`,ЗАГРУЖАТЬ_МЕТАДАННЫЕ_НЕ_ДОЛЬШЕ,"запись трансляции",!0,i)}).then(e=>{if(t!==s)throw"Трансляция завершена";for(let n of e.videos)if(String(n.broadcast_id)===t){Проверить("archive"===n.broadcast_type),Проверить(String(n.channel._id)===o),Проверить(ЭтоНепустаяСтрока(n.url)),a=n.url,м_События.ОбработатьСобытие("twitch-полученыметаданныетрансляции",{"лЗапись":!1,"сАдресЗаписи":a});break}}).catch(e=>{"string"==typeof e?м_Журнал.Ой(`[Twitch] Не удалось загрузить запись трансляции. ${e}`):м_Отладка.ПойманоИсключение(e)})}(c)),м_События.ОбработатьСобытие("twitch-полученыметаданныетрансляции",u),h(t)}).catch(ДобавитьОбработчикИсключений(e=>{if("string"==typeof e)м_Журнал.Ой(`[Twitch] Не удалось загрузить метаданные трансляции. ${e}`),h(t/2);else{if(e!==ОтменаОбещания.ОБЕЩАНИЕ_ОТМЕНЕНО)throw e;м_Журнал.Вот("[Twitch] Отменено обновление метаданных трансляции")}}))}return Проверить(ЭтоНепустаяСтрока(e)),{"ПолучитьАбсолютныйАдресСпискаВариантов":function(t,n=!1){return м_Загрузчик.ЗагрузитьТекст(t,`https://api.twitch.tv/api/channels/${e}/access_token?adblock=false&need_https=${n?"false":"true"}&platform=web&player_type=site`,ЗАГРУЖАТЬ_СПИСОК_ВАРИАНТОВ_НЕ_ДОЛЬШЕ,"токен трансляции",!0,{"Client-ID":r}).then(t=>{const r=JSON.parse(t);if(ЭтоОбъект(r)&&ЭтоНепустаяСтрока(r.token)&&ЭтоНепустаяСтрока(r.sig)){const t=JSON.parse(r.token);if(t.channel===e)return""===o?(Проверить(t.hasOwnProperty("channel_id")),o=String(t.channel_id),setImmediate(f)):Проверить(o===String(t.channel_id)),`${n?"http":"https"}://usher.ttvnw.net/api/channel/hls/${e}.m3u8?allow_source=true&player_backend=mediaplayer&sig=${encodeURIComponent(r.sig)}&token=${encodeURIComponent(r.token)}`}м_Отладка.ЗавершитьРаботуИПоказатьСообщение("J0203")},e=>{if(e!==КОД_ОТВЕТА+404&&e!==КОД_ОТВЕТА+422)throw e;м_Отладка.ЗавершитьРаботуИПоказатьСообщение("J0203")})},"ПолучитьАбсолютныйАдресСпискаСегментов":function(e){return e},"ПолучитьАдресКанала":function(t){return t?`https://www.twitch.tv/${e}?twitch5=0`:`https://www.twitch.tv/${e}`},"ПолучитьАдресПанелиЧата":function(){return м_Настройки.Получить("лПолноценныйЧат")?`https://www.twitch.tv/popout/${e}/chat`:м_Настройки.Получить("лЗатемнитьЧат")?`https://www.twitch.tv/embed/${e}/chat?darkpopout`:`https://www.twitch.tv/embed/${e}/chat`},"ЭтоАдресПанелиЧата":function(t){const n=t.match(/^https:\/\/www.twitch.tv\/(?:popout|embed)\/([^/]+)\/chat(?:\?|$)/);return n&&n[1]===e},"НачатьСборМетаданныхТрансляции":function(){l(),u.НачалоВыполнения(),h(0)},"ЗавершитьСборМетаданныхТрансляции":function(e){м_Журнал.Вот(`[Twitch] Отменяю обновление метаданных трансляции ТрансляцияЗавершена=${e}`),e&&l(),u.Отменить()},"ИзменитьПодпискуЗрителяНаКанал":function(e){Проверить(Number.isInteger(e)),d(e)},"ПолучитьАдресЗаписиДляТекущейПозиции":function(){const e=м_Проигрыватель.ПолучитьПозициюВоспроизведенияТрансляции(!1);return""===a||-1===e?(м_Журнал.Ой(`[Twitch] Недостаточно данных для получения адреса записи АдресЗаписи=${a} Позиция=${e}`),""):`${a}?t=${Math.floor(e/60/60)}h${Math.floor(e/60%60)}m${Math.floor(e%60)}s`},"СоздатьКлип":function(){const t=м_Проигрыватель.ПолучитьПозициюВоспроизведенияТрансляции(!0);if(""===s||-1===t)return м_Журнал.Ой(`[Twitch] Недостаточно данных для создания клипа ИдЗрителя=${c} ИдТрансляции=${s} Позиция=${t}`),!1;м_Журнал.Окак(`[Twitch] Создаю клип ИдЗрителя=${c} ИдТрансляции=${s} Позиция=${t}`),Узел("создатьклип-канал").value=e,Узел("создатьклип-трансляция").value=s,Узел("создатьклип-позиция").value=Math.floor(t);try{Узел("создатьклип-форма").submit()}catch(e){return м_Журнал.Ой(`[Twitch] Не удалось отправить форму для создания клипа: ${e}`),!1}return!0}}}function ЗавершитьРаботу(e){try{м_Журнал.Окак("[Запускалка] Завершаю работу"),м_Настройки.Остановить(),e||(м_Статистика.Остановить(),м_Преобразователь.Остановить(),м_Проигрыватель.Остановить(),м_Помойка.Сжечь()),м_Журнал.Окак("[Запускалка] Работа завершена")}catch(e){}finally{г_лРаботаЗавершена=!0,window.stop()}}function fitVideo(){const e=document.getElementById("глаз"),t=window.innerHeight,n=window.innerWidth;let r=e.videoWidth,i=e.videoHeight,o=!1;i>t&&(i=t,o=!0),r>n&&(r=n,o=!0),o&&(e.style.objectFit="fill"),e.style.width=r+"px",e.style.height=i+"px"}ДобавитьОбработчикИсключений(()=>{function e(){м_Журнал.Окак("[Запускалка] window.beforeunload"),ЗавершитьРаботу(!0)}const t=function(e){const t=РазобратьПараметры(e).get("channel")||"channel";return t.includes(":")?t:t.toLowerCase()}(window.location);м_Журнал.Вот(`[Запускалка] Канал ${t}`),function(e){Проверить(ЭтоНепустаяСтрока(e)),chrome.runtime.sendMessage({"сЗапрос":"ЭтотКаналУжеОткрыт","сКанал":e},void 0,e=>{!0===e&&м_Отладка.ЗавершитьРаботуИПоказатьСообщение("J0211")}),chrome.runtime.onMessage.addListener(ДобавитьОбработчикИсключений((t,n,r)=>{"ЭтотКаналУжеОткрыт"===t.сЗапрос&&(м_Журнал.Окак(`[Запускалка] Открыт канал ${t.сКанал}`),t.сКанал===e&&r(!0))}))}(t),м_Twitch=Twitch(t),Promise.all([м_Настройки.Восстановить(),м_Оформление.ЗапуститьАсинхронно(),new Promise((e,t)=>{chrome.tabs.getCurrent(n=>{try{Проверить(!chrome.runtime.lastError),Проверить(Number.isInteger(n.id)&&n.id>=0),г_чИдВкладки=n.id,e()}catch(e){t(e)}})}),new Promise((e,t)=>{"complete"===document.readyState?(м_Журнал.Ой("[Запускалка] document.readyState=complete"),e()):(м_Журнал.Вот(`[Запускалка] document.readyState=${document.readyState}`),window.addEventListener("load",function n(){try{window.removeEventListener("load",n),Проверить("complete"===document.readyState),м_Журнал.Вот("[Запускалка] window.onload"),e()}catch(e){t(e)}}))})]).then(function(){Проверить(!г_лРаботаЗавершена),м_Журнал.Вот(`[Запускалка] Начало работы ${performance.now().toFixed()}мс`),window.addEventListener("beforeunload",e),м_Управление.Запустить(),м_Проигрыватель.Запустить()?м_Список.Запустить():м_Управление.ОстановитьПросмотрТрансляции(),м_Статистика.Запустить()}).catch(м_Отладка.ПойманоИсключение),м_i18n.TranslateDocument(document)})();