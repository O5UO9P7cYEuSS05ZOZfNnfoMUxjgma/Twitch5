"use strict";const ВЕРСИЯ_РАСШИРЕНИЯ="2018.7.9",ВЕРСИЯ_ДВИЖКА_БРАУЗЕРА=Number.parseInt(/Chrome\/(\d+)/.exec(navigator.userAgent)[1],10);function Проверить(t){if(!t)throw new Error("Проверка не пройдена")}function Браковать(t){if(!t)throw new Error("БРАКОВАТЬ")}function ЗавершитьРаботуИПоказатьСообщение(t){throw void postMessage([4,t])}function ЗавершитьРаботуИОтправитьОтчет(t,e){"object"==typeof e&&null!==e&&e.byteLength?postMessage([3,t,e],[e]):postMessage([3,t,null])}function ВыброситьВПомойку(t){ВЕРСИЯ_ДВИЖКА_БРАУЗЕРА>=64||t&&t.buffer.byteLength&&postMessage([5,t.buffer],[t.buffer])}function ОкруглитьРазмерКучиAsmJS(t){return t<=65536?65536:t>=1<<24?(t+16777215&4278190080)>>>0:1<<32-Math.clz32(t-1)}function AsmJS(t,e,i){"use asm";var n=new t.Uint8Array(i);function r(t,e){t=t|0;e=e|0;var i=0,r=0,a=0;if((t|0)<0|(t|0)>(e|0)){return-1|0}i=e-3|0;for(;;){if((t|0)>(i|0)){return e|0}r=n[t>>0]|0;t=t+1|0;if((r|0)==0){r=n[t>>0]|0;t=t+1|0;if((r|0)==0){r=n[t>>0]|0;t=t+1|0;if((r|0)<=1){break}}}}a=t-3|0;t=t-1|0;do{r=n[t>>0]|0;t=t+1|0;if((r|0)==1){t=t-a|0;if((t|0)>0xffff){return-1|0}n[a>>0]=t;n[a+1>>0]=t>>8;return a|0}if((r|0)!=0){return-2|0}}while((t|0)<(e|0));return e|0}return{SearchStartCodePrefix:r}}function ПотокБитов(t,e,i){Проверить(Number.isInteger(e)&&Number.isInteger(i)&&e>=0&&i<=t.length&&i>=e),this._мбБуфер=t,this._уСледующийБайт=e,this._чСледующийБит=7,this.кБитОсталось=8*(i-e)}function IsoBaseMedia(t,e){Проверить(Number.isInteger(e)&&e>=0&&e<=t.length),this.мбБуфер=t,this.уНачало=e,this.уКонец=e}function ID3(t,e,i){Проверить(1===t.BYTES_PER_ELEMENT&&Number.isInteger(e)&&Number.isInteger(i)&&e>=0&&e<=i),this._мб=t;var n=i-e;n>20&&73===this._мб[e]&&68===this._мб[e+1]&&51===this._мб[e+2]&&4===this._мб[e+3]&&0===this._мб[e+5]&&this._ParseSynchsafeInteger(e+6)===n-10?(this._уТег=e+10,this._кбТег=n-10):(this._уТег=-1,this._кбТег=-1),this._уПоле=-1,this._кбПоле=-1}function Срез(t,e,i,n,r,a){Проверить(Number.isInteger(t)&&t>=0),Проверить(Number.isInteger(e)&&Number.isInteger(i)&&e>=0&&e<=i),Проверить(Number.isInteger(n)&&Number.isInteger(r)&&n>=0&&n<=r),Проверить(0===t&&0===n&&0===r||(r-n)%t==0),Проверить(a>=-1),this.кбСтруктураСемпла=t,this.уНачалоПотока=e,this.уКонецПотока=i,this.уНачалоСемплов=n,this.уКонецСемплов=r,this.чВДНачала=a}function СрезОбработки(t,e,i,n,r,a){Срез.apply(this,arguments),this.nContinuityCounter=-1,this.pPesPacketEnd=-1}Uint8Array.prototype.Копировать=function(t,e,i,n){this.set(new Uint8Array(e.buffer,i,Math.floor(n)-Math.floor(i)),t)},Uint8Array.prototype.ПрочестьБЦ64=function(t){return 4294967296*((this[t|=0]<<24|this[t+1|0]<<16|this[t+2|0]<<8|this[t+3|0])>>>0)+((this[t+4|0]<<24|this[t+5|0]<<16|this[t+6|0]<<8|this[t+7|0])>>>0)},Uint8Array.prototype.ПрочестьЗЦ32=function(t){return this[t|=0]<<24|this[t+1|0]<<16|this[t+2|0]<<8|this[t+3|0]},Uint8Array.prototype.ПрочестьБЦ32=function(t){return(this[t|=0]<<24|this[t+1|0]<<16|this[t+2|0]<<8|this[t+3|0])>>>0},Uint8Array.prototype.ПрочестьЗЦ16=function(t){return this[t|=0]<<24>>16|this[t+1|0]},Uint8Array.prototype.ПрочестьБЦ16=function(t){return this[t|=0]<<8|this[t+1|0]},Uint8Array.prototype.ЗаписатьЗЦ64=Uint8Array.prototype.ЗаписатьБЦ64=function(t,e){t|=0;var i=Math.trunc(e);if(i<Number.MIN_SAFE_INTEGER||i>Number.MAX_SAFE_INTEGER)throw new Error(e);var n=i/4294967296|0;this[t]=n>>24,this[t+1|0]=n>>16,this[t+2|0]=n>>8,this[t+3|0]=n,n=0|i,this[t+4|0]=n>>24,this[t+5|0]=n>>16,this[t+6|0]=n>>8,this[t+7|0]=n},Uint8Array.prototype.ЗаписатьЗЦ32=Uint8Array.prototype.ЗаписатьБЦ32=function(t,e){e|=0,this[t|=0]=e>>24,this[t+1|0]=e>>16,this[t+2|0]=e>>8,this[t+3|0]=e},Uint8Array.prototype.ЗаписатьЗЦ16=Uint8Array.prototype.ЗаписатьБЦ16=function(t,e){e|=0,this[t|=0]=e>>8,this[t+1|0]=e},ПотокБитов.prototype.ПропуститьБиты=function(t){if(Проверить(Number.isInteger(t)),Проверить((this.кБитОсталось-=t)>=0),1===t)--this._чСледующийБит<0&&(this._чСледующийБит=7,++this._уСледующийБайт);else{var e=this._чСледующийБит-t;e>=0?this._чСледующийБит=e:(e=-e-1,this._чСледующийБит=7-(7&e),this._уСледующийБайт+=1+(e>>>3))}},ПотокБитов.prototype.ПрочестьБиты=function(t){if(Проверить(Number.isInteger(t)),Проверить((this.кБитОсталось-=t)>=0),1===t)e=this._мбБуфер[this._уСледующийБайт]>>>this._чСледующийБит&1,--this._чСледующийБит<0&&(this._чСледующийБит=7,++this._уСледующийБайт);else{Проверить(t>=1&&t<=32);var e=0,i=t-1,n=(1<<this._чСледующийБит+1)-1;do{var r=this._мбБуфер[this._уСледующийБайт]&n;e|=this._чСледующийБит<i?r<<i-this._чСледующийБит:r>>>this._чСледующийБит-i;var a=Math.min(i,this._чСледующийБит)+1;(this._чСледующийБит-=a)<0&&(this._чСледующийБит=7,++this._уСледующийБайт,n=255)}while((i-=a)>=0)}return e>>>0},ПотокБитов.prototype.ПрочестьБеззнаковыйЭКГ=function(){for(var t=0;0===this.ПрочестьБиты(1);++t);return Проверить(t<=31),0===t?0:(1<<t>>>0)-1+this.ПрочестьБиты(t)},ПотокБитов.prototype.ПрочестьЗнаковыйЭКГ=function(){var t=this.ПрочестьБеззнаковыйЭКГ();return 0!=(1&t)?Math.ceil(t/2):-t/2},ПотокБитов.prototype.ПропуститьЭКГ=function(){for(var t=0;0===this.ПрочестьБиты(1);++t);0!==t&&this.ПропуститьБиты(t)},IsoBaseMedia.prototype.Завершить=function(){return Проверить(Number.isInteger(this.уКонец)&&this.уКонец>=this.уНачало&&this.уКонец<=this.мбБуфер.length),this.мбБуфер.subarray(this.уНачало,this.уКонец)},IsoBaseMedia.prototype.AddBox=function(t,e){return this.AddFullBox(t,-1,-1,e)},IsoBaseMedia.prototype.AddFullBox=function(t,e,i,n){Проверить(4===t.length&&Number.isFinite(e)&&Number.isFinite(i)),Проверить(this.уКонец>=this.уНачало);var r=this.уКонец;if(Проверить(this.мбБуфер.length-this.уКонец>=8),this.мбБуфер[r+4]=t.charCodeAt(0),this.мбБуфер[r+5]=t.charCodeAt(1),this.мбБуфер[r+6]=t.charCodeAt(2),this.мбБуфер[r+7]=t.charCodeAt(3),this.уКонец+=8,-1!==e&&(Проверить(e>=0&&e<=255&&i>=0&&i<=16777215),Проверить(this.мбБуфер.length-this.уКонец>=4),this.мбБуфер.ЗаписатьБЦ32(r+8,e<<24|i),this.уКонец+=4),"number"==typeof n)Проверить(Number.isInteger(n)&&n>=0),this.уКонец+=n,Проверить(this.уКонец<=this.мбБуфер.length);else if("function"==typeof n){var a=this.уКонец;n(),Проверить(Number.isInteger(this.уКонец)&&this.уКонец>=a&&this.уКонец<=this.мбБуфер.length)}else this.Копировать(this.уКонец,n);this.мбБуфер.ЗаписатьБЦ32(r,this.уКонец-r)},IsoBaseMedia.prototype.Копировать=function(t,e,i,n){Проверить(Number.isInteger(t)&&t>=this.уКонец),2===arguments.length?(this.мбБуфер.set(e,t),this.уКонец=t+e.length):(Проверить(Number.isInteger(i)&&Number.isInteger(n)),this.мбБуфер.Копировать(t,e,i,n),this.уКонец=t+n-i)},ID3._oUtf8Decoder=null,ID3.prototype.ПолучитьСледующееПоле=function(){if(this._кбТег>10){var t=this._мб[this._уТег],e=this._мб[this._уТег+1],i=this._мб[this._уТег+2],n=this._мб[this._уТег+3];if(t>=48&&t<=57||t>=65&&t<=90&&e>=48&&e<=57||e>=65&&e<=90&&i>=48&&i<=57||i>=65&&i<=90&&n>=48&&n<=57||n>=65&&n<=90){var r=this._ParseSynchsafeInteger(this._уТег+4);if(r>=1&&r<=this._кбТег-10&&0===this._мб[this._уТег+9])return this._уПоле=this._уТег+10,this._кбПоле=r,this._уТег+=10+r,this._кбТег-=10+r,String.fromCharCode(t,e,i,n)}}return this._уПоле=-1,this._кбПоле=-1,null},ID3.prototype.ПолучитьПервоеТекстовоеЗначение=function(){if(this._кбПоле<2||3!==this._мб[this._уПоле])return null;null===ID3._oUtf8Decoder&&(ID3._oUtf8Decoder=new TextDecoder("utf-8",{fatal:!0}));try{var t=ID3._oUtf8Decoder.decode(new Uint8Array(this._мб.buffer,this._уПоле+1,this._кбПоле-1))}catch(t){return null}var e=t.indexOf("\0");return-1===e?null:t.slice(0,e)},ID3.prototype._ParseSynchsafeInteger=function(t){var e=-1,i=this._мб[t];if(i<128){var n=i<<21;(i=this._мб[t+1])<128&&(n|=i<<14,(i=this._мб[t+2])<128&&(n|=i<<7,(i=this._мб[t+3])<128&&(e=n|i)))}return e},Срез.prototype.Пусто=function(){return Проверить(Number.isInteger(this.уНачалоПотока)&&Number.isInteger(this.уКонецПотока)&&this.уНачалоПотока>=0&&this.уНачалоПотока<=this.уКонецПотока),this.уКонецПотока===this.уНачалоПотока},Срез.prototype.ПолучитьРазмерПотока=function(){return Проверить(Number.isInteger(this.уНачалоПотока)&&Number.isInteger(this.уКонецПотока)&&this.уНачалоПотока>=0&&this.уНачалоПотока<=this.уКонецПотока),this.уКонецПотока-this.уНачалоПотока},Срез.prototype.ПолучитьРазмерСемплов=function(){return Проверить(Number.isInteger(this.уНачалоСемплов)&&Number.isInteger(this.уКонецСемплов)&&this.уНачалоСемплов>=0&&this.уНачалоСемплов<=this.уКонецСемплов),Проверить((this.уКонецСемплов-this.уНачалоСемплов)%this.кбСтруктураСемпла==0),this.уКонецСемплов-this.уНачалоСемплов},Срез.prototype.ПолучитьКоличествоСемплов=function(){return this.ПолучитьРазмерСемплов()/this.кбСтруктураСемпла},Срез.prototype.СложитьБеззнаковыйПараметр=function(t,e,i){Проверить(Number.isInteger(t)&&t>=0&&t<=this.кбСтруктураСемпла-4),Проверить(Number.isInteger(this.уНачалоСемплов)&&Number.isInteger(this.уКонецСемплов)&&this.уНачалоСемплов>=0&&this.уНачалоСемплов<=this.уКонецСемплов),Проверить(Number.isInteger(e)&&e>=this.уНачалоСемплов&&e<=this.уКонецСемплов),Проверить((this.уКонецСемплов-this.уНачалоСемплов)%this.кбСтруктураСемпла==0&&(e-this.уНачалоСемплов)%this.кбСтруктураСемпла==0);for(var n=0,r=this.уНачалоСемплов;r!==e;r+=this.кбСтруктураСемпла)n+=i.ПрочестьБЦ32(r+t);return n},Срез.prototype.Свернуть=function(){Проверить(Number.isInteger(this.уНачалоПотока)&&this.уНачалоПотока>=0),Проверить(Number.isInteger(this.уНачалоСемплов)&&this.уНачалоСемплов>=0),this.уКонецПотока=this.уНачалоПотока,this.уКонецСемплов=this.уНачалоСемплов,this.чВДНачала=-1},СрезОбработки.prototype=Object.create(Срез.prototype),СрезОбработки.prototype.constructor=СрезОбработки;const м_Журнал=(()=>{var t=[],e=[];function i(i,n){t.push(i),e.push(`[Worker] ${n}`)}return{"Вот":function(t){i("Вот",t)},"Окак":function(t){i("Окак",t)},"Ой":function(t){i("Ой",t)},"Отправить":function(){0!==t.length&&(postMessage([2,t,e]),t.length=0,e.length=0)}}})(),м_Балкон=(()=>{var t=null;return{"Положить":function(e){Проверить(!t),t=e},"Найти":function(e){var i=null;return t&&(t.length>=e?(м_Журнал.Вот(`Найдено барахло на ${t.length-e} больше запрашиваемого ${e}`),i=t,t=null):м_Журнал.Окак(`Найдено барахло на ${e-t.length} меньше запрашиваемого ${e}`)),i},"Освободить":function(){t&&(ВыброситьВПомойку(t),t=null)}}})();{const t=188,e=9e4,i=1024,n=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],r=1,a=2,s=4,o=16,_=0,u=4,h=8,c=12,d=_-o,f=250,l=20,m=1.3,p=1.3,P=1.5,v=2;var _оИсходныйСегмент=null,_мбВидеоПоток=null,_мбАудиоПоток=null,_мбМетаданные=null,_мбВидеоСемплы=null,_мбАудиоСемплы=null,_лРазрыв=!0,_оПараметры=null;const b=new СрезОбработки(o,0,0,0,0,-1),g=new СрезОбработки(s,0,0,0,0,-1),y=new СрезОбработки(0,0,0,0,0,0),A=new Срез(s,0,0,0,0,-1);var _лЗадержанРазрыв=!1,_оЗадержанныеПараметры=null;const S=new Срез(o,0,0,0,0,-1),x=new Срез(s,0,0,0,0,-1);var _уПотокПоследнегоКадра,_уСемплПоследнегоКадра,_уПотокПоследнегоКлючКадра,_уСемплПоследнегоКлючКадра,_чВДПоследнегоВидеоСемпла,_чВДКонцаАудиоСегмента,_nPatVersion,_nPmtVersion,_лЗабраковано,_лПотериВидео,_лПотериЗвука,_чМинДлительностьВидеоСемпла,_чМаксДлительностьВидеоСемпла,_чСредняяДлительностьВидеоСемпла,_чБитрейтЗвука,_чВремяКодирования,_чПозицияКодирования,_чНомерОтправляемогоСегмента,_чНачалоВидеоБуфера,_чКонецВидеоБуфера,_чНачалоАудиоБуфера,_чКонецАудиоБуфера,_чПреобразованЗа=NaN;function ОчиститьСтатистику(){_лЗабраковано=!1,_лПотериВидео=!1,_лПотериЗвука=!1,_чМинДлительностьВидеоСемпла=1/0,_чМаксДлительностьВидеоСемпла=-1/0,_чСредняяДлительностьВидеоСемпла=NaN,_чБитрейтЗвука=NaN,_чВремяКодирования=NaN,_чПозицияКодирования=NaN,_чНомерОтправляемогоСегмента=0}function ОсвободитьПамять(){ВыброситьВПомойку(_мбВидеоПоток),_мбВидеоПоток=null,ВыброситьВПомойку(_мбАудиоПоток),_мбАудиоПоток=null,ВыброситьВПомойку(_мбМетаданные),_мбМетаданные=null,ВыброситьВПомойку(_мбВидеоСемплы),_мбВидеоСемплы=null,ВыброситьВПомойку(_мбАудиоСемплы),_мбАудиоСемплы=null,_оПараметры=null,_оЗадержанныеПараметры=null,м_Балкон.Освободить()}function ВыделитьМассив(t,e,i,n,r){var a=Math.ceil(e+i);if(t&&t.length>=a)return t;a=Math.ceil(a*n),r&&(a=ОкруглитьРазмерКучиAsmJS(a)),м_Журнал[t?"Окак":"Вот"](`Увеличиваю массив с ${t?t.length:0} до ${a}`);var s=new Uint8Array(a);return 0!==e&&s.Копировать(0,t,0,e),ВыброситьВПомойку(t),s}function ВыделитьПамять(t,e){Проверить(0===S.уНачалоПотока&&0===x.уНачалоПотока),Проверить(0===S.уНачалоСемплов&&0===x.уНачалоСемплов),e+=2;var r=Math.ceil(f*e),a=r*l,_=t+a,u=t,h=o*r,c=s*n[0]/i*e;_мбВидеоПоток=ВыделитьМассив(_мбВидеоПоток,S.уКонецПотока,_,m,!1),_мбАудиоПоток=ВыделитьМассив(_мбАудиоПоток,x.уКонецПотока,u,p,!1),_мбВидеоСемплы=ВыделитьМассив(_мбВидеоСемплы,S.уКонецСемплов,h,P,!1),_мбАудиоСемплы=ВыделитьМассив(_мбАудиоСемплы,x.уКонецСемплов,c,P,!1),void 0===_мбВидеоПоток.НайтиПрефикс&&(_мбВидеоПоток.НайтиПрефикс=AsmJS(self,null,_мбВидеоПоток.buffer).SearchStartCodePrefix),b.уНачалоПотока=S.уКонецПотока+a,b.уНачалоСемплов=S.уКонецСемплов,b.Свернуть(),g.уНачалоПотока=x.уКонецПотока,g.уНачалоСемплов=x.уКонецСемплов,g.Свернуть(),y.уКонецПотока=y.уНачалоПотока}function РазобратьТранспортныйПоток(i){Проверить(b.уКонецПотока===b.уНачалоПотока&&b.уКонецСемплов===b.уНачалоСемплов&&-1===b.чВДНачала),Проверить(g.уКонецПотока===g.уНачалоПотока&&g.уКонецСемплов===g.уНачалоСемплов&&-1===g.чВДНачала),Проверить(-1!==y.чВДНачала),Браковать(0!==i.length&&i.length%t==0);var n=0,r=-1,a=-1,s=0,_=-1,h=-1,l=-1,m=-1,p="",P=0;b.pPesPacketEnd=g.pPesPacketEnd=y.pPesPacketEnd=-1,_лРазрыв&&(b.nContinuityCounter=g.nContinuityCounter=y.nContinuityCounter=-1,_nPatVersion=_nPmtVersion=-1);for(var A=i.length,x=0;x!==A;x+=t){var I=i.ПрочестьБЦ32(x);Браковать(1191182336==(4286578880&I));var $=(2096896&I)>>8,F=x+4;if(0!=(32&I)){var N=i[F];Проверить(N<=t-5),Проверить(0===N||0==(128&i[F+1])),F+=1+N}switch($){case _:0!=(4194304&I)&&Проверить(480==(4294967280&i.ПрочестьБЦ32(F)));var B=_мбВидеоПоток,M=b;break;case h:0!=(4194304&I)&&Проверить(448==(4294967264&i.ПрочестьБЦ32(F)));B=_мбАудиоПоток,M=g;break;case l:if(0!=(4194304&I)){Проверить(445===i.ПрочестьБЦ32(F));var w=i.ПрочестьБЦ16(F+4);Проверить(0!==w),p+=w+" ",_мбМетаданные=ВыделитьМассив(_мбМетаданные,0,w,v,!1),y.уКонецПотока=y.уНачалоПотока,y.pPesPacketEnd=-1}B=_мбМетаданные,M=y;break;case 0:++n,Проверить(4194320==(4194320&I));var E=ParseProgramAssociationTable(i,F,x+t);-1===_nPatVersion?_nPatVersion=E.nPatVersion:Проверить(_nPatVersion===E.nPatVersion),1===n?(r=E.nProgramNumber,a=E.nPmtPid):Проверить(r===E.nProgramNumber&&a===E.nPmtPid);continue;case a:++s,Проверить(4194320==(4194320&I));E=ParseProgramMapTable(i,F,x+t,r);-1===_nPmtVersion?_nPmtVersion=E.nPmtVersion:Проверить(_nPmtVersion===E.nPmtVersion),1===s?(_=E.nVideoPid,h=E.nAudioPid,l=E.nMetadataPid):Проверить(_===E.nVideoPid&&h===E.nAudioPid&&l===E.nMetadataPid);continue;default:continue}switch(M.nContinuityCounter!==(15&I)&&-1!==M.nContinuityCounter&&(м_Журнал.Ой(`continuity_counter равен ${15&I} вместо ${M.nContinuityCounter} PID=${$}`),Проверить(M.уКонецПотока===M.уНачалоПотока)),M.nContinuityCounter=I+1&15,4194320&I){case 16:Проверить(M.уКонецПотока!==M.уНачалоПотока);break;case 4194320:Проверить(M.pPesPacketEnd===M.уКонецПотока||-1===M.pPesPacketEnd);var k=i.ПрочестьБЦ16(F+4),D=i[F+8];if(0!==k?M.pPesPacketEnd=M.уКонецПотока+k-3-D:(Проверить($===_),M.pPesPacketEnd=-1),$===_||-1===M.чВДНачала){switch(61632&i.ПрочестьБЦ16(F+6)){case 32896:Проверить(D>=5);var C=T=DecodeTimestamp(i,F+9,33);break;case 32960:Проверить(D>=10);var T=DecodeTimestamp(i,F+9,49);C=DecodeTimestamp(i,F+14,17);break;default:Проверить(!1)}if(-1===M.чВДНачала&&(M.чВДНачала=C),$===_)if(C===m&&0!==k)Проверить(0==(4&i[F+6]));else{if(-1!==m){var U=C-m;U<=0&&(U>-10?(C=m+(U=1),++P):(Проверить(m>8589934592-60*e),Браковать(!1))),Проверить(U<60*e*10),_чМинДлительностьВидеоСемпла=Math.min(_чМинДлительностьВидеоСемпла,U),_чМаксДлительностьВидеоСемпла=Math.max(_чМаксДлительностьВидеоСемпла,U),_мбВидеоСемплы.ЗаписатьБЦ32(b.уКонецСемплов+d,U),_мбВидеоСемплы.ЗаписатьБЦ32(b.уКонецСемплов+u,b.уКонецПотока)}_мбВидеоСемплы.ЗаписатьЗЦ32(b.уКонецСемплов+c,T-C),b.уКонецСемплов+=o,m=C}else Проверить(T===C)}F+=9+D;break;default:Проверить(!1)}var V=x+t-F;Проверить(V>0),B.Копировать(M.уКонецПотока,i,F,F+V),M.уКонецПотока+=V}if(Проверить(b.pPesPacketEnd===b.уКонецПотока||-1===b.pPesPacketEnd),Проверить(g.pPesPacketEnd===g.уКонецПотока||-1===g.pPesPacketEnd),Проверить(y.pPesPacketEnd===y.уКонецПотока||-1===y.pPesPacketEnd),1===n&&1===s||м_Журнал.Ой(`Количество таблиц в сегменте: PAT=${n} PMT=${s}`),_лПотериВидео=b.Пусто(),_лПотериЗвука=g.Пусто(),_лПотериВидео||_лПотериЗвука)return м_Журнал.Ой(`Сегмент не годится для воспроизведения: нет видео ${_лПотериВидео}, нет звука ${_лПотериЗвука}`),!1;0!==P&&м_Журнал.Ой(`Количество видеосемплов с увеличенным ВД: ${P}`);var R=b.ПолучитьКоличествоСемплов();if(_чСредняяДлительностьВидеоСемпла=(m-b.чВДНачала)/(R-1),U=Number.isFinite(_чМинДлительностьВидеоСемпла)?_чМинДлительностьВидеоСемпла:e/f,_мбВидеоСемплы.ЗаписатьБЦ32(b.уКонецСемплов+d,U),м_Журнал.Вот(`ТранспортныхПакетов=${i.length/t}`+` ВДПервогоВидеоСемпла=${b.чВДНачала}`+` ВДПоследнегоВидеоСемпла=${m}`+` ВДПервогоАудиоСемпла=${g.чВДНачала}`+` ВидеоСемплов=${R}`+` ДлительностьВидеоСегмента>${((m-b.чВДНачала)/(e/1e3)).toFixed(2)}мс`+` СредняяДлительностьВидеоСемпла=${(_чСредняяДлительностьВидеоСемпла/(e/1e3)).toFixed(2)}мс(${(e/_чСредняяДлительностьВидеоСемпла).toFixed(2)}к/с)`+` МаксДлительностьВидеоСемпла=${(_чМаксДлительностьВидеоСемпла/(e/1e3)).toFixed(2)}мс(${(e/_чМаксДлительностьВидеоСемпла).toFixed(2)}к/с)`+` МинДлительностьВидеоСемпла=${(_чМинДлительностьВидеоСемпла/(e/1e3)).toFixed(2)}мс(${(e/_чМинДлительностьВидеоСемпла).toFixed(2)}к/с)`+` Метаданные=${p}`),!_лРазрыв){var q=g.чВДНачала-_чВДКонцаАудиоСегмента;Math.abs(q)>2&&м_Журнал.Ой(`Отклонение ВД аудиосегмента ${q}`),q>e/1e3*100&&(_лПотериЗвука=!0),Проверить(q>-e*_оИсходныйСегмент.чДлительность*2)}return _лРазрыв||S.Пусто()||(U=b.чВДНачала-_чВДПоследнегоВидеоСемпла,м_Журнал.Вот(`Длительность последнего задержанного видеосемпла ${(U/(e/1e3)).toFixed(2)}мс`),Проверить(U>0),_мбВидеоСемплы.ЗаписатьБЦ32(S.уКонецСемплов+d,U),_чСредняяДлительностьВидеоСемпла=(m-_чВДПоследнегоВидеоСемпла)/R,_чМинДлительностьВидеоСемпла=Math.min(_чМинДлительностьВидеоСемпла,U),_чМаксДлительностьВидеоСемпла=Math.max(_чМаксДлительностьВидеоСемпла,U)),_чВДПоследнегоВидеоСемпла=m,_чПозицияКодирования=Math.min(b.чВДНачала,g.чВДНачала)/e,!0}function DecodeTimestamp(t,e,i){var n=0|t[e],r=0|t.ПрочестьБЦ32(e+1);return Проверить((241&n)==(0|i)&&65537==(65537&r)),+((14&n)*(1<<29)+(r>>2&1073709056|r>>1&32767))}function ParseProgramAssociationTable(t,e,i){Проверить(e<i),Проверить(i-(e+=1+t[e])>=16),Проверить(0===t[e]),Проверить(32781==(53247&t.ПрочестьБЦ16(e+1))),Проверить(1==(1&t[e+5]));var n=62&t[e+5];Проверить(0===t[e+6]),Проверить(0===t[e+7]);var r=t.ПрочестьБЦ16(e+8);Проверить(0!==r);var a=8191&t.ПрочестьБЦ16(e+10);return Проверить(a>=16&&a<=8190),_лРазрыв&&м_Журнал.Вот(`PatVersion=${n} ProgramNumber=${r} PmtPid=${a}`),{nPatVersion:n,nProgramNumber:r,nPmtPid:a}}function ParseProgramMapTable(t,e,i,n){Проверить(e<i),Проверить(i-(e+=1+t[e])>=12),Проверить(2===t[e]);var r=t.ПрочестьБЦ16(e+1);Проверить(32768==(49152&r)),Проверить((r=e+3+(4095&r)-4)>=e+12&&r+4<=i),Проверить(t.ПрочестьБЦ16(e+3)===n),Проверить(1==(1&t[e+5]));var a=62&t[e+5];Проверить(0===t[e+6]),Проверить(0===t[e+7]),e+=12+(4095&t.ПрочестьБЦ16(e+10));for(var s=-1,o=-1,_=-1;e!==r;e=u+c){var u=e+5;Проверить(u<=r);var h=8191&t.ПрочестьБЦ16(e+1);Проверить(h>=16&&h<=8190);var c=4095&t.ПрочестьБЦ16(e+3);switch(Проверить(u+c<=r),t[e]){case 27:-1===s?s=h:м_Журнал.Ой(`Найден дополнительный видеопоток PID=${h}`);break;case 15:-1===o?o=h:м_Журнал.Ой(`Найден дополнительный аудиопоток PID=${h}`);break;case 21:15===c&&38===t[u]&&13===t[u+1]&&255===t[u+2]&&255===t[u+3]&&73===t[u+4]&&68===t[u+5]&&51===t[u+6]&&32===t[u+7]&&255===t[u+8]&&73===t[u+9]&&68===t[u+10]&&51===t[u+11]&&32===t[u+12]&&0===t[u+13]&&(-1===_?_=h:м_Журнал.Ой(`Найдены дополнительные метаданные PID=${h}`))}}return _лРазрыв&&м_Журнал.Вот(`PmtVersion=${a} VideoPid=${s} AudioPid=${o} MetadataPid=${_}`),-1!==s&&-1!==o||ЗавершитьРаботуИПоказатьСообщение("J0207"),{nPmtVersion:a,nVideoPid:s,nAudioPid:o,nMetadataPid:_}}function РазобратьМетаданные(){if(!y.Пусто())for(var t,e=new ID3(_мбМетаданные,y.уНачалоПотока,y.уКонецПотока);t=e.ПолучитьСледующееПоле();)if("TDEN"===t){var i=e.ПолучитьПервоеТекстовоеЗначение();Проверить(null!==i),_чВремяКодирования=Date.parse(19===i.length?i+"Z":i),Проверить(!Number.isNaN(_чВремяКодирования));break}}function РазобратьВидеоПоток(){Проверить(b.уКонецПотока!==b.уНачалоПотока),Проверить(b.уКонецСемплов!==b.уНачалоСемплов),_уПотокПоследнегоКлючКадра=_уСемплПоследнегоКлючКадра=-1,_уСемплПоследнегоКадра=b.уНачалоСемплов-o;var t,e=S.уКонецПотока,i=0,n=0,r=0,a=0,s=-1,_=-1,c=_мбВидеоПоток.НайтиПрефикс(b.уНачалоПотока,b.уКонецПотока);for(Проверить(-1!==c),Браковать(-2!==c),Проверить(c===b.уНачалоПотока);;){const f=c===b.уКонецПотока?0:_мбВидеоПоток[c]|_мбВидеоПоток[c+1]<<8;Проверить(3!==f||-1!==_);const l=c+f-Math.min(4,f)>=_;if(l&&-1!==_&&(-1===t&&(t=65536,++r),Проверить(e>_уПотокПоследнегоКадра),_мбВидеоСемплы.ЗаписатьБЦ32(_уСемплПоследнегоКадра+u,e-_уПотокПоследнегоКадра),_мбВидеоСемплы.ЗаписатьБЦ32(_уСемплПоследнегоКадра+h,t)),c===b.уКонецПотока){Проверить(_уСемплПоследнегоКадра+o===b.уКонецСемплов);break}const m=c+f;if(Проверить(-1!==(c=_мбВидеоПоток.НайтиПрефикс(m,b.уКонецПотока))),Браковать(-2!==c),l&&(Проверить((_уСемплПоследнегоКадра+=o)<b.уКонецСемплов),_=_уСемплПоследнегоКадра+o===b.уКонецСемплов?b.уКонецПотока:_мбВидеоСемплы.ПрочестьБЦ32(_уСемплПоследнегоКадра+o+u),_уПотокПоследнегоКадра=e,t=-1,1===a&&(a=0)),m===c)continue;++i;const p=224&_мбВидеоПоток[m];switch(Браковать(p<128),31&_мбВидеоПоток[m]){case 1:case 2:case 3:case 4:Проверить(0!==t),t=65536;break;case 5:Проверить(0!==p),0!==t&&(Проверить(65536!==t),t=0,_уПотокПоследнегоКлючКадра=_уПотокПоследнегоКадра,_уСемплПоследнегоКлючКадра=_уСемплПоследнегоКадра,-1===s&&(s=_уСемплПоследнегоКадра),++n);break;case 6:Проверить(0===p);break;case 7:Проверить(0!==p),!_лРазрыв||-1!==_уСемплПоследнегоКлючКадра&&void 0!==_оПараметры.abSequenceParameterSet||(_оПараметры.abSequenceParameterSet=_мбВидеоПоток.slice(m,c));continue;case 8:Проверить(0!==p),!_лРазрыв||-1!==_уСемплПоследнегоКлючКадра&&void 0!==_оПараметры.abPictureParameterSet||(_оПараметры.abPictureParameterSet=_мбВидеоПоток.slice(m,c));continue;case 9:Проверить(0===p),++a;continue;case 10:Проверить(0===p);continue;case 11:Проверить(0===p),Проверить(!1);continue;case 12:Проверить(0===p);continue;case 13:Проверить(0!==p),!_лРазрыв||-1!==_уСемплПоследнегоКлючКадра&&void 0!==_оПараметры.abSequenceParameterSetExt||(_оПараметры.abSequenceParameterSetExt=_мбВидеоПоток.slice(m,c)),Проверить(!1);continue}var d=c-m;_мбВидеоПоток.ЗаписатьБЦ32(e,d),e+=4,_мбВидеоПоток.copyWithin(e,m,c),e+=d}if(м_Журнал.Вот("NalUnits="+i+" КоличествоКлючКадров="+n+" ПервыйКлючКадр="+(s-b.уНачалоСемплов)/o+" ПоследнийКлючКадр="+(_уСемплПоследнегоКлючКадра-b.уНачалоСемплов)/o),0!==r&&м_Журнал.Ой(`Видеосемплов без VCL NAL unit: ${r}`),a>1&&м_Журнал.Ой("Несколько access unit в одном видеосемпле"),b.уНачалоПотока=S.уКонецПотока,b.уКонецПотока=e,_лРазрыв){if(-1===_уСемплПоследнегоКлючКадра||void 0===_оПараметры.abSequenceParameterSet||void 0===_оПараметры.abPictureParameterSet)return м_Журнал.Ой(`Сегмент не годится для воспроизведения: не найден IDR ${-1===_уСемплПоследнегоКлючКадра}, не найден SPS ${void 0===_оПараметры.abSequenceParameterSet}, не найден PPS ${void 0===_оПараметры.abPictureParameterSet}`),!1;var f=_оПараметры.abSequenceParameterSet.slice(),l=RemoveEmulationPreventionBytesFromNalUnit(f,0,f.length);ParseSequenceParameterSet(f,l.уНачалоRBSP,l.уКонецRBSP)}return!0}function ParseSequenceParameterSet(t,e,i){var n=t[e],r=t[e+1],a=t[e+2],s=new ПотокБитов(t,e+3,i),o=s.ПрочестьБеззнаковыйЭКГ();Проверить(o<32);var _=1,u=0,h=0,c=0;switch(n){case 183:_=0;break;case 100:case 110:case 122:case 244:case 44:case 83:case 86:case 118:case 128:case 138:case 139:case 134:if(Проверить((_=s.ПрочестьБеззнаковыйЭКГ())<=3),3===_&&(u=s.ПрочестьБиты(1)),Проверить((h=s.ПрочестьБеззнаковыйЭКГ())<=6),Проверить((c=s.ПрочестьБеззнаковыйЭКГ())<=6),s.ПропуститьБиты(1),0!==s.ПрочестьБиты(1))for(var d=0,f=3!==_?8:12;d<f;++d)if(0!==s.ПрочестьБиты(1))for(var l=8,m=8,p=0,P=d<6?16:64;p<P;++p)0!==m&&(m=(l+s.ПрочестьЗнаковыйЭКГ()+256)%256),0!==m&&(l=m)}switch(s.ПропуститьЭКГ(),s.ПрочестьБеззнаковыйЭКГ()){case 0:s.ПропуститьЭКГ();break;case 1:s.ПропуститьБиты(1),s.ПропуститьЭКГ(),s.ПропуститьЭКГ();for(d=0,f=s.ПрочестьБеззнаковыйЭКГ();d<f;++d)s.ПропуститьЭКГ()}var v=s.ПрочестьБеззнаковыйЭКГ();s.ПропуститьБиты(1);var b=s.ПрочестьБеззнаковыйЭКГ()+1,g=s.ПрочестьБеззнаковыйЭКГ()+1,y=s.ПрочестьБиты(1);if(0===y&&s.ПропуститьБиты(1),s.ПропуститьБиты(1),0!==s.ПрочестьБиты(1))var A=s.ПрочестьБеззнаковыйЭКГ(),S=s.ПрочестьБеззнаковыйЭКГ(),x=s.ПрочестьБеззнаковыйЭКГ(),I=s.ПрочестьБеззнаковыйЭКГ();else A=0,S=0,x=0,I=0;if(0!==s.ПрочестьБиты(1)){if(0!==s.ПрочестьБиты(1)){var $=s.ПрочестьБиты(8);if(255===$)var F=s.ПрочестьБиты(16),N=s.ПрочестьБиты(16)}if(0!==s.ПрочестьБиты(1)&&s.ПропуститьБиты(1),0!==s.ПрочестьБиты(1)){var B=s.ПрочестьБиты(3),M=s.ПрочестьБиты(1);0!==s.ПрочестьБиты(1)&&s.ПропуститьБиты(24)}if(0!==s.ПрочестьБиты(1)&&(s.ПропуститьЭКГ(),s.ПропуститьЭКГ()),0!==s.ПрочестьБиты(1))var w=s.ПрочестьБиты(32),E=s.ПрочестьБиты(32),k=s.ПрочестьБиты(1)}var D=1,C=1;0===u&&0!==_&&(D=3===_?1:2,C=1===_?2:1),0===y&&(C+=C,g+=g),_оПараметры.чШиринаКартинки=16*b-D*S-D*A,_оПараметры.чВысотаКартинки=16*g-C*I-C*x,_оПараметры.nProfileIndication=n,_оПараметры.nConstraintSetFlag=r,_оПараметры.nLevelIndication=a,_оПараметры.nChromaFormatIndication=_,_оПараметры.nBitDepthLumaMinus8=h,_оПараметры.nBitDepthChromaMinus8=c,_оПараметры.nMaxNumberReferenceFrames=v,_оПараметры.чДиапазон=void 0===M?-1:M,_оПараметры.лЧересстрочное=0===y,_оПараметры.чЧастотаКадров=void 0===E?0:E/w/(0===k?-2:2),м_Журнал.Вот("ШиринаКартинки="+_оПараметры.чШиринаКартинки+" ВысотаКартинки="+_оПараметры.чВысотаКартинки+" ProfileIndication="+n+" ConstraintSetFlag=0x"+r.toString(16)+" LevelIndication="+(a/10).toFixed(1)+" MaxNumberReferenceFrames="+v+" SequenceParameterSetId="+o+" AspectRatioIndication="+$+" SarWidth="+F+" SarHeight="+N+" VideoFormat="+B+" VideoFullRangeFlag="+M+" TimeScale="+E+" NumUnitsInTick="+w+" FixedFrameRateFlag="+k),0===y&&м_Журнал.Ой("Чересстрочное видео")}function RemoveEmulationPreventionBytesFromNalUnit(t,e,i){Проверить(e<i);var n=31&t[e++];14!==n&&20!==n&&21!==n||(Проверить(e<i),Проверить((e+=21===n&&0!=(128&t[e])?2:3)<=i));for(var r=e,a=i-2;e<a;)if(0===t[e++]&&0===t[e++]){var s=t[e++];if(Проверить(s>=3),3===s){var o=e-1;for(Проверить(e===i||t[e]<=3);e<a;)0===(t[o++]=t[e++])&&0===(t[o++]=t[e++])&&(Проверить((s=t[o++]=t[e++])>=3),3===s&&(--o,Проверить(e===i||t[e]<=3)));for(;e!==i;)var _=t[o++]=t[e++];return Проверить(0!==_),{"уНачалоRBSP":r,"уКонецRBSP":o}}}return Проверить(e===i||0!==t[i-1]),{"уНачалоRBSP":r,"уКонецRBSP":i}}function РазобратьАудиоПоток(){Проверить(g.уКонецПотока!==g.уНачалоПотока),Проверить(g.уКонецСемплов===g.уНачалоСемплов),_лРазрыв&&(Проверить(g.ПолучитьРазмерПотока()>7),ParseAdtsFixedHeader(_мбАудиоПоток.ПрочестьБЦ32(g.уНачалоПотока)));for(var t=g.уНачалоПотока,n=g.уНачалоПотока,r=g.уНачалоСемплов,a=g.уКонецПотока-7;t<a;){Проверить(255===_мбАудиоПоток[t]&&241===_мбАудиоПоток[t+1]),Проверить(0==(3&_мбАудиоПоток[t+6]));var o=_мбАудиоПоток.ПрочестьБЦ32(t+3)>>13&8191,_=t+o;Проверить(o>7&&_<=g.уКонецПотока),_мбАудиоПоток.copyWithin(n,t+7,_),n+=o-=7,_мбАудиоСемплы.ЗаписатьБЦ32(r,o),r+=s,t=_}Проверить(t===g.уКонецПотока),g.уКонецПотока=n,g.уКонецСемплов=r;var u=g.ПолучитьКоличествоСемплов(),h=i/_оПараметры.чЧастотаДискретизации,c=u*h;return _чВДКонцаАудиоСегмента=g.чВДНачала+Math.round(c*e),_чБитрейтЗвука=8*g.ПолучитьРазмерПотока()/1e3/c,м_Журнал.Вот(`АудиоСемплов=${u}`+` ВДКонцаАудиоСегмента=${_чВДКонцаАудиоСегмента}`+` ДлительностьАудиоСемпла=${(1e3*h).toFixed(2)}мс`+` ДлительностьАудиоСегмента=${(1e3*c).toFixed(2)}мс`+` СмещениеНачалаАудиоСегмента=${((g.чВДНачала-b.чВДНачала)/(e/1e3)).toFixed(2)}мс`+` ПредполагаемоеСмещениеКонцаАудиоСегмента=${((_чВДКонцаАудиоСегмента-_чВДПоследнегоВидеоСемпла-_чСредняяДлительностьВидеоСемпла)/(e/1e3)).toFixed(2)}мс`),!0}function ParseAdtsFixedHeader(t){Проверить(-983040==(4294901760&t)),_оПараметры.aDecoderSpecificInfo=[0,0],_оПараметры.nAudioObjectType=1+(t>>14&3),_оПараметры.aDecoderSpecificInfo[0]=_оПараметры.nAudioObjectType<<3;var e=t>>10&15;_оПараметры.чЧастотаДискретизации=n[e],Проверить(void 0!==_оПараметры.чЧастотаДискретизации),_оПараметры.aDecoderSpecificInfo[0]|=e>>1,_оПараметры.aDecoderSpecificInfo[1]=e<<7&128,_оПараметры.чКоличествоКаналов=t>>6&7,Проверить(0!==_оПараметры.чКоличествоКаналов),_оПараметры.aDecoderSpecificInfo[1]|=_оПараметры.чКоличествоКаналов<<3,м_Журнал[2!==_оПараметры.nAudioObjectType||_оПараметры.чЧастотаДискретизации<44100||_оПараметры.чКоличествоКаналов>2?"Ой":"Вот"](`AudioObjectType=${_оПараметры.nAudioObjectType} ЧастотаДискретизации=${_оПараметры.чЧастотаДискретизации} КоличествоКаналов=${_оПараметры.чКоличествоКаналов}`)}function ПолучитьНазваниеВидеоКодека(t){return"avc1."+("0"+t.nProfileIndication.toString(16)).slice(-2)+("0"+t.nConstraintSetFlag.toString(16)).slice(-2)+("0"+t.nLevelIndication.toString(16)).slice(-2)}function ПолучитьНазваниеАудиоКодека(t){return`mp4a.40.${t.nAudioObjectType}`}function СоздатьСегментИнициализации(t,e){var n=1111+t.abSequenceParameterSet.length+t.abPictureParameterSet.length+(t.abSequenceParameterSetExt?t.abSequenceParameterSetExt.length:0)+t.aDecoderSpecificInfo.length,s=new IsoBaseMedia(new Uint8Array(n),0);s.AddBox("ftyp",[105,115,111,54,0,0,0,0,97,118,99,49]),s.AddBox("moov",()=>{s.AddFullBox("mvhd",1,0,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,255,255,255,255,255,255,255,255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]),s.AddBox("mvex",()=>{s.AddFullBox("trex",0,0,20),s.мбБуфер.ЗаписатьБЦ32(s.уКонец-20,r),s.мбБуфер.ЗаписатьБЦ32(s.уКонец-16,1),s.AddFullBox("trex",0,0,20),s.мбБуфер.ЗаписатьБЦ32(s.уКонец-20,a),s.мбБуфер.ЗаписатьБЦ32(s.уКонец-16,1),s.мбБуфер.ЗаписатьБЦ32(s.уКонец-12,i)}),ДобавитьДорожку(t,!0,s),ДобавитьДорожку(t,!1,s)}),e.мбСегментИнициализации=s.Завершить(),e.сКодеки='video/mp4; codecs="'+ПолучитьНазваниеВидеоКодека(t)+", "+ПолучитьНазваниеАудиоКодека(t)+'"'}function ДобавитьДорожку(t,i,n){n.AddBox("trak",()=>{n.AddFullBox("tkhd",0,3,80),n.мбБуфер.ЗаписатьБЦ32(n.уКонец-64,4294967295),n.мбБуфер[n.уКонец-43]=1,n.мбБуфер[n.уКонец-27]=1,n.мбБуфер[n.уКонец-12]=64,i?(n.мбБуфер.ЗаписатьБЦ32(n.уКонец-72,r),n.мбБуфер.ЗаписатьБЦ16(n.уКонец-8,t.чШиринаКартинки),n.мбБуфер.ЗаписатьБЦ16(n.уКонец-4,t.чВысотаКартинки)):(n.мбБуфер.ЗаписатьБЦ32(n.уКонец-72,a),n.мбБуфер.ЗаписатьБЦ16(n.уКонец-48,256)),n.AddBox("mdia",()=>{n.AddFullBox("mdhd",0,0,20),n.мбБуфер.ЗаписатьБЦ32(n.уКонец-12,i?e:t.чЧастотаДискретизации),n.мбБуфер[n.уКонец-8]=255,n.мбБуфер[n.уКонец-7]=255,n.мбБуфер[n.уКонец-6]=255,n.мбБуфер[n.уКонец-5]=255,n.мбБуфер[n.уКонец-4]=85,n.мбБуфер[n.уКонец-3]=196,n.AddFullBox("hdlr",0,0,i?[0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,67,111,111,108,67,109,100,86,105,100,53,0]:[0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,67,111,111,108,67,109,100,65,117,100,53,0]),n.AddBox("minf",()=>{i?n.AddFullBox("vmhd",0,1,8):n.AddFullBox("smhd",0,0,4),n.AddBox("dinf",()=>{n.AddFullBox("dref",0,0,()=>{n.мбБуфер.ЗаписатьБЦ32(n.уКонец,1),n.уКонец+=4,n.AddFullBox("url ",0,1,0)})}),n.AddBox("stbl",()=>{n.AddFullBox("stsd",0,0,()=>{n.мбБуфер.ЗаписатьБЦ32(n.уКонец,1),n.уКонец+=4,i?n.AddBox("avc1",()=>{n.мбБуфер.ЗаписатьБЦ16(n.уКонец+6,1),n.мбБуфер.ЗаписатьБЦ16(n.уКонец+24,t.чШиринаКартинки),n.мбБуфер.ЗаписатьБЦ16(n.уКонец+26,t.чВысотаКартинки),n.мбБуфер.ЗаписатьБЦ32(n.уКонец+28,4718592),n.мбБуфер.ЗаписатьБЦ32(n.уКонец+32,4718592),n.мбБуфер.ЗаписатьБЦ16(n.уКонец+40,1),n.мбБуфер.ЗаписатьБЦ16(n.уКонец+74,24),n.мбБуфер.ЗаписатьБЦ16(n.уКонец+76,65535),n.уКонец+=78,n.AddBox("avcC",()=>{switch(n.мбБуфер[n.уКонец]=1,n.мбБуфер[n.уКонец+1]=t.nProfileIndication,n.мбБуфер[n.уКонец+2]=t.nConstraintSetFlag,n.мбБуфер[n.уКонец+3]=t.nLevelIndication,n.мбБуфер[n.уКонец+4]=255,n.мбБуфер[n.уКонец+5]=225,n.мбБуфер.ЗаписатьБЦ16(n.уКонец+6,t.abSequenceParameterSet.length),n.Копировать(n.уКонец+8,t.abSequenceParameterSet),n.мбБуфер[n.уКонец]=1,n.мбБуфер.ЗаписатьБЦ16(n.уКонец+1,t.abPictureParameterSet.length),n.Копировать(n.уКонец+3,t.abPictureParameterSet),t.nProfileIndication){case 100:case 110:case 122:case 144:n.мбБуфер[n.уКонец]=252|t.nChromaFormatIndication,n.мбБуфер[n.уКонец+1]=248|t.nBitDepthLumaMinus8,n.мбБуфер[n.уКонец+2]=248|t.nBitDepthChromaMinus8,void 0===t.abSequenceParameterSetExt?n.уКонец+=4:(n.мбБуфер[n.уКонец+3]=1,n.мбБуфер.ЗаписатьБЦ16(n.уКонец+4,t.abSequenceParameterSetExt.length),n.Копировать(n.уКонец+6,t.abSequenceParameterSetExt))}})}):n.AddBox("mp4a",()=>{n.мбБуфер.ЗаписатьБЦ16(n.уКонец+6,1),n.мбБуфер.ЗаписатьБЦ16(n.уКонец+18,16),n.уКонец+=28,n.AddFullBox("esds",0,0,()=>{n.мбБуфер[n.уКонец]=3,n.мбБуфер[n.уКонец+1]=23+t.aDecoderSpecificInfo.length,n.мбБуфер.ЗаписатьБЦ16(n.уКонец+2,1),n.мбБуфер[n.уКонец+5]=4,n.мбБуфер[n.уКонец+6]=15+t.aDecoderSpecificInfo.length,n.мбБуфер[n.уКонец+7]=64,n.мбБуфер[n.уКонец+8]=21,n.мбБуфер[n.уКонец+20]=5,n.мбБуфер[n.уКонец+21]=t.aDecoderSpecificInfo.length,n.Копировать(n.уКонец+22,t.aDecoderSpecificInfo),n.мбБуфер[n.уКонец]=6,n.мбБуфер[n.уКонец+1]=1,n.мбБуфер[n.уКонец+2]=2,n.уКонец+=3})})}),n.AddFullBox("stts",0,0,4),n.AddFullBox("stsc",0,0,4),n.AddFullBox("stco",0,0,4),n.AddFullBox("stsz",0,0,8)})})})})}function СоздатьМедиасегмент(t,i,n,s,o){Проверить(!i.Пусто()||!n.Пусто());var _,u=160+i.ПолучитьРазмерПотока()+i.ПолучитьРазмерСемплов()+n.ПолучитьРазмерПотока()+n.ПолучитьРазмерСемплов();o&&(_=м_Балкон.Найти(u)),_||(_=new Uint8Array(u));var h,c,d=new IsoBaseMedia(_,0);d.AddBox("moof",()=>{d.AddFullBox("mfhd",0,0,4),_.ЗаписатьБЦ32(d.уКонец-4,0),i.Пусто()||d.AddBox("traf",()=>{d.AddFullBox("tfhd",0,131072,4),_.ЗаписатьБЦ32(d.уКонец-4,r),d.AddFullBox("tfdt",1,0,8),_.ЗаписатьБЦ64(d.уКонец-8,i.чВДНачала),d.AddFullBox("trun",1,3841,()=>{_.ЗаписатьБЦ32(d.уКонец,i.ПолучитьКоличествоСемплов()),h=d.уКонец+4,d.Копировать(d.уКонец+8,_мбВидеоСемплы,i.уНачалоСемплов,i.уКонецСемплов)})}),n.Пусто()||d.AddBox("traf",()=>{d.AddFullBox("tfhd",0,131072,4),_.ЗаписатьБЦ32(d.уКонец-4,a),d.AddFullBox("tfdt",1,0,8),_.ЗаписатьБЦ64(d.уКонец-8,n.чВДНачала/e*t.чЧастотаДискретизации),d.AddFullBox("trun",1,513,()=>{_.ЗаписатьБЦ32(d.уКонец,n.ПолучитьКоличествоСемплов()),c=d.уКонец+4,d.Копировать(d.уКонец+8,_мбАудиоСемплы,n.уНачалоСемплов,n.уКонецСемплов)})})}),d.AddBox("mdat",()=>{i.Пусто()||(_.ЗаписатьЗЦ32(h,d.уКонец-d.уНачало),d.Копировать(d.уКонец,_мбВидеоПоток,i.уНачалоПотока,i.уКонецПотока)),n.Пусто()||(_.ЗаписатьЗЦ32(c,d.уКонец-d.уНачало),d.Копировать(d.уКонец,_мбАудиоПоток,n.уНачалоПотока,n.уКонецПотока))}),s.мбМедиасегмент=d.Завершить()}function Отправить(t,i,n,r,a,s){if(a||!n.Пусто()||!r.Пусто()){var o,_=Object.create(null),u=0,h=_оИсходныйСегмент.чНомер+(_чНомерОтправляемогоСегмента+=.1);a&&(_.чПреобразованЗа=_чПреобразованЗа,_.лЗабраковано=_лЗабраковано,_.лПотериВидео=_лПотериВидео,_.лПотериЗвука=_лПотериЗвука,_.чМинДлительностьВидеоСемпла=_чМинДлительностьВидеоСемпла/(e/1e3),_.чМаксДлительностьВидеоСемпла=_чМаксДлительностьВидеоСемпла/(e/1e3),_.чСредняяДлительностьВидеоСемпла=_чСредняяДлительностьВидеоСемпла/(e/1e3),_.чБитрейтЗвука=_чБитрейтЗвука,_.чВремяКодирования=_чВремяКодирования,_.чПозицияКодирования=_чПозицияКодирования),(n&&!n.Пусто()||r&&!r.Пусто())&&(СоздатьМедиасегмент(i,n,r,_,s),o=[_.мбМедиасегмент.buffer],u=ПолучитьДлительностьОтправляемогоСегмента(t,i,n,r,h,_),t&&(СоздатьСегментИнициализации(i,_),_.чШиринаКартинки=i.чШиринаКартинки,_.чВысотаКартинки=i.чВысотаКартинки,_.nProfileIndication=i.nProfileIndication,_.nConstraintSetFlag=i.nConstraintSetFlag,_.nLevelIndication=i.nLevelIndication,_.nMaxNumberReferenceFrames=i.nMaxNumberReferenceFrames,_.чДиапазон=i.чДиапазон,_.лЧересстрочное=i.лЧересстрочное,_.чЧастотаКадров=i.чЧастотаКадров,_.nAudioObjectType=i.nAudioObjectType,_.чЧастотаДискретизации=i.чЧастотаДискретизации,_.чКоличествоКаналов=i.чКоличествоКаналов,o.push(_.мбСегментИнициализации.buffer)))}м_Журнал.Отправить(),_&&postMessage([1,{"пДанные":_,"чДлительность":u,"лРазрыв":t,"чTwitchПрошлоВремени":a?_оИсходныйСегмент.чTwitchПрошлоВремени:NaN,"чНомер":h}],o)}function ПолучитьДлительностьОтправляемогоСегмента(t,n,r,a,s,o){t&&(_чНачалоВидеоБуфера=_чКонецВидеоБуфера=_чНачалоАудиоБуфера=_чКонецАудиоБуфера=-1);var u="Вот",h=_чКонецВидеоБуфера,c="";if(!r.Пусто()){var d=r.чВДНачала/e;Проверить(d>=_чКонецВидеоБуфера),-1===_чНачалоВидеоБуфера&&(_чНачалоВидеоБуфера=d),Проверить((h=(r.чВДНачала+r.СложитьБеззнаковыйПараметр(_,r.уКонецСемплов,_мбВидеоСемплы))/e)>=d),c=` Видео=${d.toFixed(3)}-${h.toFixed(3)}`;var f=r.ПолучитьКоличествоСемплов();f<8&&(u="Ой",c=` Видеосемплов=${f}${c}`)}var l=_чКонецАудиоБуфера,m="";if(!a.Пусто()){var p=a.чВДНачала/e;-1===_чНачалоАудиоБуфера&&(_чНачалоАудиоБуфера=p),Проверить((l=p+a.ПолучитьКоличествоСемплов()*i/n.чЧастотаДискретизации)>=p),m=` Звук=${p.toFixed(3)}-${l.toFixed(3)}`}var P=Math.max(_чНачалоВидеоБуфера,_чНачалоАудиоБуфера,Math.min(_чКонецВидеоБуфера,_чКонецАудиоБуфера)),v=Math.max(_чНачалоВидеоБуфера,_чНачалоАудиоБуфера,Math.min(_чКонецВидеоБуфера=h,_чКонецАудиоБуфера=l))-P;return м_Журнал[u](`Отправляю сегмент ${s} Разрыв=${t}`+` Длительность=${v.toFixed(3)}${c}${m}`+` Размер=${(o.мбМедиасегмент.length/1024/1024).toFixed(2)}мб`),v}function РазделитьИОтправитьОбработанныйСегмент(){var t=_уПотокПоследнегоКадра,e=_уСемплПоследнегоКадра;if(e!==_уСемплПоследнегоКлючКадра){var i=Math.min(17,b.ПолучитьКоличествоСемплов());if(i>1)for(var n=e,r=t,a=0,s=_мбВидеоСемплы.ПрочестьЗЦ32(n+c);0!=--i;){n-=o,r-=_мбВидеоСемплы.ПрочестьБЦ32(n+u);var h=(a-=_мбВидеоСемплы.ПрочестьБЦ32(n+_))+_мбВидеоСемплы.ПрочестьЗЦ32(n+c);h>s&&(s=h,e=n,t=r)}}if(_лРазрыв)if(Проверить(-1!==e),e===b.уНачалоСемплов)Отправить(_лЗадержанРазрыв,_оЗадержанныеПараметры,S,x,!1,!0),Задержать(_лРазрыв,_оПараметры,b,g),Отправить(!1,null,null,null,!0,!1);else if(e===b.уКонецСемплов)Отправить(_лЗадержанРазрыв,_оЗадержанныеПараметры,S,x,!1,!1),Отправить(_лРазрыв,_оПараметры,b,g,!0,!0);else{Отправить(_лЗадержанРазрыв,_оЗадержанныеПараметры,S,x,!1,!1);var d=РазделитьОбработанныйСегмент(t,e);Отправить(_лРазрыв,_оПараметры,d[0],d[2],!0,!0),Задержать(!1,_оПараметры,d[1],d[3])}else if(-1===e)ДобавитьКЗадержанному(b,g),Отправить(!1,null,null,null,!0,!1),м_Журнал.Окак("Ключевой кадр не найден, сегмент задержан");else if(e===b.уНачалоСемплов)Отправить(_лЗадержанРазрыв,_оЗадержанныеПараметры,S,x,!0,!0),Задержать(_лРазрыв,_оПараметры,b,g);else if(e===b.уКонецСемплов)Проверить(S.Пусто()&&x.Пусто()),Отправить(_лРазрыв,_оПараметры,b,g,!0,!0);else{ДобавитьКЗадержанному((d=РазделитьОбработанныйСегмент(t,e))[0],d[2]),Отправить(_лЗадержанРазрыв,_оЗадержанныеПараметры,S,x,!0,!0),Задержать(_лРазрыв,_оПараметры,d[1],d[3])}}function РазделитьОбработанныйСегмент(t,e){Проверить(t>b.уНачалоПотока&&t<b.уКонецПотока),Проверить(e>b.уНачалоСемплов&&e<b.уКонецСемплов);var i=b.чВДНачала+b.СложитьБеззнаковыйПараметр(_,e,_мбВидеоСемплы),n=g.ПолучитьКоличествоСемплов(),r=n;A.чВДНачала=_чВДКонцаАудиоСегмента;var a=(b.уКонецСемплов-e)/o;return м_Журнал.Вот(`Сегмент разделен Видео=${b.ПолучитьКоличествоСемплов()-a}+${a} Звук=${r}+${n-r}`),[new Срез(o,b.уНачалоПотока,t,b.уНачалоСемплов,e,b.чВДНачала),new Срез(o,t,b.уКонецПотока,e,b.уКонецСемплов,i),g,A]}function Задержать(t,e,i,n){_лЗадержанРазрыв=t,_оЗадержанныеПараметры=e,Проверить(0===S.уНачалоПотока),S.уКонецПотока=i.ПолучитьРазмерПотока(),_мбВидеоПоток.copyWithin(0,i.уНачалоПотока,i.уКонецПотока),Проверить(0===S.уНачалоСемплов),S.уКонецСемплов=i.ПолучитьРазмерСемплов(),_мбВидеоСемплы.copyWithin(0,i.уНачалоСемплов,i.уКонецСемплов),S.чВДНачала=i.чВДНачала,Проверить(0===x.уНачалоПотока),x.уКонецПотока=n.ПолучитьРазмерПотока(),_мбАудиоПоток.copyWithin(0,n.уНачалоПотока,n.уКонецПотока),Проверить(0===x.уНачалоСемплов),x.уКонецСемплов=n.ПолучитьРазмерСемплов(),_мбАудиоСемплы.copyWithin(0,n.уНачалоСемплов,n.уКонецСемплов),x.чВДНачала=n.чВДНачала}function ДобавитьКЗадержанному(t,e){Проверить(!_лРазрыв),Проверить(_оЗадержанныеПараметры===_оПараметры),Проверить(S.уКонецПотока===t.уНачалоПотока&&S.уКонецСемплов===t.уНачалоСемплов),Проверить(x.уКонецПотока===e.уНачалоПотока&&x.уКонецСемплов===e.уНачалоСемплов),Проверить(!S.Пусто()),S.уКонецПотока=t.уКонецПотока,S.уКонецСемплов=t.уКонецСемплов,x.Пусто()&&(x.чВДНачала=e.чВДНачала),x.уКонецПотока=e.уКонецПотока,x.уКонецСемплов=e.уКонецСемплов}function ОбработатьСообщение(){var t=performance.now();_лРазрыв=_лРазрыв||_оИсходныйСегмент.лРазрыв,м_Журнал.Вот(`НАЧАЛО ПРЕОБРАЗОВАНИЯ СЕГМЕНТА ${_оИсходныйСегмент.чНомер} Размер=${(_оИсходныйСегмент.пДанные.byteLength/1024/1024).toFixed(2)}мб Длительность=${_оИсходныйСегмент.чДлительность} Разрыв=${_лРазрыв}`),ОчиститьСтатистику();var e=!1;if("number"!=typeof _оИсходныйСегмент.пДанные){var i=new Uint8Array(_оИсходныйСегмент.пДанные);try{ВыделитьПамять(i.length,_оИсходныйСегмент.чДлительность),РазобратьТранспортныйПоток(i)&&(_лРазрыв&&(_оПараметры=Object.create(null)),РазобратьМетаданные(),e=РазобратьВидеоПоток()&&РазобратьАудиоПоток())}catch(t){if(!(t instanceof Error&&"БРАКОВАТЬ"===t.message))throw t;м_Журнал.Ой(`Сегмент забракован: ${t.stack}`),ОчиститьСтатистику(),_лЗабраковано=!0}м_Балкон.Положить(i)}e?(РазделитьИОтправитьОбработанныйСегмент(),_лРазрыв=!1):(Отправить(_лЗадержанРазрыв,_оЗадержанныеПараметры,S,x,!1,!0),S.Свернуть(),x.Свернуть(),"number"!=typeof _оИсходныйСегмент.пДанные?Отправить(!1,null,null,null,!0,!1):(ОсвободитьПамять(),postMessage([1,_оИсходныйСегмент])),_лРазрыв=!0),м_Балкон.Освободить(),_чПреобразованЗа=performance.now()-t}self.onmessage=(t=>{const e="object"!=typeof t.data||null===t.data?typeof t.data:t.data.сВерсия;if("2018.7.9"!==e)throw new Error(`Версия ${e} !== 2018.7.9`);try{_оИсходныйСегмент=t.data,ОбработатьСообщение()}catch(e){self.onmessage=null,ОсвободитьПамять(),м_Журнал.Отправить(),ЗавершитьРаботуИОтправитьОтчет(e instanceof Error?`Поймано исключение в рабочем потоке: ${e.stack}`:`Поймано исключение в рабочем потоке: [typeof ${typeof e}] ${new Error(e).stack}`,t.data.пДанные)}finally{_оИсходныйСегмент=null}}),self.onmessageerror=(t=>{throw new Error(`Произошло событие ${t.type}`)})}