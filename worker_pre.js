"use strict";var Проверить,Браковать,ЗавершитьРаботуИПоказатьСообщение,ЗавершитьРаботуИОтправитьОтчет,ВыброситьВПомойку,ОкруглитьРазмерКучиAsmJS,AsmJS,ПотокБитов,IsoBaseMedia,ID3,Срез,СрезОбработки,_чНачалоАудиоБуфера,_чКонецАудиоБуфера,_чНачалоВидеоБуфера,_чКонецВидеоБуфера,_чНомерОтправляемогоСегмента,_чПозицияКодирования,_чВремяКодирования,_чБитрейтЗвука,_чСредняяДлительностьВидеоСемпла,_чМаксДлительностьВидеоСемпла,_чМинДлительностьВидеоСемпла,_лПотериЗвука,_лПотериВидео,_лЗабраковано,_чПреобразованЗа,_nPmtVersion,_nPatVersion,_чВДКонцаАудиоСегмента,_чВДПоследнегоВидеоСемпла,_уСемплПоследнегоКлючКадра,_уПотокПоследнегоКлючКадра,_уСемплПоследнегоКадра,_уПотокПоследнегоКадра,_оЗадержанныеПараметры,_лЗадержанРазрыв,_оПараметры,_лРазрыв,_мбАудиоСемплы,_мбВидеоСемплы,_мбМетаданные,_мбАудиоПоток,_мбВидеоПоток,_оИсходныйСегмент;let ВЕРСИЯ_ДВИЖКА_БРАУЗЕРА,ВЕРСИЯ_РАСШИРЕНИЯ,м_Журнал,м_Балкон;(function(){var t=new Array(1),e=function(e){var i;switch(e){case 0:i=[null];break;default:throw new Error("Unknown scope selector")}return t[e]=i,i},i=this,n=i.Uint8Array.prototype,r=function(t,e,i){Проверить(Number.isInteger(e)&&Number.isInteger(i)&&e>=0&&i<=t.length&&i>=e),this._мбБуфер=t,this._уСледующийБайт=e,this._чСледующийБит=7,this.кБитОсталось=8*(i-e)},a=r.prototype,_=function(t,e){Проверить(Number.isInteger(e)&&e>=0&&e<=t.length),this.мбБуфер=t,this.уНачало=e,this.уКонец=e},s=_.prototype,o=function(t,e,i){Проверить(1===t.BYTES_PER_ELEMENT&&Number.isInteger(e)&&Number.isInteger(i)&&e>=0&&e<=i),this._мб=t;var n=i-e;n>20&&73===this._мб[e]&&68===this._мб[e+1]&&51===this._мб[e+2]&&4===this._мб[e+3]&&0===this._мб[e+5]&&this._ParseSynchsafeInteger(e+6)===n-10?(this._уТег=e+10,this._кбТег=n-10):(this._уТег=-1,this._кбТег=-1),this._уПоле=-1,this._кбПоле=-1},u=o.prototype,h=function(t,e,i,n,r,a){Проверить(Number.isInteger(t)&&t>=0),Проверить(Number.isInteger(e)&&Number.isInteger(i)&&e>=0&&e<=i),Проверить(Number.isInteger(n)&&Number.isInteger(r)&&n>=0&&n<=r),Проверить(0===t&&0===n&&0===r||(r-n)%t==0),Проверить(a>=-1),this.кбСтруктураСемпла=t,this.уНачалоПотока=e,this.уКонецПотока=i,this.уНачалоСемплов=n,this.уКонецСемплов=r,this.чВДНачала=a},c=h.prototype,d=function(t,e,i,n,r,a){Срез.apply(this,arguments),this.nContinuityCounter=-1,this.pPesPacketEnd=-1},f=function(t,e){t|=0;var i=Math.trunc(e);if(i<Number.MIN_SAFE_INTEGER||i>Number.MAX_SAFE_INTEGER)throw new Error(e);var n=i/4294967296|0;this[t]=n>>24,this[t+1|0]=n>>16,this[t+2|0]=n>>8,this[t+3|0]=n,n=0|i,this[t+4|0]=n>>24,this[t+5|0]=n>>16,this[t+6|0]=n>>8,this[t+7|0]=n},l=function(t,e){e|=0,this[t|=0]=e>>24,this[t+1|0]=e>>16,this[t+2|0]=e>>8,this[t+3|0]=e},m=function(t,e){e|=0,this[t|=0]=e>>8,this[t+1|0]=e},v=function(t,e){O.push(t),W.push(`[Worker] ${e}`)},P=function(){_лЗабраковано=!1,_лПотериВидео=!1,_лПотериЗвука=!1,_чМинДлительностьВидеоСемпла=1/0,_чМаксДлительностьВидеоСемпла=-1/0,_чСредняяДлительностьВидеоСемпла=NaN,_чБитрейтЗвука=NaN,_чВремяКодирования=NaN,_чПозицияКодирования=NaN,_чНомерОтправляемогоСегмента=0},b=function(){ВыброситьВПомойку(_мбВидеоПоток),_мбВидеоПоток=null,ВыброситьВПомойку(_мбАудиоПоток),_мбАудиоПоток=null,ВыброситьВПомойку(_мбМетаданные),_мбМетаданные=null,ВыброситьВПомойку(_мбВидеоСемплы),_мбВидеоСемплы=null,ВыброситьВПомойку(_мбАудиоСемплы),_мбАудиоСемплы=null,_оПараметры=null,_оЗадержанныеПараметры=null,м_Балкон.Освободить()},p=function(t,e,i,n,r){var a=Math.ceil(e+i);if(t&&t.length>=a)return t;a=Math.ceil(a*n),r&&(a=ОкруглитьРазмерКучиAsmJS(a)),м_Журнал[t?"Окак":"Вот"](`Увеличиваю массив с ${t?t.length:0} до ${a}`);var _=new Uint8Array(a);return 0!==e&&_.Копировать(0,t,0,e),ВыброситьВПомойку(t),_},g=function(t,e,i){var n=0|t[e],r=0|t.ПрочестьБЦ32(e+1);return Проверить((241&n)==(0|i)&&65537==(65537&r)),+((14&n)*(1<<29)+(r>>2&1073709056|r>>1&32767))},S=function(t,e,i){Проверить(e<i),e+=1+t[e],Проверить(i-e>=16),Проверить(0===t[e]),Проверить(32781==(53247&t.ПрочестьБЦ16(e+1))),Проверить(1==(1&t[e+5]));var n=62&t[e+5];Проверить(0===t[e+6]),Проверить(0===t[e+7]);var r=t.ПрочестьБЦ16(e+8);Проверить(0!==r);var a=8191&t.ПрочестьБЦ16(e+10);return Проверить(a>=16&&a<=8190),_лРазрыв&&м_Журнал.Вот(`PatVersion=${n} ProgramNumber=${r} PmtPid=${a}`),{nPatVersion:n,nProgramNumber:r,nPmtPid:a}},x=function(t,e,i,n){Проверить(e<i),e+=1+t[e],Проверить(i-e>=12),Проверить(2===t[e]);var r=t.ПрочестьБЦ16(e+1);Проверить(32768==(49152&r)),Проверить((r=e+3+(4095&r)-4)>=e+12&&r+4<=i),Проверить(t.ПрочестьБЦ16(e+3)===n),Проверить(1==(1&t[e+5]));var a=62&t[e+5];Проверить(0===t[e+6]),Проверить(0===t[e+7]),e+=12+(4095&t.ПрочестьБЦ16(e+10));for(var _=-1,s=-1,o=-1;e!==r;e=u+c){var u=e+5;Проверить(u<=r);var h=8191&t.ПрочестьБЦ16(e+1);Проверить(h>=16&&h<=8190);var c=4095&t.ПрочестьБЦ16(e+3);switch(Проверить(u+c<=r),t[e]){case 27:-1===_?_=h:м_Журнал.Ой(`Найден дополнительный видеопоток PID=${h}`);break;case 15:-1===s?s=h:м_Журнал.Ой(`Найден дополнительный аудиопоток PID=${h}`);break;case 21:15===c&&38===t[u]&&13===t[u+1]&&255===t[u+2]&&255===t[u+3]&&73===t[u+4]&&68===t[u+5]&&51===t[u+6]&&32===t[u+7]&&255===t[u+8]&&73===t[u+9]&&68===t[u+10]&&51===t[u+11]&&32===t[u+12]&&0===t[u+13]&&(-1===o?o=h:м_Журнал.Ой(`Найдены дополнительные метаданные PID=${h}`))}}return _лРазрыв&&м_Журнал.Вот(`PmtVersion=${a} VideoPid=${_} AudioPid=${s} MetadataPid=${o}`),-1!==_&&-1!==s||ЗавершитьРаботуИПоказатьСообщение("J0207"),{nPmtVersion:a,nVideoPid:_,nAudioPid:s,nMetadataPid:o}},$=function(t,e,i){var n=t[e],r=t[e+1],a=t[e+2],_=new ПотокБитов(t,e+3,i),s=_.ПрочестьБеззнаковыйЭКГ();Проверить(s<32);var o=1,u=0,h=0,c=0;switch(n){case 183:o=0;break;case 100:case 110:case 122:case 244:case 44:case 83:case 86:case 118:case 128:case 138:case 139:case 134:if(o=_.ПрочестьБеззнаковыйЭКГ(),Проверить(o<=3),3===o&&(u=_.ПрочестьБиты(1)),h=_.ПрочестьБеззнаковыйЭКГ(),Проверить(h<=6),c=_.ПрочестьБеззнаковыйЭКГ(),Проверить(c<=6),_.ПропуститьБиты(1),0!==_.ПрочестьБиты(1))for(var d=0,f=3!==o?8:12;d<f;++d)if(0!==_.ПрочестьБиты(1))for(var l=8,m=8,v=0,P=d<6?16:64;v<P;++v)0!==m&&(m=(l+_.ПрочестьЗнаковыйЭКГ()+256)%256),0!==m&&(l=m)}switch(_.ПропуститьЭКГ(),_.ПрочестьБеззнаковыйЭКГ()){case 0:_.ПропуститьЭКГ();break;case 1:_.ПропуститьБиты(1),_.ПропуститьЭКГ(),_.ПропуститьЭКГ();for(d=0,f=_.ПрочестьБеззнаковыйЭКГ();d<f;++d)_.ПропуститьЭКГ()}var b=_.ПрочестьБеззнаковыйЭКГ();_.ПропуститьБиты(1);var p=_.ПрочестьБеззнаковыйЭКГ()+1,g=_.ПрочестьБеззнаковыйЭКГ()+1,S=_.ПрочестьБиты(1);if(0===S&&_.ПропуститьБиты(1),_.ПропуститьБиты(1),0!==_.ПрочестьБиты(1))var x=_.ПрочестьБеззнаковыйЭКГ(),$=_.ПрочестьБеззнаковыйЭКГ(),I=_.ПрочестьБеззнаковыйЭКГ(),A=_.ПрочестьБеззнаковыйЭКГ();else x=0,$=0,I=0,A=0;if(0!==_.ПрочестьБиты(1)){if(0!==_.ПрочестьБиты(1)){var y=_.ПрочестьБиты(8);if(255===y)var F=_.ПрочестьБиты(16),N=_.ПрочестьБиты(16)}if(0!==_.ПрочестьБиты(1)&&_.ПропуститьБиты(1),0!==_.ПрочестьБиты(1)){var B=_.ПрочестьБиты(3),w=_.ПрочестьБиты(1);0!==_.ПрочестьБиты(1)&&_.ПропуститьБиты(24)}if(0!==_.ПрочестьБиты(1)&&(_.ПропуститьЭКГ(),_.ПропуститьЭКГ()),0!==_.ПрочестьБиты(1))var M=_.ПрочестьБиты(32),E=_.ПрочестьБиты(32),k=_.ПрочестьБиты(1)}var C=1,D=1;0===u&&0!==o&&(C=3===o?1:2,D=1===o?2:1),0===S&&(D+=D,g+=g),_оПараметры.чШиринаКартинки=16*p-C*$-C*x,_оПараметры.чВысотаКартинки=16*g-D*A-D*I,_оПараметры.nProfileIndication=n,_оПараметры.nConstraintSetFlag=r,_оПараметры.nLevelIndication=a,_оПараметры.nChromaFormatIndication=o,_оПараметры.nBitDepthLumaMinus8=h,_оПараметры.nBitDepthChromaMinus8=c,_оПараметры.nMaxNumberReferenceFrames=b,_оПараметры.чДиапазон=void 0===w?-1:w,_оПараметры.лЧересстрочное=0===S,_оПараметры.чЧастотаКадров=void 0===E?0:E/M/(0===k?-2:2),м_Журнал.Вот("ШиринаКартинки="+_оПараметры.чШиринаКартинки+" ВысотаКартинки="+_оПараметры.чВысотаКартинки+" ProfileIndication="+n+" ConstraintSetFlag=0x"+r.toString(16)+" LevelIndication="+(a/10).toFixed(1)+" MaxNumberReferenceFrames="+b+" SequenceParameterSetId="+s+" AspectRatioIndication="+y+" SarWidth="+F+" SarHeight="+N+" VideoFormat="+B+" VideoFullRangeFlag="+w+" TimeScale="+E+" NumUnitsInTick="+M+" FixedFrameRateFlag="+k),0===S&&м_Журнал.Ой("Чересстрочное видео")},I=function(t,e,i){Проверить(e<i);var n=31&t[e++];14!==n&&20!==n&&21!==n||(Проверить(e<i),e+=21===n&&0!=(128&t[e])?2:3,Проверить(e<=i));for(var r=e,a=i-2;e<a;)if(0===t[e++]&&0===t[e++]){var _=t[e++];if(Проверить(_>=3),3===_){var s=e-1;for(Проверить(e===i||t[e]<=3);e<a;)0===(t[s++]=t[e++])&&0===(t[s++]=t[e++])&&(_=t[s++]=t[e++],Проверить(_>=3),3===_&&(--s,Проверить(e===i||t[e]<=3)));for(;e!==i;)var o=t[s++]=t[e++];return Проверить(0!==o),{"уНачалоRBSP":r,"уКонецRBSP":s}}}return Проверить(e===i||0!==t[i-1]),{"уНачалоRBSP":r,"уКонецRBSP":i}},A=function(t){Проверить(-983040==(4294901760&t)),_оПараметры.aDecoderSpecificInfo=[0,0],_оПараметры.nAudioObjectType=1+(t>>14&3),_оПараметры.aDecoderSpecificInfo[0]=_оПараметры.nAudioObjectType<<3;var e=t>>10&15;_оПараметры.чЧастотаДискретизации=R[e],Проверить(void 0!==_оПараметры.чЧастотаДискретизации),_оПараметры.aDecoderSpecificInfo[0]|=e>>1,_оПараметры.aDecoderSpecificInfo[1]=e<<7&128,_оПараметры.чКоличествоКаналов=t>>6&7,Проверить(0!==_оПараметры.чКоличествоКаналов),_оПараметры.aDecoderSpecificInfo[1]|=_оПараметры.чКоличествоКаналов<<3,м_Журнал[2!==_оПараметры.nAudioObjectType||_оПараметры.чЧастотаДискретизации<44100||_оПараметры.чКоличествоКаналов>2?"Ой":"Вот"](`AudioObjectType=${_оПараметры.nAudioObjectType} ЧастотаДискретизации=${_оПараметры.чЧастотаДискретизации} КоличествоКаналов=${_оПараметры.чКоличествоКаналов}`)},y=function(t,e,i){i.AddBox("trak",()=>{i.AddFullBox("tkhd",0,3,80),i.мбБуфер.ЗаписатьБЦ32(i.уКонец-64,4294967295),i.мбБуфер[i.уКонец-43]=1,i.мбБуфер[i.уКонец-27]=1,i.мбБуфер[i.уКонец-12]=64,e?(i.мбБуфер.ЗаписатьБЦ32(i.уКонец-72,1),i.мбБуфер.ЗаписатьБЦ16(i.уКонец-8,t.чШиринаКартинки),i.мбБуфер.ЗаписатьБЦ16(i.уКонец-4,t.чВысотаКартинки)):(i.мбБуфер.ЗаписатьБЦ32(i.уКонец-72,2),i.мбБуфер.ЗаписатьБЦ16(i.уКонец-48,256)),i.AddBox("mdia",()=>{i.AddFullBox("mdhd",0,0,20),i.мбБуфер.ЗаписатьБЦ32(i.уКонец-12,e?9e4:t.чЧастотаДискретизации),i.мбБуфер[i.уКонец-8]=255,i.мбБуфер[i.уКонец-7]=255,i.мбБуфер[i.уКонец-6]=255,i.мбБуфер[i.уКонец-5]=255,i.мбБуфер[i.уКонец-4]=85,i.мбБуфер[i.уКонец-3]=196,i.AddFullBox("hdlr",0,0,e?[0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,67,111,111,108,67,109,100,86,105,100,53,0]:[0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,67,111,111,108,67,109,100,65,117,100,53,0]),i.AddBox("minf",()=>{e?i.AddFullBox("vmhd",0,1,8):i.AddFullBox("smhd",0,0,4),i.AddBox("dinf",()=>{i.AddFullBox("dref",0,0,()=>{i.мбБуфер.ЗаписатьБЦ32(i.уКонец,1),i.уКонец+=4,i.AddFullBox("url ",0,1,0)})}),i.AddBox("stbl",()=>{i.AddFullBox("stsd",0,0,()=>{i.мбБуфер.ЗаписатьБЦ32(i.уКонец,1),i.уКонец+=4,e?i.AddBox("avc1",()=>{i.мбБуфер.ЗаписатьБЦ16(i.уКонец+6,1),i.мбБуфер.ЗаписатьБЦ16(i.уКонец+24,t.чШиринаКартинки),i.мбБуфер.ЗаписатьБЦ16(i.уКонец+26,t.чВысотаКартинки),i.мбБуфер.ЗаписатьБЦ32(i.уКонец+28,4718592),i.мбБуфер.ЗаписатьБЦ32(i.уКонец+32,4718592),i.мбБуфер.ЗаписатьБЦ16(i.уКонец+40,1),i.мбБуфер.ЗаписатьБЦ16(i.уКонец+74,24),i.мбБуфер.ЗаписатьБЦ16(i.уКонец+76,65535),i.уКонец+=78,i.AddBox("avcC",()=>{switch(i.мбБуфер[i.уКонец]=1,i.мбБуфер[i.уКонец+1]=t.nProfileIndication,i.мбБуфер[i.уКонец+2]=t.nConstraintSetFlag,i.мбБуфер[i.уКонец+3]=t.nLevelIndication,i.мбБуфер[i.уКонец+4]=255,i.мбБуфер[i.уКонец+5]=225,i.мбБуфер.ЗаписатьБЦ16(i.уКонец+6,t.abSequenceParameterSet.length),i.Копировать(i.уКонец+8,t.abSequenceParameterSet),i.мбБуфер[i.уКонец]=1,i.мбБуфер.ЗаписатьБЦ16(i.уКонец+1,t.abPictureParameterSet.length),i.Копировать(i.уКонец+3,t.abPictureParameterSet),t.nProfileIndication){case 100:case 110:case 122:case 144:i.мбБуфер[i.уКонец]=252|t.nChromaFormatIndication,i.мбБуфер[i.уКонец+1]=248|t.nBitDepthLumaMinus8,i.мбБуфер[i.уКонец+2]=248|t.nBitDepthChromaMinus8,void 0===t.abSequenceParameterSetExt?i.уКонец+=4:(i.мбБуфер[i.уКонец+3]=1,i.мбБуфер.ЗаписатьБЦ16(i.уКонец+4,t.abSequenceParameterSetExt.length),i.Копировать(i.уКонец+6,t.abSequenceParameterSetExt))}})}):i.AddBox("mp4a",()=>{i.мбБуфер.ЗаписатьБЦ16(i.уКонец+6,1),i.мбБуфер.ЗаписатьБЦ16(i.уКонец+18,16),i.уКонец+=28,i.AddFullBox("esds",0,0,()=>{i.мбБуфер[i.уКонец]=3,i.мбБуфер[i.уКонец+1]=23+t.aDecoderSpecificInfo.length,i.мбБуфер.ЗаписатьБЦ16(i.уКонец+2,1),i.мбБуфер[i.уКонец+5]=4,i.мбБуфер[i.уКонец+6]=15+t.aDecoderSpecificInfo.length,i.мбБуфер[i.уКонец+7]=64,i.мбБуфер[i.уКонец+8]=21,i.мбБуфер[i.уКонец+20]=5,i.мбБуфер[i.уКонец+21]=t.aDecoderSpecificInfo.length,i.Копировать(i.уКонец+22,t.aDecoderSpecificInfo),i.мбБуфер[i.уКонец]=6,i.мбБуфер[i.уКонец+1]=1,i.мбБуфер[i.уКонец+2]=2,i.уКонец+=3})})}),i.AddFullBox("stts",0,0,4),i.AddFullBox("stsc",0,0,4),i.AddFullBox("stco",0,0,4),i.AddFullBox("stsz",0,0,8)})})})})},F=function(t,e,i,n,r,a){if(r||!i.Пусто()||!n.Пусто()){var _,s=Object.create(null),o=0,u=_оИсходныйСегмент.чНомер+(_чНомерОтправляемогоСегмента+=.1);r&&(s.чПреобразованЗа=_чПреобразованЗа,s.лЗабраковано=_лЗабраковано,s.лПотериВидео=_лПотериВидео,s.лПотериЗвука=_лПотериЗвука,s.чМинДлительностьВидеоСемпла=_чМинДлительностьВидеоСемпла/90,s.чМаксДлительностьВидеоСемпла=_чМаксДлительностьВидеоСемпла/90,s.чСредняяДлительностьВидеоСемпла=_чСредняяДлительностьВидеоСемпла/90,s.чБитрейтЗвука=_чБитрейтЗвука,s.чВремяКодирования=_чВремяКодирования,s.чПозицияКодирования=_чПозицияКодирования),(i&&!i.Пусто()||n&&!n.Пусто())&&(!function(t,e,i,n,r){Проверить(!e.Пусто()||!i.Пусто());var a,_=160+e.ПолучитьРазмерПотока()+e.ПолучитьРазмерСемплов()+i.ПолучитьРазмерПотока()+i.ПолучитьРазмерСемплов();r&&(a=м_Балкон.Найти(_)),a||(a=new Uint8Array(_));var s,o,u=new IsoBaseMedia(a,0);u.AddBox("moof",()=>{u.AddFullBox("mfhd",0,0,4),a.ЗаписатьБЦ32(u.уКонец-4,0),e.Пусто()||u.AddBox("traf",()=>{u.AddFullBox("tfhd",0,131072,4),a.ЗаписатьБЦ32(u.уКонец-4,1),u.AddFullBox("tfdt",1,0,8),a.ЗаписатьБЦ64(u.уКонец-8,e.чВДНачала),u.AddFullBox("trun",1,3841,()=>{a.ЗаписатьБЦ32(u.уКонец,e.ПолучитьКоличествоСемплов()),s=u.уКонец+4,u.Копировать(u.уКонец+8,_мбВидеоСемплы,e.уНачалоСемплов,e.уКонецСемплов)})}),i.Пусто()||u.AddBox("traf",()=>{u.AddFullBox("tfhd",0,131072,4),a.ЗаписатьБЦ32(u.уКонец-4,2),u.AddFullBox("tfdt",1,0,8),a.ЗаписатьБЦ64(u.уКонец-8,i.чВДНачала/9e4*t.чЧастотаДискретизации),u.AddFullBox("trun",1,513,()=>{a.ЗаписатьБЦ32(u.уКонец,i.ПолучитьКоличествоСемплов()),o=u.уКонец+4,u.Копировать(u.уКонец+8,_мбАудиоСемплы,i.уНачалоСемплов,i.уКонецСемплов)})})}),u.AddBox("mdat",()=>{e.Пусто()||(a.ЗаписатьЗЦ32(s,u.уКонец-u.уНачало),u.Копировать(u.уКонец,_мбВидеоПоток,e.уНачалоПотока,e.уКонецПотока)),i.Пусто()||(a.ЗаписатьЗЦ32(o,u.уКонец-u.уНачало),u.Копировать(u.уКонец,_мбАудиоПоток,i.уНачалоПотока,i.уКонецПотока))}),n.мбМедиасегмент=u.Завершить()}(e,i,n,s,a),_=[s.мбМедиасегмент.buffer],o=N(t,e,i,n,u,s),t&&(!function(t,e){var i=1111+t.abSequenceParameterSet.length+t.abPictureParameterSet.length+(t.abSequenceParameterSetExt?t.abSequenceParameterSetExt.length:0)+t.aDecoderSpecificInfo.length,n=new Uint8Array(i),r=new IsoBaseMedia(n,0);r.AddBox("ftyp",[105,115,111,54,0,0,0,0,97,118,99,49]),r.AddBox("moov",()=>{r.AddFullBox("mvhd",1,0,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,255,255,255,255,255,255,255,255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]),r.AddBox("mvex",()=>{r.AddFullBox("trex",0,0,20),r.мбБуфер.ЗаписатьБЦ32(r.уКонец-20,1),r.мбБуфер.ЗаписатьБЦ32(r.уКонец-16,1),r.AddFullBox("trex",0,0,20),r.мбБуфер.ЗаписатьБЦ32(r.уКонец-20,2),r.мбБуфер.ЗаписатьБЦ32(r.уКонец-16,1),r.мбБуфер.ЗаписатьБЦ32(r.уКонец-12,1024)}),y(t,!0,r),y(t,!1,r)}),e.мбСегментИнициализации=r.Завершить(),e.сКодеки='video/mp4; codecs="'+function(t){return"avc1."+("0"+t.nProfileIndication.toString(16)).slice(-2)+("0"+t.nConstraintSetFlag.toString(16)).slice(-2)+("0"+t.nLevelIndication.toString(16)).slice(-2)}(t)+", "+function(t){return`mp4a.40.${t.nAudioObjectType}`}(t)+'"'}(e,s),s.чШиринаКартинки=e.чШиринаКартинки,s.чВысотаКартинки=e.чВысотаКартинки,s.nProfileIndication=e.nProfileIndication,s.nConstraintSetFlag=e.nConstraintSetFlag,s.nLevelIndication=e.nLevelIndication,s.nMaxNumberReferenceFrames=e.nMaxNumberReferenceFrames,s.чДиапазон=e.чДиапазон,s.лЧересстрочное=e.лЧересстрочное,s.чЧастотаКадров=e.чЧастотаКадров,s.nAudioObjectType=e.nAudioObjectType,s.чЧастотаДискретизации=e.чЧастотаДискретизации,s.чКоличествоКаналов=e.чКоличествоКаналов,_.push(s.мбСегментИнициализации.buffer)))}м_Журнал.Отправить(),s&&postMessage([1,{"пДанные":s,"чДлительность":o,"лРазрыв":t,"чTwitchПрошлоВремени":r?_оИсходныйСегмент.чTwitchПрошлоВремени:NaN,"чНомер":u}],_)},N=function(t,e,i,n,r,a){t&&(_чНачалоВидеоБуфера=_чКонецВидеоБуфера=_чНачалоАудиоБуфера=_чКонецАудиоБуфера=-1);var _="Вот",s=_чКонецВидеоБуфера,o="";if(!i.Пусто()){var u=i.чВДНачала/9e4;Проверить(u>=_чКонецВидеоБуфера),-1===_чНачалоВидеоБуфера&&(_чНачалоВидеоБуфера=u),s=(i.чВДНачала+i.СложитьБеззнаковыйПараметр(0,i.уКонецСемплов,_мбВидеоСемплы))/9e4,Проверить(s>=u),o=` Видео=${u.toFixed(3)}-${s.toFixed(3)}`;var h=i.ПолучитьКоличествоСемплов();h<8&&(_="Ой",o=` Видеосемплов=${h}${o}`)}var c=_чКонецАудиоБуфера,d="";if(!n.Пусто()){var f=n.чВДНачала/9e4;-1===_чНачалоАудиоБуфера&&(_чНачалоАудиоБуфера=f),c=f+1024*n.ПолучитьКоличествоСемплов()/e.чЧастотаДискретизации,Проверить(c>=f),d=` Звук=${f.toFixed(3)}-${c.toFixed(3)}`}var l=Math.max(_чНачалоВидеоБуфера,_чНачалоАудиоБуфера,Math.min(_чКонецВидеоБуфера,_чКонецАудиоБуфера)),m=Math.max(_чНачалоВидеоБуфера,_чНачалоАудиоБуфера,Math.min(_чКонецВидеоБуфера=s,_чКонецАудиоБуфера=c))-l;return м_Журнал[_](`Отправляю сегмент ${r} Разрыв=${t}`+` Длительность=${m.toFixed(3)}${o}${d}`+` Размер=${(a.мбМедиасегмент.length/1024/1024).toFixed(2)}мб`),m},B=function(t,e){Проверить(t>q.уНачалоПотока&&t<q.уКонецПотока),Проверить(e>q.уНачалоСемплов&&e<q.уКонецСемплов);var i=q.чВДНачала+q.СложитьБеззнаковыйПараметр(0,e,_мбВидеоСемплы),n=U.ПолучитьКоличествоСемплов(),r=n;j.чВДНачала=_чВДКонцаАудиоСегмента;var a=(q.уКонецСемплов-e)/16;return м_Журнал.Вот(`Сегмент разделен Видео=${q.ПолучитьКоличествоСемплов()-a}+${a} Звук=${r}+${n-r}`),[new Срез(16,q.уНачалоПотока,t,q.уНачалоСемплов,e,q.чВДНачала),new Срез(16,t,q.уКонецПотока,e,q.уКонецСемплов,i),U,j]},w=function(t,e,i,n){_лЗадержанРазрыв=t,_оЗадержанныеПараметры=e,Проверить(0===V.уНачалоПотока),V.уКонецПотока=i.ПолучитьРазмерПотока(),_мбВидеоПоток.copyWithin(0,i.уНачалоПотока,i.уКонецПотока),Проверить(0===V.уНачалоСемплов),V.уКонецСемплов=i.ПолучитьРазмерСемплов(),_мбВидеоСемплы.copyWithin(0,i.уНачалоСемплов,i.уКонецСемплов),V.чВДНачала=i.чВДНачала,Проверить(0===T.уНачалоПотока),T.уКонецПотока=n.ПолучитьРазмерПотока(),_мбАудиоПоток.copyWithin(0,n.уНачалоПотока,n.уКонецПотока),Проверить(0===T.уНачалоСемплов),T.уКонецСемплов=n.ПолучитьРазмерСемплов(),_мбАудиоСемплы.copyWithin(0,n.уНачалоСемплов,n.уКонецСемплов),T.чВДНачала=n.чВДНачала},M=function(t,e){Проверить(!_лРазрыв),Проверить(_оЗадержанныеПараметры===_оПараметры),Проверить(V.уКонецПотока===t.уНачалоПотока&&V.уКонецСемплов===t.уНачалоСемплов),Проверить(T.уКонецПотока===e.уНачалоПотока&&T.уКонецСемплов===e.уНачалоСемплов),Проверить(!V.Пусто()),V.уКонецПотока=t.уКонецПотока,V.уКонецСемплов=t.уКонецСемплов,T.Пусто()&&(T.чВДНачала=e.чВДНачала),T.уКонецПотока=e.уКонецПотока,T.уКонецСемплов=e.уКонецСемплов},E=function(){var t=performance.now();_лРазрыв=_лРазрыв||_оИсходныйСегмент.лРазрыв,м_Журнал.Вот(`НАЧАЛО ПРЕОБРАЗОВАНИЯ СЕГМЕНТА ${_оИсходныйСегмент.чНомер} Размер=${(_оИсходныйСегмент.пДанные.byteLength/1024/1024).toFixed(2)}мб Длительность=${_оИсходныйСегмент.чДлительность} Разрыв=${_лРазрыв} РазделятьПоКлючевымКадрам=${_оИсходныйСегмент.чОбработка}`),P();var e=!1;if("number"!=typeof _оИсходныйСегмент.пДанные){var i=new Uint8Array(_оИсходныйСегмент.пДанные);try{!function(t,e){Проверить(0===V.уНачалоПотока&&0===T.уНачалоПотока),Проверить(0===V.уНачалоСемплов&&0===T.уНачалоСемплов),e+=2;var i=Math.ceil(250*e),n=20*i,r=t+n,a=t,_=16*i,s=4*R[0]/1024*e;_мбВидеоПоток=p(_мбВидеоПоток,V.уКонецПотока,r,1.3,!1),_мбАудиоПоток=p(_мбАудиоПоток,T.уКонецПотока,a,1.3,!1),_мбВидеоСемплы=p(_мбВидеоСемплы,V.уКонецСемплов,_,1.5,!1),_мбАудиоСемплы=p(_мбАудиоСемплы,T.уКонецСемплов,s,1.5,!1),void 0===_мбВидеоПоток.НайтиПрефикс&&(_мбВидеоПоток.НайтиПрефикс=AsmJS(self,null,_мбВидеоПоток.buffer).SearchStartCodePrefix),q.уНачалоПотока=V.уКонецПотока+n,q.уНачалоСемплов=V.уКонецСемплов,q.Свернуть(),U.уНачалоПотока=T.уКонецПотока,U.уНачалоСемплов=T.уКонецСемплов,U.Свернуть(),L.уКонецПотока=L.уНачалоПотока}(i.length,_оИсходныйСегмент.чДлительность),function(t){Проверить(q.уКонецПотока===q.уНачалоПотока&&q.уКонецСемплов===q.уНачалоСемплов&&-1===q.чВДНачала),Проверить(U.уКонецПотока===U.уНачалоПотока&&U.уКонецСемплов===U.уНачалоСемплов&&-1===U.чВДНачала),Проверить(-1!==L.чВДНачала),Браковать(0!==t.length&&t.length%188==0);var e=0,i=-1,n=-1,r=0,a=-1,_=-1,s=-1,o=-1,u="",h=0;q.pPesPacketEnd=U.pPesPacketEnd=L.pPesPacketEnd=-1,_лРазрыв&&(q.nContinuityCounter=U.nContinuityCounter=L.nContinuityCounter=-1,_nPatVersion=_nPmtVersion=-1);for(var c=t.length,d=0;d!==c;d+=188){var f=t.ПрочестьБЦ32(d);Браковать(1191182336==(4286578880&f));var l=(2096896&f)>>8,m=d+4;if(0!=(32&f)){var v=t[m];Проверить(v<=183),Проверить(0===v||0==(128&t[m+1])),m+=1+v}switch(l){case a:0!=(4194304&f)&&Проверить(480==(4294967280&t.ПрочестьБЦ32(m)));var P=_мбВидеоПоток,b=q;break;case _:0!=(4194304&f)&&Проверить(448==(4294967264&t.ПрочестьБЦ32(m))),P=_мбАудиоПоток,b=U;break;case s:if(0!=(4194304&f)){Проверить(445===t.ПрочестьБЦ32(m));var $=t.ПрочестьБЦ16(m+4);Проверить(0!==$),u+=$+" ",_мбМетаданные=p(_мбМетаданные,0,$,2,!1),L.уКонецПотока=L.уНачалоПотока,L.pPesPacketEnd=-1}P=_мбМетаданные,b=L;break;case 0:++e,Проверить(4194320==(4194320&f));var I=S(t,m,d+188);-1===_nPatVersion?_nPatVersion=I.nPatVersion:Проверить(_nPatVersion===I.nPatVersion),1===e?(i=I.nProgramNumber,n=I.nPmtPid):Проверить(i===I.nProgramNumber&&n===I.nPmtPid);continue;case n:++r,Проверить(4194320==(4194320&f)),I=x(t,m,d+188,i),-1===_nPmtVersion?_nPmtVersion=I.nPmtVersion:Проверить(_nPmtVersion===I.nPmtVersion),1===r?(a=I.nVideoPid,_=I.nAudioPid,s=I.nMetadataPid):Проверить(a===I.nVideoPid&&_===I.nAudioPid&&s===I.nMetadataPid);continue;default:continue}switch(b.nContinuityCounter!==(15&f)&&-1!==b.nContinuityCounter&&(м_Журнал.Ой(`continuity_counter равен ${15&f} вместо ${b.nContinuityCounter} PID=${l}`),Проверить(b.уКонецПотока===b.уНачалоПотока)),b.nContinuityCounter=f+1&15,4194320&f){case 16:Проверить(b.уКонецПотока!==b.уНачалоПотока);break;case 4194320:Проверить(b.pPesPacketEnd===b.уКонецПотока||-1===b.pPesPacketEnd);var A=t.ПрочестьБЦ16(m+4),y=t[m+8];if(0!==A?b.pPesPacketEnd=b.уКонецПотока+A-3-y:(Проверить(l===a),b.pPesPacketEnd=-1),l===a||-1===b.чВДНачала){switch(61632&t.ПрочестьБЦ16(m+6)){case 32896:Проверить(y>=5);var F=N=g(t,m+9,33);break;case 32960:Проверить(y>=10);var N=g(t,m+9,49);F=g(t,m+14,17);break;default:Проверить(!1)}if(-1===b.чВДНачала&&(b.чВДНачала=F),l===a)if(F===o&&0!==A)Проверить(0==(4&t[m+6]));else{if(-1!==o){var B=F-o;B<=0&&(B>-10?(F=o+(B=1),++h):(Проверить(o>8584534592),Браковать(!1))),Проверить(B<54e6),_чМинДлительностьВидеоСемпла=Math.min(_чМинДлительностьВидеоСемпла,B),_чМаксДлительностьВидеоСемпла=Math.max(_чМаксДлительностьВидеоСемпла,B),_мбВидеоСемплы.ЗаписатьБЦ32(q.уКонецСемплов+-16,B),_мбВидеоСемплы.ЗаписатьБЦ32(q.уКонецСемплов+4,q.уКонецПотока)}_мбВидеоСемплы.ЗаписатьЗЦ32(q.уКонецСемплов+12,N-F),q.уКонецСемплов+=16,o=F}else Проверить(N===F)}m+=9+y;break;default:Проверить(!1)}var w=d+188-m;Проверить(w>0),P.Копировать(b.уКонецПотока,t,m,m+w),b.уКонецПотока+=w}if(Проверить(q.pPesPacketEnd===q.уКонецПотока||-1===q.pPesPacketEnd),Проверить(U.pPesPacketEnd===U.уКонецПотока||-1===U.pPesPacketEnd),Проверить(L.pPesPacketEnd===L.уКонецПотока||-1===L.pPesPacketEnd),1===e&&1===r||м_Журнал.Ой(`Количество таблиц в сегменте: PAT=${e} PMT=${r}`),_лПотериВидео=q.Пусто(),_лПотериЗвука=U.Пусто(),_лПотериВидео||_лПотериЗвука)return м_Журнал.Ой(`Сегмент не годится для воспроизведения: нет видео ${_лПотериВидео}, нет звука ${_лПотериЗвука}`),!1;0!==h&&м_Журнал.Ой(`Количество видеосемплов с увеличенным ВД: ${h}`);var M=q.ПолучитьКоличествоСемплов();if(_чСредняяДлительностьВидеоСемпла=(o-q.чВДНачала)/(M-1),B=Number.isFinite(_чМинДлительностьВидеоСемпла)?_чМинДлительностьВидеоСемпла:360,_мбВидеоСемплы.ЗаписатьБЦ32(q.уКонецСемплов+-16,B),м_Журнал.Вот(`ТранспортныхПакетов=${t.length/188}`+` ВДПервогоВидеоСемпла=${q.чВДНачала}`+` ВДПоследнегоВидеоСемпла=${o}`+` ВДПервогоАудиоСемпла=${U.чВДНачала}`+` ВидеоСемплов=${M}`+` ДлительностьВидеоСегмента>${((o-q.чВДНачала)/90).toFixed(2)}мс`+` СредняяДлительностьВидеоСемпла=${(_чСредняяДлительностьВидеоСемпла/90).toFixed(2)}мс(${(9e4/_чСредняяДлительностьВидеоСемпла).toFixed(2)}к/с)`+` МаксДлительностьВидеоСемпла=${(_чМаксДлительностьВидеоСемпла/90).toFixed(2)}мс(${(9e4/_чМаксДлительностьВидеоСемпла).toFixed(2)}к/с)`+` МинДлительностьВидеоСемпла=${(_чМинДлительностьВидеоСемпла/90).toFixed(2)}мс(${(9e4/_чМинДлительностьВидеоСемпла).toFixed(2)}к/с)`+` Метаданные=${u}`),!_лРазрыв){var E=U.чВДНачала-_чВДКонцаАудиоСегмента;Math.abs(E)>2&&м_Журнал.Ой(`Отклонение ВД аудиосегмента ${E}`),E>9e3&&(_лПотериЗвука=!0),Проверить(E>-9e4*_оИсходныйСегмент.чДлительность*2)}return _лРазрыв||V.Пусто()||(B=q.чВДНачала-_чВДПоследнегоВидеоСемпла,м_Журнал.Вот(`Длительность последнего задержанного видеосемпла ${(B/90).toFixed(2)}мс`),Проверить(B>0),_мбВидеоСемплы.ЗаписатьБЦ32(V.уКонецСемплов+-16,B),_чСредняяДлительностьВидеоСемпла=(o-_чВДПоследнегоВидеоСемпла)/M,_чМинДлительностьВидеоСемпла=Math.min(_чМинДлительностьВидеоСемпла,B),_чМаксДлительностьВидеоСемпла=Math.max(_чМаксДлительностьВидеоСемпла,B)),_чВДПоследнегоВидеоСемпла=o,_чПозицияКодирования=Math.min(q.чВДНачала,U.чВДНачала)/9e4,!0}(i)&&(_лРазрыв&&(_оПараметры=Object.create(null)),function(){if(!L.Пусто())for(var t,e=new ID3(_мбМетаданные,L.уНачалоПотока,L.уКонецПотока);t=e.ПолучитьСледующееПоле();)if("TDEN"===t){var i=e.ПолучитьПервоеТекстовоеЗначение();Проверить(null!==i),_чВремяКодирования=Date.parse(19===i.length?i+"Z":i),Проверить(!Number.isNaN(_чВремяКодирования));break}}(),e=function(){Проверить(q.уКонецПотока!==q.уНачалоПотока),Проверить(q.уКонецСемплов!==q.уНачалоСемплов),_уПотокПоследнегоКлючКадра=_уСемплПоследнегоКлючКадра=-1,_уСемплПоследнегоКадра=q.уНачалоСемплов-16;var t,e=V.уКонецПотока,i=0,n=0,r=0,a=0,_=-1,s=-1,o=_мбВидеоПоток.НайтиПрефикс(q.уНачалоПотока,q.уКонецПотока);for(Проверить(-1!==o),Браковать(-2!==o),Проверить(o===q.уНачалоПотока);;){const h=o===q.уКонецПотока?0:_мбВидеоПоток[o]|_мбВидеоПоток[o+1]<<8;Проверить(3!==h||-1!==s);const c=o+h-Math.min(4,h)>=s;if(c&&-1!==s&&(-1===t&&(t=65536,++r),Проверить(e>_уПотокПоследнегоКадра),_мбВидеоСемплы.ЗаписатьБЦ32(_уСемплПоследнегоКадра+4,e-_уПотокПоследнегоКадра),_мбВидеоСемплы.ЗаписатьБЦ32(_уСемплПоследнегоКадра+8,t)),o===q.уКонецПотока){Проверить(_уСемплПоследнегоКадра+16===q.уКонецСемплов);break}const d=o+h;if(o=_мбВидеоПоток.НайтиПрефикс(d,q.уКонецПотока),Проверить(-1!==o),Браковать(-2!==o),c&&(Проверить((_уСемплПоследнегоКадра+=16)<q.уКонецСемплов),s=_уСемплПоследнегоКадра+16===q.уКонецСемплов?q.уКонецПотока:_мбВидеоСемплы.ПрочестьБЦ32(_уСемплПоследнегоКадра+16+4),_уПотокПоследнегоКадра=e,t=-1,1===a&&(a=0)),d===o)continue;++i;const f=224&_мбВидеоПоток[d];switch(Браковать(f<128),31&_мбВидеоПоток[d]){case 1:case 2:case 3:case 4:Проверить(0!==t),t=65536;break;case 5:Проверить(0!==f),0!==t&&(Проверить(65536!==t),t=0,_уПотокПоследнегоКлючКадра=_уПотокПоследнегоКадра,_уСемплПоследнегоКлючКадра=_уСемплПоследнегоКадра,-1===_&&(_=_уСемплПоследнегоКадра),++n);break;case 6:Проверить(0===f);break;case 7:Проверить(0!==f),!_лРазрыв||-1!==_уСемплПоследнегоКлючКадра&&void 0!==_оПараметры.abSequenceParameterSet||(_оПараметры.abSequenceParameterSet=_мбВидеоПоток.slice(d,o));continue;case 8:Проверить(0!==f),!_лРазрыв||-1!==_уСемплПоследнегоКлючКадра&&void 0!==_оПараметры.abPictureParameterSet||(_оПараметры.abPictureParameterSet=_мбВидеоПоток.slice(d,o));continue;case 9:Проверить(0===f),++a;continue;case 10:Проверить(0===f);continue;case 11:Проверить(0===f),Проверить(!1);continue;case 12:Проверить(0===f);continue;case 13:Проверить(0!==f),!_лРазрыв||-1!==_уСемплПоследнегоКлючКадра&&void 0!==_оПараметры.abSequenceParameterSetExt||(_оПараметры.abSequenceParameterSetExt=_мбВидеоПоток.slice(d,o)),Проверить(!1);continue}var u=o-d;_мбВидеоПоток.ЗаписатьБЦ32(e,u),e+=4,_мбВидеоПоток.copyWithin(e,d,o),e+=u}if(м_Журнал.Вот("NalUnits="+i+" КоличествоКлючКадров="+n+" ПервыйКлючКадр="+(_-q.уНачалоСемплов)/16+" ПоследнийКлючКадр="+(_уСемплПоследнегоКлючКадра-q.уНачалоСемплов)/16),0!==r&&м_Журнал.Ой(`Видеосемплов без VCL NAL unit: ${r}`),a>1&&м_Журнал.Ой("Несколько access unit в одном видеосемпле"),q.уНачалоПотока=V.уКонецПотока,q.уКонецПотока=e,_лРазрыв){if(-1===_уСемплПоследнегоКлючКадра||void 0===_оПараметры.abSequenceParameterSet||void 0===_оПараметры.abPictureParameterSet)return м_Журнал.Ой(`Сегмент не годится для воспроизведения: не найден IDR ${-1===_уСемплПоследнегоКлючКадра}, не найден SPS ${void 0===_оПараметры.abSequenceParameterSet}, не найден PPS ${void 0===_оПараметры.abPictureParameterSet}`),!1;var h=_оПараметры.abSequenceParameterSet.slice(),c=I(h,0,h.length);$(h,c.уНачалоRBSP,c.уКонецRBSP)}return!0}()&&function(){Проверить(U.уКонецПотока!==U.уНачалоПотока),Проверить(U.уКонецСемплов===U.уНачалоСемплов),_лРазрыв&&(Проверить(U.ПолучитьРазмерПотока()>7),A(_мбАудиоПоток.ПрочестьБЦ32(U.уНачалоПотока)));for(var t=U.уНачалоПотока,e=U.уНачалоПотока,i=U.уНачалоСемплов,n=U.уКонецПотока-7;t<n;){Проверить(255===_мбАудиоПоток[t]&&241===_мбАудиоПоток[t+1]),Проверить(0==(3&_мбАудиоПоток[t+6]));var r=_мбАудиоПоток.ПрочестьБЦ32(t+3)>>13&8191,a=t+r;Проверить(r>7&&a<=U.уКонецПотока),_мбАудиоПоток.copyWithin(e,t+7,a),e+=r-=7,_мбАудиоСемплы.ЗаписатьБЦ32(i,r),i+=4,t=a}Проверить(t===U.уКонецПотока),U.уКонецПотока=e,U.уКонецСемплов=i;var _=U.ПолучитьКоличествоСемплов(),s=1024/_оПараметры.чЧастотаДискретизации,o=_*s;return _чВДКонцаАудиоСегмента=U.чВДНачала+Math.round(9e4*o),_чБитрейтЗвука=8*U.ПолучитьРазмерПотока()/1e3/o,м_Журнал.Вот(`АудиоСемплов=${_}`+` ВДКонцаАудиоСегмента=${_чВДКонцаАудиоСегмента}`+` ДлительностьАудиоСемпла=${(1e3*s).toFixed(2)}мс`+` ДлительностьАудиоСегмента=${(1e3*o).toFixed(2)}мс`+` СмещениеНачалаАудиоСегмента=${((U.чВДНачала-q.чВДНачала)/90).toFixed(2)}мс`+` ПредполагаемоеСмещениеКонцаАудиоСегмента=${((_чВДКонцаАудиоСегмента-_чВДПоследнегоВидеоСемпла-_чСредняяДлительностьВидеоСемпла)/90).toFixed(2)}мс`),!0}())}catch(t){if(!(t instanceof Error&&"БРАКОВАТЬ"===t.message))throw t;м_Журнал.Ой(`Сегмент забракован: ${t.stack}`),P(),_лЗабраковано=!0}м_Балкон.Положить(i)}e?(!function(){if(_оИсходныйСегмент.чОбработка)var t=_уПотокПоследнегоКлючКадра,e=_уСемплПоследнегоКлючКадра;else t=_уПотокПоследнегоКадра,e=_уСемплПоследнегоКадра;if(e!==_уСемплПоследнегоКлючКадра){var i=Math.min(17,q.ПолучитьКоличествоСемплов());if(i>1)for(var n=e,r=t,a=0,_=_мбВидеоСемплы.ПрочестьЗЦ32(n+12);0!=--i;){n-=16,r-=_мбВидеоСемплы.ПрочестьБЦ32(n+4);var s=(a-=_мбВидеоСемплы.ПрочестьБЦ32(n+0))+_мбВидеоСемплы.ПрочестьЗЦ32(n+12);s>_&&(_=s,e=n,t=r)}}if(_лРазрыв)if(Проверить(-1!==e),e===q.уНачалоСемплов)F(_лЗадержанРазрыв,_оЗадержанныеПараметры,V,T,!1,!0),w(_лРазрыв,_оПараметры,q,U),F(!1,null,null,null,!0,!1);else if(e===q.уКонецСемплов)F(_лЗадержанРазрыв,_оЗадержанныеПараметры,V,T,!1,!1),F(_лРазрыв,_оПараметры,q,U,!0,!0);else{F(_лЗадержанРазрыв,_оЗадержанныеПараметры,V,T,!1,!1);var o=B(t,e);F(_лРазрыв,_оПараметры,o[0],o[2],!0,!0),w(!1,_оПараметры,o[1],o[3])}else-1===e?(M(q,U),F(!1,null,null,null,!0,!1),м_Журнал.Окак("Ключевой кадр не найден, сегмент задержан")):e===q.уНачалоСемплов?(F(_лЗадержанРазрыв,_оЗадержанныеПараметры,V,T,!0,!0),w(_лРазрыв,_оПараметры,q,U)):e===q.уКонецСемплов?(Проверить(V.Пусто()&&T.Пусто()),F(_лРазрыв,_оПараметры,q,U,!0,!0)):(o=B(t,e),M(o[0],o[2]),F(_лЗадержанРазрыв,_оЗадержанныеПараметры,V,T,!0,!0),w(_лРазрыв,_оПараметры,o[1],o[3]))}(),_лРазрыв=!1):(F(_лЗадержанРазрыв,_оЗадержанныеПараметры,V,T,!1,!0),V.Свернуть(),T.Свернуть(),"number"!=typeof _оИсходныйСегмент.пДанные?F(!1,null,null,null,!0,!1):(b(),postMessage([1,_оИсходныйСегмент])),_лРазрыв=!0),м_Балкон.Освободить(),_чПреобразованЗа=performance.now()-t},k=function(){};i.Проверить=function(t){if(!t)throw new Error("Проверка не пройдена")},i.Браковать=function(t){if(!t)throw new Error("БРАКОВАТЬ")},i.ЗавершитьРаботуИПоказатьСообщение=function(t){throw void postMessage([4,t])},i.ЗавершитьРаботуИОтправитьОтчет=function(t,e){"object"==typeof e&&null!==e&&e.byteLength?postMessage([3,t,e],[e]):postMessage([3,t,null])},i.ВыброситьВПомойку=function(t){ВЕРСИЯ_ДВИЖКА_БРАУЗЕРА>=64||t&&t.buffer.byteLength&&postMessage([5,t.buffer],[t.buffer])},i.ОкруглитьРазмерКучиAsmJS=function(t){return t<=65536?65536:t>=1<<24?(t+16777215&4278190080)>>>0:1<<32-Math.clz32(t-1)},i.AsmJS=function(t,e,i){"use asm";var n=new t.Uint8Array(i);function r(t,e){t=t|0;e=e|0;var i=0,r=0,a=0;if((t|0)<0|(t|0)>(e|0)){return-1|0}i=e-3|0;for(;;){if((t|0)>(i|0)){return e|0}r=n[t>>0]|0;t=t+1|0;if((r|0)==0){r=n[t>>0]|0;t=t+1|0;if((r|0)==0){r=n[t>>0]|0;t=t+1|0;if((r|0)<=1){break}}}}a=t-3|0;t=t-1|0;do{r=n[t>>0]|0;t=t+1|0;if((r|0)==1){t=t-a|0;if((t|0)>0xffff){return-1|0}n[a>>0]=t;n[a+1>>0]=t>>8;return a|0}if((r|0)!=0){return-2|0}}while((t|0)<(e|0));return e|0}return{SearchStartCodePrefix:r}},a["ПропуститьБиты"]=function(t){if(Проверить(Number.isInteger(t)),Проверить((this.кБитОсталось-=t)>=0),1===t)--this._чСледующийБит<0&&(this._чСледующийБит=7,++this._уСледующийБайт);else{var e=this._чСледующийБит-t;e>=0?this._чСледующийБит=e:(e=-e-1,this._чСледующийБит=7-(7&e),this._уСледующийБайт+=1+(e>>>3))}},a["ПрочестьБиты"]=function(t){if(Проверить(Number.isInteger(t)),Проверить((this.кБитОсталось-=t)>=0),1===t)e=this._мбБуфер[this._уСледующийБайт]>>>this._чСледующийБит&1,--this._чСледующийБит<0&&(this._чСледующийБит=7,++this._уСледующийБайт);else{Проверить(t>=1&&t<=32);var e=0,i=t-1,n=(1<<this._чСледующийБит+1)-1;do{var r=this._мбБуфер[this._уСледующийБайт]&n;e|=this._чСледующийБит<i?r<<i-this._чСледующийБит:r>>>this._чСледующийБит-i;var a=Math.min(i,this._чСледующийБит)+1;(this._чСледующийБит-=a)<0&&(this._чСледующийБит=7,++this._уСледующийБайт,n=255)}while((i-=a)>=0)}return e>>>0},a["ПрочестьБеззнаковыйЭКГ"]=function(){for(var t=0;0===this.ПрочестьБиты(1);++t);return Проверить(t<=31),0===t?0:(1<<t>>>0)-1+this.ПрочестьБиты(t)},a["ПрочестьЗнаковыйЭКГ"]=function(){var t=this.ПрочестьБеззнаковыйЭКГ();return 0!=(1&t)?Math.ceil(t/2):-t/2},a["ПропуститьЭКГ"]=function(){for(var t=0;0===this.ПрочестьБиты(1);++t);0!==t&&this.ПропуститьБиты(t)},i.ПотокБитов=r,s["Завершить"]=function(){return Проверить(Number.isInteger(this.уКонец)&&this.уКонец>=this.уНачало&&this.уКонец<=this.мбБуфер.length),this.мбБуфер.subarray(this.уНачало,this.уКонец)},s.AddBox=function(t,e){return this.AddFullBox(t,-1,-1,e)},s.AddFullBox=function(t,e,i,n){Проверить(4===t.length&&Number.isFinite(e)&&Number.isFinite(i)),Проверить(this.уКонец>=this.уНачало);var r=this.уКонец;if(Проверить(this.мбБуфер.length-this.уКонец>=8),this.мбБуфер[r+4]=t.charCodeAt(0),this.мбБуфер[r+5]=t.charCodeAt(1),this.мбБуфер[r+6]=t.charCodeAt(2),this.мбБуфер[r+7]=t.charCodeAt(3),this.уКонец+=8,-1!==e&&(Проверить(e>=0&&e<=255&&i>=0&&i<=16777215),Проверить(this.мбБуфер.length-this.уКонец>=4),this.мбБуфер.ЗаписатьБЦ32(r+8,e<<24|i),this.уКонец+=4),"number"==typeof n)Проверить(Number.isInteger(n)&&n>=0),this.уКонец+=n,Проверить(this.уКонец<=this.мбБуфер.length);else if("function"==typeof n){var a=this.уКонец;n(),Проверить(Number.isInteger(this.уКонец)&&this.уКонец>=a&&this.уКонец<=this.мбБуфер.length)}else this.Копировать(this.уКонец,n);this.мбБуфер.ЗаписатьБЦ32(r,this.уКонец-r)},s["Копировать"]=function(t,e,i,n){Проверить(Number.isInteger(t)&&t>=this.уКонец),2===arguments.length?(this.мбБуфер.set(e,t),this.уКонец=t+e.length):(Проверить(Number.isInteger(i)&&Number.isInteger(n)),this.мбБуфер.Копировать(t,e,i,n),this.уКонец=t+n-i)},i.IsoBaseMedia=_,o._oUtf8Decoder=null,u["ПолучитьСледующееПоле"]=function(){if(this._кбТег>10){var t=this._мб[this._уТег],e=this._мб[this._уТег+1],i=this._мб[this._уТег+2],n=this._мб[this._уТег+3];if(t>=48&&t<=57||t>=65&&t<=90&&e>=48&&e<=57||e>=65&&e<=90&&i>=48&&i<=57||i>=65&&i<=90&&n>=48&&n<=57||n>=65&&n<=90){var r=this._ParseSynchsafeInteger(this._уТег+4);if(r>=1&&r<=this._кбТег-10&&0===this._мб[this._уТег+9])return this._уПоле=this._уТег+10,this._кбПоле=r,this._уТег+=10+r,this._кбТег-=10+r,String.fromCharCode(t,e,i,n)}}return this._уПоле=-1,this._кбПоле=-1,null},u["ПолучитьПервоеТекстовоеЗначение"]=function(){if(this._кбПоле<2||3!==this._мб[this._уПоле])return null;null===ID3._oUtf8Decoder&&(ID3._oUtf8Decoder=new TextDecoder("utf-8",{fatal:!0}));try{var t=ID3._oUtf8Decoder.decode(new Uint8Array(this._мб.buffer,this._уПоле+1,this._кбПоле-1))}catch(t){return null}var e=t.indexOf("\0");return-1===e?null:t.slice(0,e)},u._ParseSynchsafeInteger=function(t){var e=-1,i=this._мб[t];if(i<128){var n=i<<21;(i=this._мб[t+1])<128&&(n|=i<<14,(i=this._мб[t+2])<128&&(n|=i<<7,(i=this._мб[t+3])<128&&(e=n|i)))}return e},i.ID3=o,c["Пусто"]=function(){return Проверить(Number.isInteger(this.уНачалоПотока)&&Number.isInteger(this.уКонецПотока)&&this.уНачалоПотока>=0&&this.уНачалоПотока<=this.уКонецПотока),this.уКонецПотока===this.уНачалоПотока},c["ПолучитьРазмерПотока"]=function(){return Проверить(Number.isInteger(this.уНачалоПотока)&&Number.isInteger(this.уКонецПотока)&&this.уНачалоПотока>=0&&this.уНачалоПотока<=this.уКонецПотока),this.уКонецПотока-this.уНачалоПотока},c["ПолучитьРазмерСемплов"]=function(){return Проверить(Number.isInteger(this.уНачалоСемплов)&&Number.isInteger(this.уКонецСемплов)&&this.уНачалоСемплов>=0&&this.уНачалоСемплов<=this.уКонецСемплов),Проверить((this.уКонецСемплов-this.уНачалоСемплов)%this.кбСтруктураСемпла==0),this.уКонецСемплов-this.уНачалоСемплов},c["ПолучитьКоличествоСемплов"]=function(){return this.ПолучитьРазмерСемплов()/this.кбСтруктураСемпла},c["СложитьБеззнаковыйПараметр"]=function(t,e,i){Проверить(Number.isInteger(t)&&t>=0&&t<=this.кбСтруктураСемпла-4),Проверить(Number.isInteger(this.уНачалоСемплов)&&Number.isInteger(this.уКонецСемплов)&&this.уНачалоСемплов>=0&&this.уНачалоСемплов<=this.уКонецСемплов),Проверить(Number.isInteger(e)&&e>=this.уНачалоСемплов&&e<=this.уКонецСемплов),Проверить((this.уКонецСемплов-this.уНачалоСемплов)%this.кбСтруктураСемпла==0&&(e-this.уНачалоСемплов)%this.кбСтруктураСемпла==0);for(var n=0,r=this.уНачалоСемплов;r!==e;r+=this.кбСтруктураСемпла)n+=i.ПрочестьБЦ32(r+t);return n},c["Свернуть"]=function(){Проверить(Number.isInteger(this.уНачалоПотока)&&this.уНачалоПотока>=0),Проверить(Number.isInteger(this.уНачалоСемплов)&&this.уНачалоСемплов>=0),this.уКонецПотока=this.уНачалоПотока,this.уКонецСемплов=this.уНачалоСемплов,this.чВДНачала=-1},i.Срез=h;var C=(k.prototype=c,new k);C.constructor=d,d.prototype=C,i.СрезОбработки=d;var D=n;D["Копировать"]=function(t,e,i,n){this.set(new Uint8Array(e.buffer,i,Math.floor(n)-Math.floor(i)),t)},D["ПрочестьБЦ64"]=function(t){return 4294967296*((this[t|=0]<<24|this[t+1|0]<<16|this[t+2|0]<<8|this[t+3|0])>>>0)+((this[t+4|0]<<24|this[t+5|0]<<16|this[t+6|0]<<8|this[t+7|0])>>>0)},D["ПрочестьЗЦ32"]=function(t){return this[t|=0]<<24|this[t+1|0]<<16|this[t+2|0]<<8|this[t+3|0]},D["ПрочестьБЦ32"]=function(t){return(this[t|=0]<<24|this[t+1|0]<<16|this[t+2|0]<<8|this[t+3|0])>>>0},D["ПрочестьЗЦ16"]=function(t){return this[t|=0]<<24>>16|this[t+1|0]},D["ПрочестьБЦ16"]=function(t){return this[t|=0]<<8|this[t+1|0]},D["ЗаписатьБЦ64"]=f,D["ЗаписатьЗЦ64"]=f,D["ЗаписатьБЦ32"]=l,D["ЗаписатьЗЦ32"]=l,D["ЗаписатьБЦ16"]=m,D["ЗаписатьЗЦ16"]=m,i._оИсходныйСегмент=null,i._мбВидеоПоток=null,i._мбАудиоПоток=null,i._мбМетаданные=null,i._мбВидеоСемплы=null,i._мбАудиоСемплы=null,i._лРазрыв=!0,i._оПараметры=null,i._лЗадержанРазрыв=!1,i._оЗадержанныеПараметры=null,i._чПреобразованЗа=NaN;var V=(k.prototype=c,new k);V["кбСтруктураСемпла"]=16,V["уНачалоПотока"]=0,V["уКонецПотока"]=0,V["уНачалоСемплов"]=0,V["уКонецСемплов"]=0,V["чВДНачала"]=-1;var T=(k.prototype=c,new k);T["кбСтруктураСемпла"]=4,T["уНачалоПотока"]=0,T["уКонецПотока"]=0,T["уНачалоСемплов"]=0,T["уКонецСемплов"]=0,T["чВДНачала"]=-1;var R=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],q=(k.prototype=C,new k);q["кбСтруктураСемпла"]=16,q["уНачалоПотока"]=0,q["уКонецПотока"]=0,q["уНачалоСемплов"]=0,q["уКонецСемплов"]=0,q["чВДНачала"]=-1,q.nContinuityCounter=-1,q.pPesPacketEnd=-1;var U=(k.prototype=C,new k);U["кбСтруктураСемпла"]=4,U["уНачалоПотока"]=0,U["уКонецПотока"]=0,U["уНачалоСемплов"]=0,U["уКонецСемплов"]=0,U["чВДНачала"]=-1,U.nContinuityCounter=-1,U.pPesPacketEnd=-1;var L=(k.prototype=C,new k);L["кбСтруктураСемпла"]=0,L["уНачалоПотока"]=0,L["уКонецПотока"]=0,L["уНачалоСемплов"]=0,L["уКонецСемплов"]=0,L["чВДНачала"]=0,L.nContinuityCounter=-1,L.pPesPacketEnd=-1;var j=(k.prototype=c,new k);j["кбСтруктураСемпла"]=4,j["уНачалоПотока"]=0,j["уКонецПотока"]=0,j["уНачалоСемплов"]=0,j["уКонецСемплов"]=0,j["чВДНачала"]=-1,i.onmessage=function(t){const e="object"!=typeof t.data||null===t.data?typeof t.data:t.data.сВерсия;if(e!==ВЕРСИЯ_РАСШИРЕНИЯ)throw new Error(`Версия ${e} !== ${ВЕРСИЯ_РАСШИРЕНИЯ}`);try{_оИсходныйСегмент=t.data,E()}catch(e){self.onmessage=null,b(),м_Журнал.Отправить(),ЗавершитьРаботуИОтправитьОтчет(e instanceof Error?`Поймано исключение в рабочем потоке: ${e.stack}`:`Поймано исключение в рабочем потоке: [typeof ${typeof e}] ${new Error(e).stack}`,t.data.пДанные)}finally{_оИсходныйСегмент=null}},ВЕРСИЯ_ДВИЖКА_БРАУЗЕРА=70,ВЕРСИЯ_РАСШИРЕНИЯ="2018.5.18";var O=[],W=[];м_Журнал={"Вот":function(t){v("Вот",t)},"Окак":function(t){v("Окак",t)},"Ой":function(t){v("Ой",t)},"Отправить":function(){0!==O.length&&(postMessage([2,O,W]),O.length=0,W.length=0)}},м_Балкон={"Положить":function(i){var n=t[0]||e(0);Проверить(!n[0]),n[0]=i},"Найти":function(i){var n=t[0]||e(0),r=null;return n[0]&&(n[0].length>=i?(м_Журнал.Вот(`Найдено барахло на ${n[0].length-i} больше запрашиваемого ${i}`),r=n[0],n[0]=null):м_Журнал.Окак(`Найдено барахло на ${i-n[0].length} меньше запрашиваемого ${i}`)),r},"Освободить":function(){var i=t[0]||e(0);i[0]&&(ВыброситьВПомойку(i[0]),i[0]=null)}}}).call(this);